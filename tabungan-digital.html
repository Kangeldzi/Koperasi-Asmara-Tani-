<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Tabungan Digital - Koperasi Asmara Tani</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- AR.js Library -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js"></script>
    <style>
        :root {
            --primary: #1a5f23;
            --primary-light: #2e7d32;
            --primary-dark: #0d4014;
            --secondary: #ff9800;
            --accent-blue: #2196f3;
            --accent-purple: #9c27b0;
            --danger: #f44336;
            --warning: #ffc107;
            --success: #4caf50;
            --info: #2196f3;
            
            --bg-light: #f5f6fa;
            --card-bg: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #888888;
            --border-color: #eeeeee;
            
            --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 15px 35px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fff8 0%, #f0f7f0 50%, #e8f5e9 100%);
            color: var(--text-primary);
            padding: 20px;
            padding-bottom: 30px;
            min-height: 100vh;
        }

        .back-home {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--primary);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-home:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* ===== SYNC CONTROLS DENGAN TOGGLE EYE ===== */
        .sync-controls-toggle {
            position: fixed;
            top: 15px;
            right: 90px;
            background: rgba(26, 95, 35, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.4);
            color: #1a5f23;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .sync-controls-toggle:hover {
            background: rgba(26, 95, 35, 0.3);
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .sync-controls-toggle.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.6);
            color: #1a5f23;
        }

        .sync-controls {
            position: fixed;
            top: 65px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(26, 95, 35, 0.1);
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sync-controls.hidden {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
        }

        .sync-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .online-indicator {
            background: #2196f3;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        /* Sync Button Styles */
        .sync-button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            transition: all 0.3s ease;
        }
        
        .sync-button:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .sync-button.syncing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }
        
        .sync-button.success {
            background: var(--success);
        }
        
        .sync-button.error {
            background: var(--danger);
        }

        /* ===== NOTIFICATION TOGGLE ===== */
        .notification-toggle {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: var(--accent-purple);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 8px 25px rgba(156, 39, 176, 0.4);
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .notification-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(156, 39, 176, 0.6);
        }

        .notification-toggle.has-notifications {
            animation: bellRing 1s ease;
        }

        @keyframes bellRing {
            0%, 100% { transform: rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
            20%, 40%, 60%, 80% { transform: rotate(10deg); }
        }

        .notification-panel {
            position: fixed;
            bottom: 230px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 9998;
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(26, 95, 35, 0.1);
            overflow: hidden;
        }

        .notification-panel.active {
            transform: translateX(0);
        }

        .notification-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .notification-body {
            max-height: 350px;
            overflow-y: auto;
            padding: 15px;
        }

        .notification-item {
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: #e8f5e9;
            transform: translateX(-3px);
        }

        .notification-item.unread {
            background: #fff8e1;
            border-left-color: var(--warning);
        }

        .notification-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .notification-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Profile Container */
        .profile-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 40px auto 20px;
            max-width: 600px;
            box-shadow: var(--shadow-medium);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--primary-light);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .username {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .last-sync-time {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .btn-area {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn.qr {
            background: var(--accent-blue);
            color: white;
        }

        .btn.pro {
            background: var(--primary);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Plan Card */
        .plan-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .plan-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .plan-icon {
            width: 50px;
            height: 50px;
            background: #f0f7f0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .plan-text h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .real-time-status {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* ===== HOLOGRAM STATIC CARD ===== */
        .hologram-static-card {
            background: linear-gradient(135deg, 
                rgba(26, 95, 35, 0.12) 0%,
                rgba(46, 125, 50, 0.08) 25%,
                rgba(76, 175, 80, 0.05) 50%,
                rgba(129, 199, 132, 0.03) 75%,
                rgba(200, 230, 201, 0.01) 100%
            );
            border: 2px solid rgba(26, 95, 35, 0.25);
            border-radius: 20px;
            padding: 25px;
            margin: 20px auto;
            max-width: 600px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(8px);
            box-shadow: 
                0 10px 35px rgba(26, 95, 35, 0.15),
                0 0 0 1px rgba(46, 125, 50, 0.1) inset,
                0 0 50px rgba(76, 175, 80, 0.08) inset;
            animation: hologramGlowStatic 6s ease-in-out infinite alternate;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hologram-static-card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 15px 45px rgba(26, 95, 35, 0.25),
                0 0 0 2px rgba(46, 125, 50, 0.15) inset,
                0 0 70px rgba(76, 175, 80, 0.12) inset;
            border-color: rgba(26, 95, 35, 0.4);
        }

        .voice-control-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(26, 95, 35, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.4);
            color: #1a5f23;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .voice-control-btn:hover {
            background: rgba(26, 95, 35, 0.3);
            transform: scale(1.1);
        }

        .voice-control-btn.speaking {
            background: rgba(156, 39, 176, 0.3);
            border-color: rgba(156, 39, 176, 0.4);
            animation: pulse 1s infinite;
        }

        .hologram-static-content {
            position: relative;
            z-index: 2;
        }

        .hologram-static-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(26, 95, 35, 0.2);
        }

        .hologram-static-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0d4014;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .hologram-static-subtitle {
            color: rgba(13, 64, 20, 0.8);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .hologram-static-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .hologram-static-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .hologram-static-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(26, 95, 35, 0.1);
            background: #f0f7f0;
        }

        .hologram-static-icon {
           width: 40px;
           height: 40px;
           border-radius: 50%;
           background: rgba(26, 95, 35, 0.1);
           display: flex;
           align-items: center;
           justify-content: center;
           margin-bottom: 10px;
           font-size: 1.1rem;
           color: #1a5f23;
         }

        .hologram-static-value {
           font-size: 1.3rem;
           font-weight: 700;
           color: #1a5f23;
           margin-bottom: 5px;
           min-height: 28px;
           display: flex;
           align-items: center;
           justify-content: center;
         }

        .hologram-static-label {
           font-size: 0.8rem;
           color: rgba(13, 64, 20, 0.7);
           font-weight: 600;
           text-transform: uppercase;
           letter-spacing: 0.5px;
         }

        .hologram-static-footer {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(26, 95, 35, 0.2);
            color: rgba(13, 64, 20, 0.7);
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hologram-static-update {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
        }

        .hologram-static-click {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #1a5f23;
            font-weight: 500;
            font-size: 0.75rem;
        }

        @keyframes hologramGlowStatic {
            0% {
                box-shadow: 
                    0 10px 35px rgba(26, 95, 35, 0.15),
                    0 0 0 1px rgba(46, 125, 50, 0.1) inset,
                    0 0 50px rgba(76, 175, 80, 0.08) inset;
            }
            100% {
                box-shadow: 
                    0 10px 35px rgba(26, 95, 35, 0.2),
                    0 0 0 1px rgba(46, 125, 50, 0.15) inset,
                    0 0 60px rgba(76, 175, 80, 0.1) inset;
            }
        }

        @keyframes hologramScanStatic {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        /* Menu Section */
        .menu-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: var(--shadow-medium);
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: #f8f9fa;
            border-radius: 10px;
        }

        .menu-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f7f0;
            border-radius: 10px;
        }

        .menu-text {
            font-weight: 500;
        }

        .menu-right {
            color: var(--text-muted);
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-dark);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-body {
            padding: 20px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 95, 35, 0.1);
        }

        .form-control:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: #666;
        }

        .readonly-field {
            background-color: #f8f9fa !important;
            color: #666 !important;
            border: 1px solid #e0e0e0 !important;
            cursor: not-allowed !important;
            opacity: 0.8;
        }

        /* Password field with eye toggle */
        .password-field {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-btn.primary {
            background: var(--primary);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .modal-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .modal-btn:active {
            transform: translateY(0);
        }

        /* QR Modal Design */
        .qr-modal-design {
            padding: 10px;
        }

        .qr-title {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .qr-card {
            background: linear-gradient(135deg, #1a5f23 0%, #2e7d32 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: var(--shadow-medium);
        }

        .qr-person-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .qr-person-photo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid white;
        }

        .qr-person-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .qr-person-details h4 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .qr-person-details p {
            font-size: 0.85rem;
            margin-bottom: 2px;
            opacity: 0.9;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .action-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .action-btn.download {
            background: var(--accent-blue);
            color: white;
        }

        .action-btn.pdf {
            background: #f44336;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        /* PERBAIKAN: Style untuk Modal Hologram Detail */
        .hologram-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hologram-modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .hologram-modal-content {
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.98) 0%,
                rgba(245, 248, 246, 0.99) 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            position: relative;
            transform: translateY(30px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(76, 175, 80, 0.3);
            box-shadow: 
                0 25px 60px rgba(0, 0, 0, 0.35),
                0 0 0 1px rgba(76, 175, 80, 0.2),
                0 0 120px rgba(76, 175, 80, 0.1);
            overflow: hidden;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .hologram-modal-overlay.active .hologram-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .hologram-modal-header {
            background: linear-gradient(135deg, 
                rgba(26, 95, 35, 0.95) 0%,
                rgba(46, 125, 50, 0.9) 100%);
            padding: 25px 30px;
            color: white;
            position: relative;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .hologram-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hologram-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.8rem;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            font-weight: bold;
        }

        .hologram-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg) scale(1.1);
        }

        .hologram-modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        /* PERBAIKAN: Style untuk konten kartu hologram */
        .hologram-card {
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.95) 0%,
                rgba(245, 248, 246, 0.97) 100%);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(26, 95, 35, 0.15);
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .hologram-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(26, 95, 35, 0.2);
        }

        .hologram-header h3 {
            color: #0d4014;
            font-size: 1.4rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .hologram-header p {
            color: rgba(13, 64, 20, 0.7);
            font-size: 0.9rem;
        }

        .hologram-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .hologram-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(26, 95, 35, 0.1);
            transition: all 0.3s ease;
        }

        .hologram-item:hover {
            background: #f0f7f0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 95, 35, 0.1);
        }

        .hologram-item.full-width {
            grid-column: 1 / -1;
        }

        .hologram-label {
            font-size: 0.85rem;
            color: rgba(13, 64, 20, 0.7);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hologram-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a5f23;
            margin-bottom: 5px;
        }

        .hologram-value.rp {
            font-size: 1.3rem;
        }

        .hologram-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .status-aktif {
            background: rgba(46, 125, 50, 0.15);
            color: #2e7d32;
        }

        .status-tidak-aktif {
            background: rgba(244, 67, 54, 0.15);
            color: #f44336;
        }

        .hologram-footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid rgba(26, 95, 35, 0.2);
            font-size: 0.85rem;
            color: rgba(13, 64, 20, 0.6);
            text-align: center;
        }

        .hologram-footer p {
            margin: 5px 0;
        }

        .hologram-modal-footer {
            padding: 20px 30px;
            background: rgba(245, 248, 246, 0.98);
            border-top: 2px solid rgba(76, 175, 80, 0.15);
            box-shadow: 0 -5px 20px rgba(26, 95, 35, 0.08);
        }

        .hologram-modal-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .hologram-modal-btn {
            padding: 14px 32px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 160px;
            justify-content: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .hologram-modal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .hologram-btn-secondary {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            color: #666;
            border: 2px solid #ddd;
        }

        .hologram-btn-print {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.25);
        }

        /* PERBAIKAN: Style untuk kartu anggota - foto ukuran awal */
        .kartu-info {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }

        .kartu-photo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid white;
            flex-shrink: 0;
        }

        .kartu-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .kartu-details {
            flex: 1;
        }

        .kartu-details h4 {
            font-size: 1.3rem;
            color: white;
            margin-bottom: 10px;
        }

        .kartu-details p {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* PERBAIKAN: Style untuk photo upload di edit profil */
        .photo-upload-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .photo-preview {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .photo-preview img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-light);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Voice Command Button */
        .voice-command-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .voice-command-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(33, 150, 243, 0.6);
        }

        .voice-command-btn.listening {
            background: linear-gradient(135deg, #FF4081, #F50057);
            animation: voicePulse 1s infinite;
        }

        @keyframes voicePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* AR Experience Button */
        .ar-experience-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }

        .ar-experience-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 30px rgba(255, 107, 107, 0.6);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-medium);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.info {
            background: var(--info);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sync-controls-toggle {
                top: 15px;
                right: 80px;
            }

            .sync-controls {
                top: 60px;
                right: 15px;
            }

            .notification-toggle {
                bottom: 150px;
                right: 15px;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .notification-panel {
                width: 280px;
                right: 10px;
                bottom: 200px;
            }

            .modal-content {
                width: 95%;
                max-height: 85vh;
            }

            .hologram-static-card {
                padding: 20px;
                margin: 15px auto;
            }
            
            .hologram-static-grid {
                grid-template-columns: 1fr;
            }

            .voice-command-btn, .ar-experience-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .voice-command-btn {
                bottom: 80px;
            }

            /* Responsive untuk kartu hologram */
            .hologram-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .hologram-item.full-width {
                grid-column: 1;
            }

            .kartu-photo {
                width: 80px;
                height: 80px;
            }

            .photo-preview img {
                width: 100px;
                height: 100px;
            }
        }

        @media (max-width: 576px) {
            .sync-controls-toggle {
                right: 70px;
            }

            .sync-controls {
                flex-direction: column;
                align-items: flex-end;
                gap: 5px;
                top: 55px;
            }

            .hologram-static-card {
                padding: 15px;
                border-radius: 15px;
            }

            .kartu-info {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .kartu-photo {
                width: 90px;
                height: 90px;
            }

            .hologram-modal-btn {
                min-width: 120px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .hologram-modal-actions {
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="back-home" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-left"></i> Beranda
    </button>
    
    <!-- SYNC CONTROLS TOGGLE -->
    <button class="sync-controls-toggle" id="syncControlsToggle" title="Toggle Sync Controls">
        <i class="fas fa-eye"></i>
    </button>
    
    <!-- SYNC CONTROLS -->
    <div class="sync-controls" id="syncControls">
        <div class="sync-badge" id="syncIndicator">
            <i class="fas fa-sync-alt"></i>
            <span>Firebase Sync</span>
        </div>
        
        <div class="online-indicator" id="onlineIndicator">
            <i class="fas fa-wifi"></i>
            <span>Online Firebase</span>
        </div>
        
        <button class="sync-button" id="manualSyncButton" title="Klik untuk sinkronisasi manual">
            <i class="fas fa-sync-alt"></i> Sync Now
        </button>
    </div>

    <!-- NOTIFICATION TOGGLE -->
    <button class="notification-toggle" id="notificationToggle" title="Notifikasi">
        <i class="fas fa-bell"></i>
    </button>

    <!-- NOTIFICATION PANEL -->
    <div class="notification-panel" id="notificationPanel">
        <div class="notification-header">
            <h4>
                <i class="fas fa-bell"></i>
                Notifikasi
                <span class="notification-badge" id="notificationBadge">0</span>
            </h4>
            <button class="notification-clear" id="notificationClear" title="Hapus semua">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
        <div class="notification-body" id="notificationBody">
            <div style="text-align: center; padding: 40px 20px; color: #666;">
                <i class="fas fa-bell-slash" style="font-size: 48px; color: #ccc;"></i>
                <p>Tidak ada notifikasi</p>
                <p style="font-size: 0.9rem;">Notifikasi akan muncul di sini</p>
            </div>
        </div>
    </div>

    <!-- PROFILE HEADER -->
    <div class="profile-container">
        <div class="profile-header">
            <div class="avatar">
                <img id="profileAvatar" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg" alt="Profile">
            </div>
            <div class="user-info">
                <h2 id="profileName">Loading... <span class="badge" id="statusBadge">üîÑ</span></h2>
                <div class="username" id="profileRole">@loading</div>
                <div class="last-sync-time" id="lastSyncTime">Firebase Sync: Memuat...</div>
                <div class="last-sync-time" id="lastAdminUpdate">Update Firebase: -</div>
            </div>
        </div>

        <div class="btn-area">
            <button class="btn qr" id="qrButton">
                <i class="fas fa-qrcode"></i> QR Code Hybrid
            </button>
            <button class="btn pro" id="editProfileButton">
                <i class="fas fa-edit"></i> Edit Profil
            </button>
        </div>
    </div>

    <!-- CARD PLAN -->
    <div class="plan-card">
        <div class="plan-left">
            <div class="plan-icon">
                <i class="fas fa-book-open" style="color: #333;"></i>
            </div>
            <div class="plan-text">
                <h3 id="tabunganTitle">Tabungan Digital Firebase</h3>
                <p id="tabunganStatus" class="real-time-status">Memuat data dari Firebase...</p>
                <p id="syncStatus" style="font-size: 0.8rem; color: #666;">Status Firebase: <span id="syncStatusText">Memeriksa...</span></p>
            </div>
        </div>
    </div>

    <!-- HOLOGRAM STATIC CARD -->
    <div class="hologram-static-card" id="hologramStaticCard">
        <div class="voice-control-btn" id="hologramVoiceBtn" title="Baca data dengan suara">
            <i class="fas fa-volume-up"></i>
        </div>
        
        <div class="hologram-static-content">
            <div class="hologram-static-header">
                <div class="hologram-static-title">
                    <i class="fas fa-id-card"></i>
                    RINGKASAN KEUANGAN FIREBASE
                </div>
                <div class="hologram-static-subtitle">
                    Data Real-time dari Firebase
                </div>
            </div>
            
            <div class="hologram-static-grid" id="hologramStaticGrid">
                <div class="hologram-static-item">
                    <div class="hologram-static-icon">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                    <div class="hologram-static-value" id="hologramTotalSimpanan"></div>
                    <div class="hologram-static-label">Total Simpanan</div>
                </div>
                
                <div class="hologram-static-item">
                    <div class="hologram-static-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="hologram-static-value" id="hologramTotalPinjaman"></div>
                    <div class="hologram-static-label">Total Pinjaman</div>
                </div>
                
                <div class="hologram-static-item">
                    <div class="hologram-static-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="hologram-static-value" id="hologramSHUEstimasi"></div>
                    <div class="hologram-static-label">SHU Estimasi</div>
                </div>
                
                <div class="hologram-static-item">
                    <div class="hologram-static-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="hologram-static-value" id="hologramStatusAnggota"></div>
                    <div class="hologram-static-label">Status Anggota</div>
                </div>
            </div>
            
            <div class="hologram-static-footer">
                <div class="hologram-static-update" id="hologramUpdateTime">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    Menghubungkan ke Firebase...
                </div>
                <div class="hologram-static-click">
                    <i class="fas fa-hand-pointer"></i>
                    Klik kartu untuk detail
                </div>
            </div>
        </div>
    </div>

    <!-- MENU UTAMA -->
    <div class="menu-section" id="mainMenu">
        <div class="menu-item" data-action="setor">
            <div class="menu-left">
                <div class="menu-icon">üì•</div>
                <div class="menu-text">Setor Simpanan</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="pinjam">
            <div class="menu-left">
                <div class="menu-icon">ü´¥üèº</div>
                <div class="menu-text">Ajukan Pinjaman</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="riwayat">
            <div class="menu-left">
                <div class="menu-icon">üìù</div>
                <div class="menu-text">Riwayat Transaksi</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>

        <div class="menu-item" data-action="kartu">
            <div class="menu-left">
                <div class="menu-icon">ü™™</div>
                <div class="menu-text">Kartu Anggota</div>
            </div>
            <div class="menu-right"><i class="fas fa-chevron-right"></i></div>
        </div>
    </div>

    <!-- FOOTER -->
    <div class="footer">
        <p>Copyright ¬© Koperasi Asmara Tani 2026</p>
        <p style="font-size: 0.8rem; margin-top: 5px; color: var(--primary);">
            <i class="fas fa-fire"></i> Firebase Sync System v3.0
        </p>
    </div>

    <!-- VOICE COMMAND BUTTON -->
    <button class="voice-command-btn" id="voiceCommandBtn" title="Voice Commands">
        <i class="fas fa-microphone"></i>
    </button>

    <!-- AR EXPERIENCE BUTTON -->
    <button class="ar-experience-btn" id="arExperienceBtn" title="AR Experience">
        <i class="fas fa-vr-cardboard"></i>
    </button>

    <!-- MODAL CONTAINER -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Modal Title</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- HOLOGRAM MODAL -->
    <div class="hologram-modal-overlay" id="hologramDetailModal">
        <div class="hologram-modal-content">
            <div class="hologram-modal-header">
                <h3><i class="fas fa-file-invoice-dollar"></i> Detail Ringkasan Keuangan</h3>
                <button class="hologram-modal-close" id="closeHologramDetail">&times;</button>
            </div>
            
            <div class="hologram-modal-body" id="hologramDetailContent"></div>
            
            <div class="hologram-modal-footer">
                <div class="hologram-modal-actions">
                    <button class="hologram-modal-btn hologram-btn-secondary" id="closeDetailBtn">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                    <button class="hologram-modal-btn hologram-btn-print" id="printHologramDetailBtn">
                        <i class="fas fa-print"></i> Cetak Kartu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PASSWORD MODAL -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Ganti Password</h3>
                <button class="modal-close" id="closePasswordModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label class="form-label">Password Saat Ini</label>
                        <div class="password-field">
                            <input type="password" class="form-control" id="currentPassword" required>
                            <button type="button" class="password-toggle" id="toggleCurrentPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password Baru</label>
                        <div class="password-field">
                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                            <button type="button" class="password-toggle" id="toggleNewPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Konfirmasi Password Baru</label>
                        <div class="password-field">
                            <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                            <button type="button" class="password-toggle" id="toggleConfirmPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="modal-btn secondary" id="cancelPasswordBtn">Batal</button>
                        <button type="submit" class="modal-btn primary" id="savePasswordBtn">Simpan Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- AR MODAL -->
    <div class="modal-overlay" id="arExperienceModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-vr-cardboard"></i> AR Experience - Kartu Digital 3D</h3>
                <button class="modal-close" id="closeARModal">&times;</button>
            </div>
            <div class="modal-body" id="arExperienceContent"></div>
        </div>
    </div>

    <!-- VOICE COMMAND MODAL -->
    <div class="modal-overlay" id="voiceCommandModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-microphone"></i> Voice Commands</h3>
                <button class="modal-close" id="closeVoiceModal">&times;</button>
            </div>
            <div class="modal-body" id="voiceCommandContent"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toastMessage">Toast message here</span>
    </div>

<script>
// ===== FIREBASE CONFIGURATION =====
// Template untuk firebase-config.js
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID",
    measurementId: "YOUR_MEASUREMENT_ID"
};

// ===== FIREBASE INITIALIZATION =====
let firebaseInitialized = false;
let firebaseInitializationPromise = null;

function initializeFirebase() {
    if (firebaseInitializationPromise) {
        return firebaseInitializationPromise;
    }
    
    firebaseInitializationPromise = new Promise(async (resolve, reject) => {
        console.log('üî• Starting Firebase initialization...');
        
        const timeoutId = setTimeout(() => {
            reject(new Error('Firebase initialization timeout after 15 seconds'));
        }, 15000);
        
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            let configLoaded = false;
            for (let i = 0; i < 30; i++) {
                if (typeof firebaseConfig !== 'undefined') {
                    configLoaded = true;
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (!configLoaded) {
                throw new Error('Firebase configuration not loaded');
            }
            
            let firebaseApp;
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.apps[0];
            }
            
            const firestoreDB = firebase.firestore();
            const auth = firebase.auth();
            
            const testTimeout = setTimeout(() => {
                throw new Error('Firestore connection test timeout');
            }, 5000);
            
            try {
                await firestoreDB.collection('_test_connection').limit(1).get();
            } finally {
                clearTimeout(testTimeout);
            }
            
            clearTimeout(timeoutId);
            firebaseInitialized = true;
            
            console.log('‚úÖ Firebase successfully initialized');
            
            if (typeof window.KoperasiDB === 'undefined') {
                window.KoperasiDB = createKoperasiDB(firestoreDB, auth);
            } else {
                window.KoperasiDB.initialized = true;
                window.KoperasiDB.db = firestoreDB;
                window.KoperasiDB.auth = auth;
            }
            
            resolve({ firebaseApp, firestoreDB, auth });
            
        } catch (error) {
            clearTimeout(timeoutId);
            console.error('‚ùå Firebase initialization failed:', error);
            
            if (typeof window.KoperasiDB === 'undefined') {
                window.KoperasiDB = createMockKoperasiDB();
            }
            
            window.dispatchEvent(new CustomEvent('firebase-init-failed', { 
                detail: { error: error.message } 
            }));
            
            reject(error);
        }
    });
    
    return firebaseInitializationPromise;
}

function createKoperasiDB(db, auth) {
    const koperasiDB = {
        initialized: true,
        db: db,
        auth: auth,
        
        getAnggota: async (identifier) => {
            try {
                if (!identifier) {
                    console.warn('‚ö†Ô∏è Identifier tidak tersedia');
                    return null;
                }
                
                let doc = await db.collection('anggota').doc(identifier).get();
                
                if (!doc.exists) {
                    const querySnapshot = await db.collection('anggota')
                        .where('email', '==', identifier)
                        .limit(1)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        doc = querySnapshot.docs[0];
                    }
                }
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    const standardizedData = {
                        id: doc.id,
                        nia: doc.id,
                        nama: data.nama || '',
                        posisi: data.posisi || 'Anggota',
                        email: data.email || '',
                        telepon: data.whatsapp || data.telepon || '',
                        whatsapp: data.whatsapp || '',
                        alamat: data.alamat || '',
                        jenis_kelamin: data.jenis_kelamin || data.jenisKelamin || '',
                        agama: data.agama || '',
                        nik: data.nik || data.nik_ktp || '',
                        tanggal_gabung: data.tanggal_bergabung || data.tanggal_daftar || '',
                        status: data.status || data.status_aktif || '',
                        simpanan_pokok: parseFloat(data.simpanan_pokok || data.simpananPokok || 0),
                        simpanan_wajib: parseFloat(data.simpanan_wajib || data.simpananWajib || 0),
                        simpanan_sukarela: parseFloat(data.simpanan_sukarela || data.simpananSukarela || 0),
                        total_simpanan: parseFloat(data.total_simpanan || data.totalSimpanan || 0),
                        total_pinjaman: parseFloat(data.total_pinjaman || data.totalPinjaman || 0),
                        shu: parseFloat(data.shu || data.shu_estimasi || 0),
                        foto: data.foto || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
                        last_update: data.updated_at || data.last_update || new Date().toISOString(),
                        qr_url: data.qr_url || `https://qr-code-hybrid.vercel.app/?id=${doc.id}`,
                        password: data.password || ''
                    };
                    
                    console.log('‚úÖ Data berhasil di-standardize dari Firebase:', standardizedData);
                    return standardizedData;
                } else {
                    console.log('‚ö†Ô∏è Data tidak ditemukan di Firebase untuk identifier:', identifier);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error getting anggota from Firebase:', error);
                window.dispatchEvent(new CustomEvent('firebase-error', { 
                    detail: { 
                        type: 'get-anggotafailed', 
                        message: error.message 
                    } 
                }));
                return null;
            }
        },
        
        updatePassword: async (currentPassword, newPassword) => {
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('User not authenticated');
                }
                
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email, 
                    currentPassword
                );
                
                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPassword);
                
                return true;
            } catch (error) {
                console.error('Error updating password:', error);
                throw error;
            }
        },
        
        updateProfile: async (nia, data) => {
            try {
                await db.collection('anggota').doc(nia).update({
                    ...data,
                    updated_at: new Date().toISOString()
                });
                return true;
            } catch (error) {
                console.error('Error updating profile:', error);
                throw error;
            }
        },
        
        listenToAnggota: (nia, callback) => {
            if (!nia) {
                console.warn('‚ö†Ô∏è NIA tidak tersedia untuk real-time listener');
                return () => {};
            }
            
            try {
                const unsubscribe = db.collection('anggota').doc(nia)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            console.log('üîÑ Real-time update diterima dari Firebase:', data);
                            
                            const standardizedData = {
                                id: doc.id,
                                nia: doc.id,
                                nama: data.nama || '',
                                total_simpanan: parseFloat(data.total_simpanan || data.totalSimpanan || 0),
                                total_pinjaman: parseFloat(data.total_pinjaman || data.totalPinjaman || 0),
                                shu: parseFloat(data.shu || data.shu_estimasi || 0),
                                status: data.status || 'AKTIF'
                            };
                            
                            callback(standardizedData);
                            
                            window.dispatchEvent(new CustomEvent('firebase-data-updated', { 
                                detail: { 
                                    type: 'real-time-update',
                                    data: standardizedData 
                                } 
                            }));
                        }
                    }, (error) => {
                        console.error('‚ùå Real-time listener error:', error);
                        window.dispatchEvent(new CustomEvent('firebase-error', { 
                            detail: { 
                                type: 'realtime-listener-failed', 
                                message: error.message 
                            } 
                        }));
                    });
                
                return unsubscribe;
            } catch (error) {
                console.error('‚ùå Error setting up real-time listener:', error);
                return () => {};
            }
        }
    };
    
    return koperasiDB;
}

function createMockKoperasiDB() {
    console.warn('‚ö†Ô∏è Using mock KoperasiDB (offline mode)');
    
    const mockDB = {
        initialized: false,
        db: null,
        getStatus: () => ({ 
            initialized: false, 
            online: false,
            firebaseConnected: false,
            mode: 'offline' 
        }),
        on: (event, callback) => {
            if (event === 'initialized') {
                setTimeout(() => callback(), 100);
            }
        },
        getAnggota: async (identifier) => {
            console.log('üìÅ Getting anggota from mock DB for identifier:', identifier);
            
            try {
                const anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
                const user = JSON.parse(localStorage.getItem('koperasi_current_user') || '{}');
                
                let found = null;
                
                if (identifier) {
                    found = anggotaData.find(a => 
                        a.nia === identifier || 
                        a.id === identifier || 
                        a.email === identifier ||
                        a.email === user.email
                    );
                }
                
                if (found) {
                    console.log('‚úÖ Found user data in localStorage:', found);
                    return found;
                }
                
                return null;
            } catch (error) {
                console.error('Error getting mock data:', error);
                return null;
            }
        },
        listenToAnggota: (nia, callback) => {
            console.log('üì° Mock real-time listener setup for NIA:', nia);
            
            const interval = setInterval(() => {
                const mockData = {
                    nia: nia,
                    total_simpanan: 0,
                    total_pinjaman: 0,
                    shu: 0,
                    status: 'AKTIF',
                    last_update: new Date().toISOString()
                };
                
                console.log('üîÑ Mock real-time update:', mockData);
                callback(mockData);
            }, 30000);
            
            return () => clearInterval(interval);
        }
    };
    
    return mockDB;
}

// ===== GENERATOR QR CODE SISTEM =====
class QRGeneratorSystem {
    constructor() {
        console.log('üé´ Initializing QR Generator System...');
        this.currentUser = null;
        this.init();
    }
    
    init() {
        try {
            this.currentUser = JSON.parse(localStorage.getItem('koperasi_current_user') || 'null');
            console.log('‚úÖ QR Generator System Ready');
        } catch (error) {
            console.error('Error initializing QR generator:', error);
        }
    }
    
    generateQRCode(text, containerId, options = {}) {
        return new Promise((resolve, reject) => {
            try {
                const container = document.getElementById(containerId);
                if (!container) {
                    reject(new Error('Container not found'));
                    return;
                }
                
                container.innerHTML = '';
                
                const defaultOptions = {
                    text: text,
                    width: 200,
                    height: 200,
                    colorDark: "#1a5f23",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.Q
                };
                
                const qrOptions = { ...defaultOptions, ...options };
                
                new QRCode(container, qrOptions);
                
                setTimeout(() => {
                    const canvas = container.querySelector('canvas');
                    if (canvas) {
                        resolve(canvas.toDataURL('image/png'));
                    } else {
                        reject(new Error('QR Code generation failed'));
                    }
                }, 100);
            } catch (error) {
                reject(error);
            }
        });
    }
    
    generateAnggotaQRCode(anggotaData) {
        const qrData = {
            type: 'anggota_koperasi',
            id: anggotaData.nia || anggotaData.id,
            nama: anggotaData.nama,
            email: anggotaData.email || this.currentUser?.email,
            status: anggotaData.status || 'AKTIF',
            posisi: anggotaData.posisi || 'Anggota',
            total_simpanan: anggotaData.total_simpanan || anggotaData.totalSimpanan || 0,
            total_pinjaman: anggotaData.total_pinjaman || anggotaData.totalPinjaman || 0,
            timestamp: new Date().toISOString(),
            source: 'Koperasi Asmara Tani Digital'
        };
        
        return JSON.stringify(qrData);
    }
    
    downloadQRCode(imageData, filename = 'qr_code.png') {
        const link = document.createElement('a');
        link.download = filename;
        link.href = imageData;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    shareQRCode(imageData, title = 'QR Code Koperasi') {
        if (navigator.share) {
            navigator.share({
                title: title,
                text: 'QR Code Anggota Koperasi Asmara Tani',
                url: imageData
            }).catch(error => {
                console.log('Error sharing:', error);
            });
        } else {
            this.downloadQRCode(imageData);
        }
    }
}

// ===== TABUNGAN APP DENGAN GENERATOR QR CODE =====
class TabunganApp {
    constructor() {
        console.log('üöÄ Memulai TabunganApp dengan Generator QR Code...');
        
        this.currentUser = this.getCurrentUser();
        if (!this.currentUser) {
            alert('Silakan login terlebih dahulu');
            window.location.href = 'login-register.html';
            return;
        }
        
        this.userData = null;
        this.firebaseUserData = null;
        this.syncTimeout = null;
        this.sessionTimeout = null;
        this.isSyncing = false;
        this.nia = null;
        this.firebaseReady = false;
        this.firebaseInitAttempted = false;
        this.modalEventListeners = new Map();
        
        this.setupGlobalErrorHandling();
        
        this.initializeFirebaseWithRetry().then((success) => {
            if (success) {
                console.log('‚úÖ Firebase initialized successfully for TabunganApp');
                this.checkFirebaseStatus();
            } else {
                console.warn('‚ö†Ô∏è Firebase initialization failed, using offline mode');
                this.showToast('Mode offline diaktifkan', 'warning');
                this.checkFirebaseStatus();
            }
        }).catch(error => {
            console.error('‚ùå Error in Firebase initialization:', error);
            this.checkFirebaseStatus();
        });
        
        this.init();
    }
    
    async initializeFirebaseWithRetry() {
        const maxRetries = 3;
        let lastError = null;
        
        for (let i = 0; i < maxRetries; i++) {
            try {
                console.log(`üîÑ Attempt ${i + 1}/${maxRetries} to initialize Firebase...`);
                
                await initializeFirebase();
                this.firebaseReady = true;
                this.firebaseInitAttempted = true;
                
                console.log('‚úÖ Firebase ready for TabunganApp');
                return true;
            } catch (error) {
                lastError = error;
                console.warn(`‚ö†Ô∏è Firebase init attempt ${i + 1} failed:`, error.message);
                
                this.updateFirebaseStatusUI(`Mencoba ulang... (${i + 1}/${maxRetries})`, 'warning');
                
                if (i < maxRetries - 1) {
                    const delay = 2000 * Math.pow(2, i);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        console.error('‚ùå All Firebase initialization attempts failed:', lastError);
        this.updateFirebaseStatusUI('Mode offline', 'warning');
        
        if (typeof window.KoperasiDB === 'undefined') {
            window.KoperasiDB = createMockKoperasiDB();
        }
        
        this.firebaseInitAttempted = true;
        return false;
    }
    
    updateFirebaseStatusUI(status, type = 'info') {
        const syncStatusText = document.getElementById('syncStatusText');
        if (syncStatusText) {
            syncStatusText.textContent = status;
            
            if (type === 'success') {
                syncStatusText.style.color = '#4CAF50';
            } else if (type === 'warning') {
                syncStatusText.style.color = '#FF9800';
            } else if (type === 'error') {
                syncStatusText.style.color = '#f44336';
            } else {
                syncStatusText.style.color = '#2196F3';
            }
        }
    }
    
    setupGlobalErrorHandling() {
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error);
            this.showGlobalError(event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            this.showGlobalError(event.reason);
        });
        
        window.addEventListener('firebase-error', (event) => {
            console.error('Firebase error event:', event.detail);
            this.showToast(`Firebase error: ${event.detail.message}`, 'error');
        });
        
        window.addEventListener('firebase-data-updated', (event) => {
            console.log('Firebase data updated event received');
            if (this.firebaseUserData) {
                this.firebaseUserData = { ...this.firebaseUserData, ...event.detail.data };
                this.updateUIFirebase();
            }
        });
    }
    
    showGlobalError(error) {
        if (error.message && error.message.includes('Firebase')) {
            this.showToast(`System error: ${error.message.substring(0, 50)}...`, 'error');
        }
    }
    
    async checkFirebaseStatus() {
        if (!this.firebaseInitAttempted) {
            setTimeout(() => this.checkFirebaseStatus(), 500);
            return;
        }
        
        if (window.KoperasiDB) {
            try {
                const status = window.KoperasiDB.getStatus ? window.KoperasiDB.getStatus() : { initialized: false };
                
                if (status.initialized && status.firebaseConnected) {
                    this.firebaseReady = true;
                    this.updateFirebaseStatusUI('Terhubung ke Firebase', 'success');
                    console.log('‚úÖ Firebase sudah siap dan terhubung');
                    
                    this.loadFirebaseData();
                } else if (status.initialized) {
                    this.firebaseReady = true;
                    this.updateFirebaseStatusUI('Mode Firebase (offline)', 'warning');
                    console.log('‚ö†Ô∏è Firebase siap tapi offline');
                    
                    this.loadFirebaseData();
                } else {
                    this.updateFirebaseStatusUI('Mode offline', 'warning');
                    console.log('‚ö†Ô∏è Menggunakan mode offline');
                    
                    this.loadData();
                }
            } catch (error) {
                console.error('Error checking Firebase status:', error);
                this.updateFirebaseStatusUI('Error checking status', 'error');
                this.loadData();
            }
        } else {
            console.warn('‚ö†Ô∏è KoperasiDB belum tersedia');
            this.updateFirebaseStatusUI('System initializing...', 'info');
            setTimeout(() => this.checkFirebaseStatus(), 1000);
        }
    }
    
    async loadFirebaseData() {
        try {
            console.log('üîç Memulai proses load data Firebase...');
            
            if (this.nia) {
                console.log('üîç Mencari dengan NIA:', this.nia);
                
                if (window.KoperasiDB && window.KoperasiDB.getAnggota) {
                    const firebaseData = await window.KoperasiDB.getAnggota(this.nia);
                    
                    if (firebaseData) {
                        this.firebaseUserData = firebaseData;
                        console.log('‚úÖ Data ditemukan dengan NIA:', firebaseData);
                        
                        this.saveFirebaseDataToLocal(firebaseData);
                        this.setupFirebaseListener();
                        this.updateUIFirebase();
                        this.updateFirebaseStatusUI('Terhubung ke Firebase', 'success');
                        return;
                    }
                }
            }
            
            console.log('üîç Mencari dengan email:', this.currentUser.email);
            
            if (window.KoperasiDB && window.KoperasiDB.getAnggota) {
                const firebaseData = await window.KoperasiDB.getAnggota(this.currentUser.email);
                
                if (firebaseData) {
                    this.firebaseUserData = firebaseData;
                    this.nia = firebaseData.nia || firebaseData.id;
                    console.log('‚úÖ Data ditemukan dengan email:', firebaseData);
                    
                    this.saveFirebaseDataToLocal(firebaseData);
                    this.setupFirebaseListener();
                    this.updateUIFirebase();
                    this.updateFirebaseStatusUI('Terhubung ke Firebase', 'success');
                    return;
                }
            }
            
            console.log('üîç Mencari di localStorage backup...');
            const backupData = localStorage.getItem(`firebase_backup_${this.currentUser.email}`);
            if (backupData) {
                try {
                    const parsedData = JSON.parse(backupData);
                    if (parsedData && parsedData.nia) {
                        this.firebaseUserData = parsedData;
                        this.nia = parsedData.nia;
                        console.log('‚úÖ Data ditemukan di localStorage backup');
                        
                        this.updateUIFirebase();
                        this.updateFirebaseStatusUI('Data cached (offline)', 'warning');
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing backup data:', e);
                }
            }
            
            console.log('‚ö†Ô∏è Data tidak ditemukan di Firebase, menggunakan data lokal');
            this.showToast('Menggunakan data lokal', 'warning');
            this.loadData();
            this.updateFirebaseStatusUI('Data lokal digunakan', 'warning');
            
        } catch (error) {
            console.error('‚ùå Error loading Firebase data:', error);
            this.loadData();
            this.updateFirebaseStatusUI('Error: ' + error.message.substring(0, 30), 'error');
        }
    }
    
    saveFirebaseDataToLocal(firebaseData) {
        try {
            localStorage.setItem(`firebase_backup_${this.currentUser.email}`, JSON.stringify(firebaseData));
            
            const anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
            const existingIndex = anggotaData.findIndex(a => 
                a.email === this.currentUser.email || 
                a.nia === firebaseData.nia
            );
            
            if (existingIndex !== -1) {
                anggotaData[existingIndex] = { ...anggotaData[existingIndex], ...firebaseData };
            } else {
                anggotaData.push(firebaseData);
            }
            
            localStorage.setItem('koperasi_anggota', JSON.stringify(anggotaData));
            
            console.log('‚úÖ Firebase data saved to localStorage');
        } catch (error) {
            console.error('Error saving Firebase data to localStorage:', error);
        }
    }
    
    setupFirebaseListener() {
        if (!this.nia || !window.KoperasiDB || !window.KoperasiDB.listenToAnggota) return;
        
        if (this.unsubscribeFirebase) {
            this.unsubscribeFirebase();
        }
        
        this.unsubscribeFirebase = window.KoperasiDB.listenToAnggota(this.nia, (data) => {
            console.log('üîÑ Data Firebase diperbarui:', data);
            this.firebaseUserData = data;
            this.updateUIFirebase();
            
            window.pushNotificationSystem?.showNotification(
                'Data Diperbarui',
                'Data keuangan telah diperbarui dari Firebase',
                'info',
                false
            );
            
            this.updateLastSyncTime();
        });
    }
    
    updateUIFirebase() {
        if (!this.firebaseUserData) return;
        
        const formatRupiah = (amount) => {
            if (!amount && amount !== 0) return 'Rp 0';
            return 'Rp ' + amount.toLocaleString('id-ID');
        };
        
        const firebaseData = this.firebaseUserData;
        
        const totalSimpananElement = document.getElementById('hologramTotalSimpanan');
        if (totalSimpananElement && firebaseData.total_simpanan !== undefined) {
            totalSimpananElement.textContent = formatRupiah(firebaseData.total_simpanan);
        }
        
        const totalPinjamanElement = document.getElementById('hologramTotalPinjaman');
        if (totalPinjamanElement && firebaseData.total_pinjaman !== undefined) {
            totalPinjamanElement.textContent = formatRupiah(firebaseData.total_pinjaman);
        }
        
        const shuEstimasiElement = document.getElementById('hologramSHUEstimasi');
        if (shuEstimasiElement && firebaseData.shu !== undefined) {
            shuEstimasiElement.textContent = formatRupiah(firebaseData.shu);
        }
        
        const statusAnggotaElement = document.getElementById('hologramStatusAnggota');
        if (statusAnggotaElement && firebaseData.status) {
            statusAnggotaElement.textContent = firebaseData.status;
            statusAnggotaElement.style.color = firebaseData.status === 'AKTIF' ? '#2e7d32' : '#f44336';
        }
        
        const updateElement = document.getElementById('hologramUpdateTime');
        if (updateElement) {
            const now = new Date();
            updateElement.innerHTML = `
                <i class="fas fa-fire" style="color: #FFA000;"></i>
                Firebase: ${now.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                })}
            `;
        }
        
        this.updateLastSyncTime();
    }
    
    updateLastSyncTime() {
        const lastSyncElement = document.getElementById('lastSyncTime');
        if (lastSyncElement) {
            const now = new Date();
            lastSyncElement.textContent = `Firebase Sync: ${now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            })}`;
        }
    }
    
    getCurrentUser() {
        try {
            const user = localStorage.getItem('koperasi_current_user');
            if (user) {
                const userData = JSON.parse(user);
                
                if (userData.nia) {
                    this.nia = userData.nia;
                    console.log('üìã NIA dari user data:', this.nia);
                } else {
                    const anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
                    const adminData = anggotaData.find(a => a.email === userData.email);
                    
                    if (adminData) {
                        this.nia = adminData.nia || adminData.id;
                        console.log('üìã NIA ditemukan di localStorage:', this.nia);
                        
                        userData.nia = this.nia;
                        localStorage.setItem('koperasi_current_user', JSON.stringify(userData));
                    }
                }
                
                return userData;
            }
            return null;
        } catch (e) {
            console.error('Error getting user:', e);
            return null;
        }
    }
    
    getCompleteAnggotaData() {
        try {
            let completeData = {
                email: this.currentUser?.email || '',
                nama: this.currentUser?.name || 'Anggota Koperasi',
                nia: this.nia || '',
                foto: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
                status: 'AKTIF',
                posisi: 'Anggota',
                alamat: '',
                telepon: '',
                whatsapp: '',
                jenisKelamin: '',
                agama: '',
                nik: '',
                tanggalGabung: '',
                simpananPokok: 0,
                simpananWajib: 0,
                simpananSukarela: 0,
                totalSimpanan: 0,
                totalPinjaman: 0,
                shuEstimasi: 0,
                lastUpdated: new Date().toISOString()
            };

            if (this.firebaseUserData) {
                completeData = {
                    ...completeData,
                    nia: this.firebaseUserData.nia || this.firebaseUserData.id || this.nia,
                    nama: this.firebaseUserData.nama || completeData.nama,
                    foto: this.firebaseUserData.foto || completeData.foto,
                    status: this.firebaseUserData.status || 'AKTIF',
                    posisi: this.firebaseUserData.posisi || 'Anggota',
                    alamat: this.firebaseUserData.alamat || '',
                    telepon: this.firebaseUserData.telepon || '',
                    whatsapp: this.firebaseUserData.whatsapp || '',
                    jenisKelamin: this.firebaseUserData.jenis_kelamin || '',
                    agama: this.firebaseUserData.agama || '',
                    nik: this.firebaseUserData.nik || '',
                    tanggalGabung: this.firebaseUserData.tanggal_gabung || '',
                    simpananPokok: parseFloat(this.firebaseUserData.simpanan_pokok || 0),
                    simpananWajib: parseFloat(this.firebaseUserData.simpanan_wajib || 0),
                    simpananSukarela: parseFloat(this.firebaseUserData.simpanan_sukarela || 0),
                    totalSimpanan: parseFloat(this.firebaseUserData.total_simpanan || 0),
                    totalPinjaman: parseFloat(this.firebaseUserData.total_pinjaman || 0),
                    shuEstimasi: parseFloat(this.firebaseUserData.shu || 0),
                    lastUpdated: this.firebaseUserData.last_update || new Date().toISOString()
                };
            } else {
                const anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
                const userData = anggotaData.find(a => a.email === this.currentUser?.email);
                
                if (userData) {
                    completeData = {
                        ...completeData,
                        nia: userData.nia || userData.id || this.nia,
                        nama: userData.nama || userData.name || completeData.nama,
                        foto: userData.foto || completeData.foto,
                        status: userData.status || userData.statusAktif || 'AKTIF',
                        posisi: userData.posisi || 'Anggota',
                        alamat: userData.alamat || '',
                        telepon: userData.telepon || '',
                        whatsapp: userData.whatsapp || userData.telepon || '',
                        jenisKelamin: userData.jenisKelamin || userData.jenis_kelamin || '',
                        agama: userData.agama || '',
                        nik: userData.nik || userData.nik_ktp || '',
                        tanggalGabung: userData.tanggalGabung || userData.tanggal_gabung || userData.tanggal_bergabung || '',
                        simpananPokok: parseFloat(userData.simpananPokok || userData.simpanan_pokok || 0),
                        simpananWajib: parseFloat(userData.simpananWajib || userData.simpanan_wajib || 0),
                        simpananSukarela: parseFloat(userData.simpananSukarela || userData.simpanan_sukarela || 0),
                        totalSimpanan: parseFloat(userData.totalSimpanan || userData.total_simpanan || 0),
                        totalPinjaman: parseFloat(userData.totalPinjaman || userData.total_pinjaman || 0),
                        shuEstimasi: parseFloat(userData.shuEstimasi || userData.shu || 0),
                        lastUpdated: userData.lastUpdated || userData.last_update || new Date().toISOString()
                    };
                }
            }

            return completeData;

        } catch (error) {
            console.error('Error getting complete data:', error);
            return {
                email: this.currentUser?.email || '',
                nama: this.currentUser?.name || 'Anggota Koperasi',
                nia: this.nia || '',
                foto: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
                status: 'AKTIF',
                posisi: 'Anggota',
                alamat: '',
                telepon: '',
                whatsapp: '',
                jenisKelamin: '',
                agama: '',
                nik: '',
                tanggalGabung: '',
                simpananPokok: 0,
                simpananWajib: 0,
                simpananSukarela: 0,
                totalSimpanan: 0,
                totalPinjaman: 0,
                shuEstimasi: 0,
                lastUpdated: new Date().toISOString()
            };
        }
    }
    
    async init() {
        console.log('üöÄ Aplikasi dimulai untuk:', this.currentUser.email);
        console.log('üìã NIA yang digunakan:', this.nia);
        
        this.setupEventListeners();
        
        document.getElementById('profileAvatar').onerror = function() {
            this.src = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg';
        };
        
        window.menuVoiceSystem = new MenuVoiceSystem();
        window.pushNotificationSystem = new PushNotificationSystem();
        window.arExperience = new ARExperienceSystem();
        window.voiceCommandSystem = new VoiceCommandSystem();
        window.qrGeneratorSystem = new QRGeneratorSystem();
        
        this.resetSessionTimeout();
        document.addEventListener('click', () => this.resetSessionTimeout());
        
        window.addEventListener('online', () => {
            this.showToast('Koneksi internet tersambung', 'success');
            this.forceSync();
        });

        window.addEventListener('offline', () => {
            this.showToast('Anda sedang offline', 'warning');
        });
        
        if (!this.firebaseReady) {
            this.loadData();
        }
        
        this.initHologramSystem();
        this.setupARButtonAnimation();
        
        this.showToast('Sistem Tabungan Digital dengan Generator QR Code siap!', 'success');
        
        setTimeout(() => {
            window.pushNotificationSystem.showNotification(
                'Firebase Connected',
                'Sistem Tabungan Digital terhubung dengan Firebase',
                'info',
                false
            );
        }, 1000);
    }
    
    setupARButtonAnimation() {
        const arButton = document.getElementById('arExperienceBtn');
        if (arButton) {
            setInterval(() => {
                arButton.classList.add('pulse');
                setTimeout(() => {
                    arButton.classList.remove('pulse');
                }, 2000);
            }, 30000);
        }
    }
    
    loadData() {
        this.userData = AdminDataExtractor.extractDataForUser(this.currentUser.email);
        
        if (!this.userData) {
            this.userData = this.createDefaultData();
        }
        
        this.backupData();
        this.updateUI();
        
        console.log('‚úÖ Data loaded:', this.userData);
    }
    
    createDefaultData() {
        return {
            email: this.currentUser.email,
            nama: this.currentUser.name || 'Anggota Koperasi Asmara Tani',
            foto: this.currentUser.foto || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
            status: 'Aktif',
            simpananPokok: 0,
            simpananWajib: 0,
            simpananSukarela: 0,
            totalSimpanan: 0,
            totalPinjaman: 0,
            shuEstimasi: 0,
            lastUpdated: new Date().toISOString(),
            lastUpdatedBy: 'system'
        };
    }
    
    setupEventListeners() {
        this.setupSyncControlsToggle();
        
        document.getElementById('editProfileButton').addEventListener('click', () => {
            this.showEditProfileModal();
        });
        
        document.getElementById('qrButton').addEventListener('click', () => {
            this.showQRModal();
        });
        
        document.getElementById('manualSyncButton').addEventListener('click', () => {
            this.forceSync();
        });
        
        // Event Delegation untuk menu utama
        document.getElementById('mainMenu').addEventListener('click', (e) => {
            const menuItem = e.target.closest('.menu-item');
            if (menuItem) {
                const action = menuItem.dataset.action;
                this.handleMenuAction(action);
            }
        });
        
        document.getElementById('modalClose').addEventListener('click', () => {
            this.closeModal();
        });
        
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalOverlay')) {
                this.closeModal();
            }
        });
        
        window.addEventListener('storage', (e) => {
            if (e.key === 'koperasi_anggota' || e.key === 'koperasiData') {
                console.log('üîÑ Storage change detected');
                this.loadData();
                window.dispatchEvent(new CustomEvent('admin-data-updated'));
            }
        });
        
        this.setupPasswordModalListeners();
        
        const arButton = document.getElementById('arExperienceBtn');
        if (arButton) {
            arButton.addEventListener('click', () => {
                this.showARExperience();
            });
        }
        
        const voiceCommandBtn = document.getElementById('voiceCommandBtn');
        if (voiceCommandBtn) {
            voiceCommandBtn.addEventListener('click', () => {
                this.showVoiceCommands();
            });
        }
        
        const hologramVoiceBtn = document.getElementById('hologramVoiceBtn');
        if (hologramVoiceBtn) {
            hologramVoiceBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.readHologramData();
            });
        }
    }
    
    setupSyncControlsToggle() {
        const syncToggleBtn = document.getElementById('syncControlsToggle');
        const syncControls = document.getElementById('syncControls');
        
        if (syncToggleBtn && syncControls) {
            syncControls.classList.remove('hidden');
            syncToggleBtn.classList.add('active');
            
            syncToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                syncControls.classList.toggle('hidden');
                syncToggleBtn.classList.toggle('active');
                
                const icon = syncToggleBtn.querySelector('i');
                if (syncControls.classList.contains('hidden')) {
                    icon.className = 'fas fa-eye-slash';
                } else {
                    icon.className = 'fas fa-eye';
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!syncControls.contains(e.target) && !syncToggleBtn.contains(e.target)) {
                    syncControls.classList.remove('hidden');
                    syncToggleBtn.classList.add('active');
                    syncToggleBtn.querySelector('i').className = 'fas fa-eye';
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    syncControls.classList.remove('hidden');
                    syncToggleBtn.classList.add('active');
                    syncToggleBtn.querySelector('i').className = 'fas fa-eye';
                }
            });
        }
    }
    
    readHologramData() {
        if (!window.menuVoiceSystem) return;
        
        const totalSimpanan = document.getElementById('hologramTotalSimpanan').textContent;
        const totalPinjaman = document.getElementById('hologramTotalPinjaman').textContent;
        const shuEstimasi = document.getElementById('hologramSHUEstimasi').textContent;
        const statusAnggota = document.getElementById('hologramStatusAnggota').textContent;
        
        const message = `Ringkasan keuangan. Total simpanan: ${totalSimpanan}. Total pinjaman: ${totalPinjaman}. SHU estimasi: ${shuEstimasi}. Status anggota: ${statusAnggota}.`;
        
        window.menuVoiceSystem.speak(message);
        
        const voiceBtn = document.getElementById('hologramVoiceBtn');
        voiceBtn.classList.add('speaking');
        setTimeout(() => {
            voiceBtn.classList.remove('speaking');
        }, 3000);
    }
    
    showARExperience() {
        if (window.arExperience) {
            window.arExperience.showARExperience();
        }
    }
    
    showVoiceCommands() {
        if (window.voiceCommandSystem) {
            window.voiceCommandSystem.showVoiceCommandHelp();
        }
    }
    
    setupPasswordModalListeners() {
        const closePasswordModal = document.getElementById('closePasswordModal');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const passwordModal = document.getElementById('passwordModal');
        
        if (closePasswordModal) {
            closePasswordModal.addEventListener('click', () => {
                this.closePasswordModal();
            });
        }
        
        if (cancelPasswordBtn) {
            cancelPasswordBtn.addEventListener('click', () => {
                this.closePasswordModal();
            });
        }
        
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.changePassword();
            });
        }
        
        if (passwordModal) {
            passwordModal.addEventListener('click', (e) => {
                if (e.target === passwordModal) {
                    this.closePasswordModal();
                }
            });
        }
        
        const toggleButtons = [
            { toggle: 'toggleCurrentPassword', field: 'currentPassword' },
            { toggle: 'toggleNewPassword', field: 'newPassword' },
            { toggle: 'toggleConfirmPassword', field: 'confirmPassword' }
        ];
        
        toggleButtons.forEach(btn => {
            const toggleBtn = document.getElementById(btn.toggle);
            const field = document.getElementById(btn.field);
            
            if (toggleBtn && field) {
                toggleBtn.addEventListener('click', () => {
                    const type = field.getAttribute('type') === 'password' ? 'text' : 'password';
                    field.setAttribute('type', type);
                    toggleBtn.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                });
            }
        });
    }
    
    handleMenuAction(action) {
        switch(action) {
            case 'setor':
                this.showSetorModal();
                break;
            case 'pinjam':
                this.showPinjamModal();
                break;
            case 'riwayat':
                this.showRiwayatModal();
                break;
            case 'kartu':
                this.showKartuModal();
                break;
        }
    }
    
    updateUI() {
        if (!this.userData) return;
        
        document.getElementById('profileName').innerHTML = 
            `${this.userData.nama} <span class="badge">${this.userData.status === 'Aktif' || this.userData.status === 'AKTIF' ? '‚úî' : '‚ö†'}</span>`;
        
        document.getElementById('profileRole').textContent = 
            `@${this.userData.email.split('@')[0]}`;
        
        document.getElementById('profileAvatar').src = this.userData.foto;
        
        document.getElementById('lastSyncTime').textContent = 
            `Update: ${new Date(this.userData.lastUpdated || Date.now()).toLocaleTimeString('id-ID')}`;
        
        const syncStatusText = document.getElementById('syncStatusText');
        if (syncStatusText && !syncStatusText.textContent.includes('Firebase')) {
            syncStatusText.textContent = 'Aktif (Data Lokal)';
            syncStatusText.style.color = '#FF9800';
        }
        
        const tabunganStatus = document.getElementById('tabunganStatus');
        if (tabunganStatus) {
            tabunganStatus.innerHTML = 
                `${this.userData.status} ‚Ä¢ ${this.firebaseReady ? 'Firebase Real-time data' : 'Data Lokal'}`;
        }
        
        this.updateHologramCard();
    }
    
    updateHologramCard() {
        if (!this.userData) return;
        
        const formatRupiah = (amount) => {
            if (!amount && amount !== 0) return 'Rp 0';
            return 'Rp ' + amount.toLocaleString('id-ID');
        };
        
        const totalSimpananElement = document.getElementById('hologramTotalSimpanan');
        if (totalSimpananElement && !this.firebaseUserData) {
            totalSimpananElement.textContent = formatRupiah(0);
        }
        
        const totalPinjamanElement = document.getElementById('hologramTotalPinjaman');
        if (totalPinjamanElement && !this.firebaseUserData) {
            totalPinjamanElement.textContent = formatRupiah(0);
        }
        
        const shuEstimasiElement = document.getElementById('hologramSHUEstimasi');
        if (shuEstimasiElement && !this.firebaseUserData) {
            shuEstimasiElement.textContent = formatRupiah(0);
        }
        
        const statusAnggotaElement = document.getElementById('hologramStatusAnggota');
        if (statusAnggotaElement && !this.firebaseUserData) {
            statusAnggotaElement.textContent = this.userData.status || 'Aktif';
            
            if (this.userData.status === 'Aktif' || this.userData.status === 'AKTIF') {
                statusAnggotaElement.style.color = '#2e7d32';
            } else {
                statusAnggotaElement.style.color = '#f44336';
            }
        }
        
        const updateElement = document.getElementById('hologramUpdateTime');
        if (updateElement) {
            const now = new Date();
            updateElement.innerHTML = `
                <i class="fas fa-clock"></i>
                Update: ${now.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                })}
            `;
        }
    }
    
    showModal(title, content) {
        this.cleanupModalEvents();
        
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = content;
        document.getElementById('modalOverlay').classList.add('active');
    }
    
    cleanupModalEvents() {
        const overlay = document.getElementById('modalOverlay');
        const newOverlay = overlay.cloneNode(true);
        overlay.parentNode.replaceChild(newOverlay, overlay);
        
        document.getElementById('modalClose').addEventListener('click', () => {
            this.closeModal();
        });
        
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('modalOverlay')) {
                this.closeModal();
            }
        });
    }
    
    closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
        document.getElementById('modalBody').innerHTML = '';
    }
    
    showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMessage');
        
        toast.className = `toast ${type}`;
        toastMsg.textContent = message;
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
    
    formatNumber(num) {
        return new Intl.NumberFormat('id-ID').format(num);
    }
    
    // ===== QR CODE MODAL DENGAN GENERATOR =====
    showQRModal() {
        const completeData = this.getCompleteAnggotaData();
        
        const html = `
            <div class="qr-modal-design">
                <div class="qr-title">
                    <i class="fas fa-qrcode"></i> QR Code Generator - Data Anggota
                </div>
                
                <div class="qr-card">
                    <div class="qr-person-info">
                        <div class="qr-person-photo">
                            <img src="${completeData.foto}" alt="Foto Anggota" 
                                 onerror="this.src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg'">
                        </div>
                        <div class="qr-person-details">
                            <h4>${completeData.nama}</h4>
                            <p><i class="fas fa-id-card"></i> NIA: ${completeData.nia || 'N/A'}</p>
                            <p><i class="fas fa-briefcase"></i> Posisi: ${completeData.posisi || 'Anggota'}</p>
                            <p><i class="fas fa-check-circle"></i> Status: ${completeData.status || 'Aktif'}</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <p style="margin: 0; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-qrcode" style="color: #FFD700;"></i>
                            <span>QR Code ini berisi data keanggotaan digital</span>
                        </p>
                    </div>
                </div>
                
                <!-- QR Code Generator Container -->
                <div style="text-align: center; margin: 25px 0; padding: 20px; background: white; border-radius: 12px; box-shadow: var(--shadow-light); min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;" id="qrGeneratorContainer">
                    <div style="margin-bottom: 15px;">
                        <i class="fas fa-qrcode" style="font-size: 2rem; color: var(--primary);"></i>
                    </div>
                    <p style="color: var(--text-secondary); margin-top: 10px;">Siap untuk membuat QR Code...</p>
                    <div id="qrStatus" style="font-size: 0.8rem; color: #666; margin-top: 10px;"></div>
                </div>
                
                <!-- QR Code Customization Options -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 1rem;">
                        <i class="fas fa-paint-brush"></i> Kustomisasi QR Code
                    </h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.8rem; color: #666;">Ukuran</label>
                            <select class="form-control" id="qrSize" style="padding: 8px; font-size: 0.9rem;">
                                <option value="200">Kecil (200px)</option>
                                <option value="300" selected>Sedang (300px)</option>
                                <option value="400">Besar (400px)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: #666;">Warna</label>
                            <select class="form-control" id="qrColor" style="padding: 8px; font-size: 0.9rem;">
                                <option value="#1a5f23">Hijau (Default)</option>
                                <option value="#2196F3">Biru</option>
                                <option value="#9C27B0">Ungu</option>
                                <option value="#FF9800">Oranye</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="action-btn download" id="generateQRBtn" style="width: 100%;">
                            <i class="fas fa-sync-alt"></i> Generate QR Code
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 1rem;">
                        <i class="fas fa-info-circle"></i> Cara menggunakan QR Code:
                    </h5>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 24px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                            <span>Scan QR Code dengan aplikasi scanner QR di ponsel</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 24px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                            <span>Data keanggotaan akan ditampilkan dalam format JSON</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 24px; height: 24px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                            <span>Gunakan untuk validasi keanggotaan digital</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="action-btn download" id="downloadQRBtn">
                        <i class="fas fa-download"></i> Download QR
                    </button>
                    <button type="button" class="action-btn whatsapp" id="shareQRBtn">
                        <i class="fab fa-whatsapp"></i> Bagikan
                    </button>
                    <button type="button" class="action-btn secondary" id="printQRBtn" style="background: #4CAF50;">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
                
                <div class="modal-actions" style="margin-top: 25px;">
                    <button type="button" class="modal-btn primary" id="closeQRBtn" style="width: 100%;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
            </div>
        `;
        
        this.showModal('QR Code Generator', html);
        
        // Generate QR Code pertama kali
        this.generateQRCodeForModal(completeData);
        
        // Setup event listeners
        this.setupQRModalListeners(completeData);
    }
    
    async generateQRCodeForModal(completeData) {
        const qrStatus = document.getElementById('qrStatus');
        const qrContainer = document.getElementById('qrGeneratorContainer');
        
        if (qrStatus) {
            qrStatus.textContent = 'Membuat QR Code...';
            qrStatus.style.color = '#2196F3';
        }
        
        try {
            // Generate QR data
            const qrData = window.qrGeneratorSystem.generateAnggotaQRCode(completeData);
            
            // Get customization options
            const size = document.getElementById('qrSize') ? document.getElementById('qrSize').value : 300;
            const color = document.getElementById('qrColor') ? document.getElementById('qrColor').value : '#1a5f23';
            
            // Generate QR code
            await window.qrGeneratorSystem.generateQRCode(qrData, 'qrGeneratorContainer', {
                width: parseInt(size),
                height: parseInt(size),
                colorDark: color
            });
            
            if (qrStatus) {
                qrStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50;"></i> QR Code berhasil dibuat';
                qrStatus.style.color = '#4CAF50';
            }
            
            // Save QR data for download
            qrContainer.dataset.qrData = qrData;
            qrContainer.dataset.qrImage = qrContainer.querySelector('canvas').toDataURL('image/png');
            
            this.showToast('QR Code berhasil dibuat', 'success');
            
        } catch (error) {
            console.error('Error generating QR code:', error);
            
            if (qrStatus) {
                qrStatus.innerHTML = '<i class="fas fa-times-circle" style="color: #f44336;"></i> Gagal membuat QR Code';
                qrStatus.style.color = '#f44336';
            }
            
            qrContainer.innerHTML = `
                <div style="color: #f44336; padding: 20px; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <p style="font-weight: bold; margin-bottom: 10px;">Gagal membuat QR Code</p>
                    <p style="font-size: 0.9rem; margin-bottom: 15px;">${error.message}</p>
                    <button class="action-btn download" onclick="window.app.regenerateQRCode()" style="margin-top: 10px;">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </div>
            `;
        }
    }
    
    setupQRModalListeners(completeData) {
        document.getElementById('generateQRBtn')?.addEventListener('click', () => {
            this.generateQRCodeForModal(completeData);
        });
        
        document.getElementById('downloadQRBtn')?.addEventListener('click', () => {
            this.downloadQRCode(completeData);
        });
        
        document.getElementById('shareQRBtn')?.addEventListener('click', () => {
            this.shareQRCode(completeData);
        });
        
        document.getElementById('printQRBtn')?.addEventListener('click', () => {
            this.printQRCode();
        });
        
        document.getElementById('closeQRBtn')?.addEventListener('click', () => {
            this.closeModal();
        });
        
        // Add change listeners for customization options
        document.getElementById('qrSize')?.addEventListener('change', () => {
            this.generateQRCodeForModal(completeData);
        });
        
        document.getElementById('qrColor')?.addEventListener('change', () => {
            this.generateQRCodeForModal(completeData);
        });
    }
    
    downloadQRCode(completeData) {
        const qrContainer = document.getElementById('qrGeneratorContainer');
        if (!qrContainer || !qrContainer.dataset.qrImage) {
            this.showToast('QR Code belum dibuat', 'error');
            return;
        }
        
        try {
            window.qrGeneratorSystem.downloadQRCode(
                qrContainer.dataset.qrImage,
                `QR_Code_${completeData.nia || 'anggota'}_${Date.now()}.png`
            );
            
            this.showToast('QR Code berhasil diunduh', 'success');
            
        } catch (error) {
            console.error('Error downloading QR code:', error);
            this.showToast('Gagal mengunduh QR Code', 'error');
        }
    }
    
    shareQRCode(completeData) {
        const qrContainer = document.getElementById('qrGeneratorContainer');
        if (!qrContainer || !qrContainer.dataset.qrImage) {
            this.showToast('QR Code belum dibuat', 'error');
            return;
        }
        
        const message = `*QR CODE ANGGOTA KOPERASI ASMARA TANI* #koperasijenius\n\n` +
                       `üë§ *Nama:* ${completeData.nama}\n` +
                       `üÜî *NIA:* ${completeData.nia || 'N/A'}\n` +
                       `‚úÖ *Status:* ${completeData.status}\n` +
                       `üíº *Posisi:* ${completeData.posisi || 'Anggota'}\n` +
                       `üí∞ *Total Simpanan:* ${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}\n` +
                       `üìÖ *Update:* ${new Date().toLocaleDateString('id-ID')}\n\n` +
                       `_Scan QR Code untuk verifikasi keanggotaan digital_`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        
        this.showToast('QR Code siap dibagikan', 'success');
    }
    
    printQRCode() {
        const qrContainer = document.getElementById('qrGeneratorContainer');
        if (!qrContainer) {
            this.showToast('QR Code belum dibuat', 'error');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>QR Code Anggota - Koperasi Asmara Tani</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        text-align: center; 
                        padding: 40px 20px;
                        background: white;
                    }
                    .print-container { 
                        max-width: 500px; 
                        margin: 0 auto; 
                    }
                    .qr-code { 
                        margin: 20px 0; 
                    }
                    .info { 
                        margin-top: 20px; 
                        font-size: 14px; 
                        color: #666;
                    }
                </style>
            </head>
            <body>
                <div class="print-container">
                    <h2>QR Code Anggota Koperasi</h2>
                    <div class="qr-code">
                        ${qrContainer.innerHTML}
                    </div>
                    <div class="info">
                        <p><strong>Koperasi Asmara Tani</strong></p>
                        <p>QR Code untuk verifikasi keanggotaan digital</p>
                        <p>Dicetak: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                    </div>
                </div>
                <script>
                    window.onload = function() {
                        setTimeout(() => {
                            window.print();
                            setTimeout(() => {
                                window.close();
                            }, 500);
                        }, 500);
                    };
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
        
        this.showToast('Membuka jendela cetak...', 'info');
    }
    
    regenerateQRCode() {
        const completeData = this.getCompleteAnggotaData();
        this.generateQRCodeForModal(completeData);
    }
    
    // ===== FUNGSI-FUNGSI LAINNYA =====
    async saveProfileChanges() {
        try {
            const nama = document.getElementById('editNama').value.trim();
            const telepon = document.getElementById('editTelepon').value.trim();
            const alamat = document.getElementById('editAlamat').value.trim();
            const foto = document.getElementById('editFoto').value;
            const jenisKelamin = document.getElementById('editJenisKelamin').value;
            const agama = document.getElementById('editAgama').value;
            const nik = document.getElementById('editNIK').value.trim();
            
            if (!nama) {
                this.showToast('Nama lengkap harus diisi', 'error');
                return;
            }
            
            if (!telepon) {
                this.showToast('Nomor WhatsApp harus diisi', 'error');
                return;
            }
            
            if (!this.validatePhone(telepon)) {
                this.showToast('Format WhatsApp tidak valid. Contoh: 628123456789', 'error');
                return;
            }
            
            this.userData.nama = nama;
            this.userData.telepon = telepon;
            this.userData.whatsapp = telepon;
            this.userData.alamat = alamat;
            this.userData.foto = foto || this.userData.foto;
            this.userData.jenisKelamin = jenisKelamin;
            this.userData.agama = agama;
            this.userData.nik = nik;
            this.userData.lastUpdated = new Date().toISOString();
            this.userData.lastUpdatedBy = 'user';
            
            const completeData = this.getCompleteAnggotaData();
            this.userData.nia = completeData.nia || this.userData.nia;
            this.userData.posisi = completeData.posisi || this.userData.posisi;
            this.userData.email = completeData.email || this.currentUser.email;
            this.userData.tanggalGabung = completeData.tanggalGabung || this.userData.tanggalGabung;
            this.userData.simpananPokok = completeData.simpananPokok || 0;
            this.userData.simpananWajib = completeData.simpananWajib || 0;
            this.userData.simpananSukarela = completeData.simpananSukarela || 0;
            this.userData.totalSimpanan = completeData.totalSimpanan || 0;
            this.userData.totalPinjaman = completeData.totalPinjaman || 0;
            this.userData.shuEstimasi = completeData.shuEstimasi || 0;
            
            if (window.KoperasiDB && window.KoperasiDB.updateProfile && this.nia) {
                try {
                    await window.KoperasiDB.updateProfile(this.nia, {
                        nama: nama,
                        whatsapp: telepon,
                        telepon: telepon,
                        alamat: alamat,
                        foto: foto,
                        jenis_kelamin: jenisKelamin,
                        agama: agama,
                        nik: nik,
                        updated_at: new Date().toISOString()
                    });
                    console.log('‚úÖ Profile updated in Firebase');
                } catch (error) {
                    console.error('Error updating profile in Firebase:', error);
                }
            }
            
            this.saveToLocalStorage();
            this.updateUI();
            localStorage.removeItem('temp_profile_photo');
            this.closeModal();
            this.showToast('Profil berhasil diperbarui!', 'success');
            
            window.pushNotificationSystem.showNotification(
                'Profil Diperbarui',
                'Perubahan pada profil Anda telah disimpan.',
                'info',
                false
            );
            
        } catch (error) {
            console.error('Error saving profile:', error);
            this.showToast('Gagal menyimpan perubahan', 'error');
        }
    }
    
    validatePhone(phone) {
        const phoneRegex = /^[0-9]{10,15}$/;
        return phoneRegex.test(phone.replace(/^\+?62/, ''));
    }
    
    saveToLocalStorage() {
        try {
            const allAnggota = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
            const index = allAnggota.findIndex(a => a.email === this.currentUser.email);
            
            if (index >= 0) {
                allAnggota[index] = { ...allAnggota[index], ...this.userData };
            } else {
                allAnggota.push(this.userData);
            }
            
            localStorage.setItem('koperasi_anggota', JSON.stringify(allAnggota));
            
            const koperasiData = JSON.parse(localStorage.getItem('koperasiData') || '{}');
            if (!koperasiData.userUpdates) {
                koperasiData.userUpdates = {};
            }
            
            koperasiData.userUpdates[this.currentUser.email] = {
                personal: {
                    nama: this.userData.nama,
                    telepon: this.userData.telepon,
                    alamat: this.userData.alamat,
                    foto: this.userData.foto,
                    lastUpdated: this.userData.lastUpdated
                },
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('koperasiData', JSON.stringify(koperasiData));
            
        } catch (error) {
            console.error('Error saving data:', error);
        }
    }
    
    showEditProfileModal() {
        const completeData = this.getCompleteAnggotaData();
        
        const html = `
            <form id="editForm">
                <!-- Foto Upload -->
                <div class="photo-upload-container">
                    <div class="photo-preview">
                        <img src="${completeData.foto}" alt="Foto Profil" id="currentPhoto"
                             onerror="this.src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg'">
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                        <button type="button" class="action-btn download" onclick="document.getElementById('fileUpload').click()" style="padding: 8px 15px;">
                            <i class="fas fa-upload"></i> Upload Foto
                        </button>
                        <button type="button" class="action-btn secondary" onclick="resetPhoto()" style="padding: 8px 15px; background: #666;">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                    <input type="file" id="fileUpload" accept="image/*" style="display: none;" 
                           onchange="handlePhotoUpload(event)">
                    <input type="hidden" id="editFoto" value="${completeData.foto}">
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                        Ukuran maksimal 2MB. Format: JPG, PNG
                    </p>
                </div>
                
                <!-- Data dari Firebase -->
                <div class="anggota-status-info" style="margin-top: 20px;">
                    <h4><i class="fas fa-fire" style="color: #FFA000;"></i> Data Firebase (Read Only)</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div>
                            <label class="form-label">ID/NIA</label>
                            <input type="text" class="form-control readonly-field" 
                                   value="${completeData.nia || 'N/A'}" readonly>
                        </div>
                        <div>
                            <label class="form-label">Posisi</label>
                            <input type="text" class="form-control readonly-field" 
                                   value="${completeData.posisi || 'Anggota'}" readonly>
                        </div>
                        <div>
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control readonly-field" 
                                   value="${completeData.email || this.currentUser.email}" readonly>
                        </div>
                        <div>
                            <label class="form-label">Status Firebase</label>
                            <input type="text" class="form-control readonly-field" 
                                   value="${completeData.status || 'AKTIF'}" readonly>
                        </div>
                    </div>
                    ${this.firebaseUserData ? 
                        `<p style="font-size: 0.8rem; color: #4CAF50; margin-top: 10px; text-align: center;">
                            <i class="fas fa-check-circle"></i> Data terhubung dengan Firebase
                        </p>` : 
                        `<p style="font-size: 0.8rem; color: #FF9800; margin-top: 10px; text-align: center;">
                            <i class="fas fa-exclamation-triangle"></i> Data lokal (Firebase tidak tersedia)
                        </p>`
                    }
                </div>
                
                <!-- Data yang bisa diedit -->
                <div style="margin-top: 20px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;"><i class="fas fa-edit"></i> Data yang Dapat Diedit</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="editNama" 
                               value="${completeData.nama || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Alamat Lengkap</label>
                        <textarea class="form-control" id="editAlamat" rows="3">${completeData.alamat || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Jenis Kelamin</label>
                        <select class="form-control" id="editJenisKelamin">
                            <option value="">Pilih Jenis Kelamin</option>
                            <option value="Laki-laki" ${(completeData.jenisKelamin === 'Laki-laki') ? 'selected' : ''}>Laki-laki</option>
                            <option value="Perempuan" ${(completeData.jenisKelamin === 'Perempuan') ? 'selected' : ''}>Perempuan</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Agama</label>
                        <select class="form-control" id="editAgama">
                            <option value="">Pilih Agama</option>
                            <option value="Islam" ${(completeData.agama === 'Islam') ? 'selected' : ''}>Islam</option>
                            <option value="Kristen" ${(completeData.agama === 'Kristen') ? 'selected' : ''}>Kristen</option>
                            <option value="Katolik" ${(completeData.agama === 'Katolik') ? 'selected' : ''}>Katolik</option>
                            <option value="Hindu" ${(completeData.agama === 'Hindu') ? 'selected' : ''}>Hindu</option>
                            <option value="Budha" ${(completeData.agama === 'Budha') ? 'selected' : ''}>Budha</option>
                            <option value="Konghucu" ${(completeData.agama === 'Konghucu') ? 'selected' : ''}>Konghucu</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">No. WhatsApp *</label>
                        <input type="text" class="form-control" id="editTelepon" 
                               value="${completeData.telepon || completeData.whatsapp || ''}" 
                               placeholder="628xxxxxxxxxx" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">NIK KTP</label>
                        <input type="text" class="form-control" id="editNIK" 
                               value="${completeData.nik || ''}" 
                               placeholder="16 digit NIK">
                    </div>
                </div>
                
                <!-- Password Section -->
                <div class="password-section" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500; color: var(--primary);">
                            <i class="fas fa-key"></i> Password
                        </span>
                        <button type="button" class="password-toggle-link" onclick="app.showPasswordModal()">
                            <i class="fas fa-exchange-alt"></i> Ganti Password
                        </button>
                    </div>
                    <div style="margin-top: 10px; padding: 12px; background: #f5f5f5; border-radius: 8px; text-align: center;">
                        <span style="letter-spacing: 4px; font-family: monospace; color: var(--text-secondary);">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                            Password dienkripsi dan aman
                        </p>
                    </div>
                </div>
                
                <!-- Info Simpanan dari Firebase -->
                <div class="anggota-status-info" style="margin-top: 20px;">
                    <h4><i class="fas fa-coins"></i> Informasi Simpanan (Firebase)</h4>
                    <ul>
                        <li>Simpanan Pokok: ${AdminDataExtractor.formatRupiah(completeData.simpananPokok || 0)}</li>
                        <li>Simpanan Wajib: ${AdminDataExtractor.formatRupiah(completeData.simpananWajib || 0)}</li>
                        <li>Simpanan Sukarela: ${AdminDataExtractor.formatRupiah(completeData.simpananSukarela || 0)}</li>
                        <li style="font-weight: bold; color: var(--primary); border-top: 1px solid var(--border-color); padding-top: 5px;">
                            Total Simpanan: ${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}
                        </li>
                    </ul>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                        <i class="fas fa-info-circle"></i> 
                        Data keuangan diambil dari Firebase Firestore
                    </p>
                </div>
                
                <div class="modal-actions" style="margin-top: 25px;">
                    <button type="button" class="modal-btn secondary" id="cancelEdit">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button type="submit" class="modal-btn primary" id="saveEdit">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </form>
        `;
        
        this.showModal('Edit Profil Lengkap', html);
        
        const editForm = document.getElementById('editForm');
        if (editForm) {
            editForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveProfileChanges();
            });
        }
        
        document.getElementById('cancelEdit').addEventListener('click', () => {
            this.closeModal();
        });
        
        const savedPhoto = localStorage.getItem('temp_profile_photo');
        if (savedPhoto) {
            const img = document.getElementById('currentPhoto');
            const fotoInput = document.getElementById('editFoto');
            if (img) img.src = savedPhoto;
            if (fotoInput) fotoInput.value = savedPhoto;
        }
    }
    
    showKartuModal() {
        const completeData = this.getCompleteAnggotaData();
        const saldoBersih = (completeData.totalSimpanan || 0) - (completeData.totalPinjaman || 0);
        
        const html = `
            <div style="padding: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-id-card"></i> KARTU ANGGOTA DIGITAL
                </h4>
                
                <!-- Kartu Design -->
                <div style="background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 25px; border-radius: 20px; margin-bottom: 25px; position: relative; overflow: hidden;" id="kartuDisplay">
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-handshake" style="font-size: 1.5rem;"></i>
                            <span style="font-weight: bold; font-size: 1.1rem;">Koperasi Asmara Tani</span>
                        </div>
                        <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">
                            ${completeData.status} ‚Ä¢ #koperasijenius
                        </span>
                    </div>
                    
                    <!-- Info Anggota -->
                    <div class="kartu-info">
                        <div class="kartu-photo">
                            <img src="${completeData.foto}" 
                                 onerror="this.src='https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg'">
                        </div>
                        <div class="kartu-details">
                            <h4>${completeData.nama}</h4>
                            <p><i class="fas fa-id-card"></i> NIA: ${completeData.nia || '-'}</p>
                            <p><i class="fas fa-briefcase"></i> Posisi: ${completeData.posisi || 'Anggota'}</p>
                            <p><i class="fas fa-venus-mars"></i> Jenis Kelamin: ${completeData.jenisKelamin || '-'}</p>
                            <p><i class="fas fa-pray"></i> Agama: ${completeData.agama || '-'}</p>
                            <p><i class="fas fa-address-card"></i> NIK KTP: ${completeData.nik || '-'}</p>
                            <p><i class="fas fa-check-circle"></i> Status: ${completeData.status || completeData.statusAktif || 'Aktif'}</p>
                        </div>
                    </div>
                    
                    <!-- Data Keuangan -->
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h5 style="margin: 0 0 15px 0; text-align: center; opacity: 0.9;">DATA KEUANGAN FIREBASE</h5>
                        ${this.firebaseUserData ? 
                            `<p style="text-align: center; margin-bottom: 15px; font-size: 0.8rem; opacity: 0.8;">
                                <i class="fas fa-fire" style="color: #FFA000;"></i> Data Real-time dari Firebase
                            </p>` : ''
                        }
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="opacity: 0.8; font-size: 0.8rem;">Simpanan Pokok</div>
                                <div style="font-weight: bold; margin: 5px 0;">${AdminDataExtractor.formatRupiah(completeData.simpananPokok || 0)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="opacity: 0.8; font-size: 0.8rem;">Simpanan Wajib</div>
                                <div style="font-weight: bold; margin: 5px 0;">${AdminDataExtractor.formatRupiah(completeData.simpananWajib || 0)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="opacity: 0.8; font-size: 0.8rem;">Simpanan Sukarela</div>
                                <div style="font-weight: bold; margin: 5px 0;">${AdminDataExtractor.formatRupiah(completeData.simpananSukarela || 0)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="opacity: 0.8; font-size: 0.8rem;">Total Simpanan</div>
                                <div style="font-weight: bold; margin: 5px 0; color: #ffd700;">${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="opacity: 0.8; font-size: 0.8rem;">Total Pinjaman</div>
                                <div style="font-weight: bold; margin: 5px 0;">${AdminDataExtractor.formatRupiah(completeData.totalPinjaman || 0)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="opacity: 0.8; font-size: 0.8rem;">Saldo Bersih</div>
                                <div style="font-weight: bold; margin: 5px 0; color: #4CAF50;">${AdminDataExtractor.formatRupiah(saldoBersih)}</div>
                            </div>
                            <div style="text-align: center; grid-column: 1 / -1;">
                                <div style="opacity: 0.8; font-size: 0.8rem;">SHU Estimasi</div>
                                <div style="font-weight: bold; margin: 5px 0; color: #2196F3;">${AdminDataExtractor.formatRupiah(completeData.shuEstimasi || 0)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="text-align: center; font-size: 0.8rem; opacity: 0.8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                        <p style="margin: 0;">Kartu Anggota Digital - #koperasijenius</p>
                        <p style="margin: 5px 0 0 0;">Update: ${new Date(completeData.lastUpdated).toLocaleDateString('id-ID')}</p>
                    </div>
                </div>
                
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: var(--primary); margin: 0; font-size: 0.9rem; text-align: center;">
                        <i class="fas fa-fire" style="color: #FFA000;"></i> 
                        Semua data keuangan diambil langsung dari Firebase Firestore
                    </p>
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="action-btn whatsapp" id="shareKartuBtn">
                        <i class="fab fa-whatsapp"></i> Bagikan Kartu
                    </button>
                    <button type="button" class="action-btn download" id="downloadKartuBtn">
                        <i class="fas fa-download"></i> Download Gambar
                    </button>
                    <button type="button" class="action-btn pdf" id="downloadKartuPDFBtn">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="modal-btn primary" id="closeKartuBtn">Tutup</button>
                </div>
            </div>
        `;
        
        this.showModal('Kartu Anggota', html);
        
        document.getElementById('closeKartuBtn').addEventListener('click', () => {
            this.closeModal();
        });
        
        document.getElementById('shareKartuBtn').addEventListener('click', () => {
            this.shareKartu();
        });
        
        document.getElementById('downloadKartuBtn').addEventListener('click', () => {
            this.downloadKartu();
        });
        
        document.getElementById('downloadKartuPDFBtn').addEventListener('click', () => {
            this.downloadKartuPDF();
        });
    }
    
    shareKartu() {
        const completeData = this.getCompleteAnggotaData();
        const saldoBersih = (completeData.totalSimpanan || 0) - (completeData.totalPinjaman || 0);
        
        const message = `*KARTU ANGGOTA KOPERASI ASMARA TANI* #koperasijenius\n\n` +
                       `üë§ *Nama:* ${completeData.nama}\n` +
                       `üÜî *NIA:* ${completeData.nia || '-'}\n` +
                       `üè¢ *Posisi:* ${completeData.posisi || 'Anggota'}\n` +
                       `üìç *Alamat:* ${completeData.alamat || '-'}\n` +
                       `üìû *WhatsApp:* ${completeData.telepon || completeData.whatsapp || '-'}\n` +
                       `üë´ *Jenis Kelamin:* ${completeData.jenisKelamin || '-'}\n` +
                       `üïå *Agama:* ${completeData.agama || '-'}\n` +
                       `üÜî *NIK KTP:* ${completeData.nik || '-'}\n` +
                       `‚úÖ *Status:* ${completeData.status || completeData.statusAktif || 'Aktif'}\n` +
                       `üí∞ *Total Simpanan:* ${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}\n` +
                       `üí≥ *Total Pinjaman:* ${AdminDataExtractor.formatRupiah(completeData.totalPinjaman || 0)}\n` +
                       `üíµ *Saldo Bersih:* ${AdminDataExtractor.formatRupiah(saldoBersih)}\n` +
                       `üìÖ *Tanggal Bergabung:* ${completeData.tanggalGabung || '-'}\n\n` +
                       `_Kartu Anggota Digital Firebase - #koperasijenius_`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        this.showToast('Kartu siap dibagikan', 'success');
    }
    
    downloadKartu() {
        const kartuElement = document.getElementById('kartuDisplay');
        if (kartuElement) {
            setTimeout(() => {
                html2canvas(kartuElement, {
                    backgroundColor: null,
                    scale: 3,
                    useCORS: true,
                    logging: false,
                    allowTaint: true,
                    imageTimeout: 15000
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Kartu_Anggota_${this.userData.nia || 'anggota'}_${this.userData.nama.replace(/\s+/g, '_')}.png`;
                    
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                    }, 'image/png', 1.0);
                    
                    this.showToast('Kartu berhasil diunduh', 'success');
                }).catch(error => {
                    console.error('Error generating kartu image:', error);
                    this.showToast('Gagal mengunduh kartu', 'error');
                });
            }, 1000);
        }
    }
    
    downloadKartuPDF() {
        const kartuElement = document.getElementById('kartuDisplay');
        if (kartuElement) {
            setTimeout(() => {
                html2canvas(kartuElement, {
                    backgroundColor: null,
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 15000
                }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a6');
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 105;
                    const pageHeight = 148;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    const xOffset = (imgWidth - (imgWidth * 0.9)) / 2;
                    const yOffset = (pageHeight - imgHeight) / 2;
                    
                    pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth * 0.9, imgHeight);
                    
                    pdf.setFontSize(8);
                    pdf.setTextColor(102, 102, 102);
                    pdf.text('Kartu Anggota Koperasi Asmara Tani - #koperasijenius', 105/2, 140, null, null, 'center');
                    pdf.text(`Dicetak: ${new Date().toLocaleDateString('id-ID')}`, 105/2, 145, null, null, 'center');
                    
                    pdf.save(`Kartu_Anggota_${this.userData.nia || 'anggota'}_${this.userData.nama.replace(/\s+/g, '_')}.pdf`);
                    this.showToast('PDF Kartu berhasil diunduh', 'success');
                }).catch(error => {
                    console.error('Error generating PDF:', error);
                    this.showToast('Gagal mengunduh PDF', 'error');
                });
            }, 1000);
        }
    }
    
    showSetorModal() {
        const completeData = this.getCompleteAnggotaData();
        
        const html = `
            <div style="padding: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 20px;">Setor Simpanan</h4>
                
                <div style="background: #f0f7f0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: var(--primary); margin: 0 0 10px 0;">
                        <i class="fas fa-info-circle"></i> Status Simpanan Anda (Firebase):
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <small>Total Simpanan</small>
                            <p style="margin: 5px 0; font-weight: bold; color: var(--primary);">
                                ${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}
                            </p>
                        </div>
                        <div>
                            <small>Update Terakhir</small>
                            <p style="margin: 5px 0; font-size: 0.9rem; color: #666;">
                                ${completeData.lastUpdated ? new Date(completeData.lastUpdated).toLocaleDateString('id-ID') : 'Baru saja'}
                            </p>
                        </div>
                    </div>
                    ${this.firebaseUserData ? 
                        `<p style="font-size: 0.8rem; color: #4CAF50; margin-top: 10px; text-align: center;">
                            <i class="fas fa-fire"></i> Data dari Firebase
                        </p>` : ''
                    }
                </div>
                
                <form id="setorForm">
                    <div class="form-group">
                        <label class="form-label">Jenis Simpanan</label>
                        <select class="form-control" id="jenisSimpanan">
                            <option value="pokok">Simpanan Pokok</option>
                            <option value="wajib">Simpanan Wajib</option>
                            <option value="sukarela">Simpanan Sukarela</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Jumlah (Rp)</label>
                        <input type="number" class="form-control" id="jumlahSetor" min="10000" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Metode Pembayaran</label>
                        <select class="form-control" id="metodeBayar">
                            <option value="bank">Transfer Bank BRI</option>
                            <option value="tunai">Tunai di Kantor</option>
                            <option value="e-wallet">E-Wallet</option>
                            <option value="dana">DANA</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="modal-btn secondary" id="cancelSetor">Batal</button>
                        <button type="submit" class="modal-btn primary" id="submitSetor">Kirim Pengajuan</button>
                    </div>
                </form>
            </div>
        `;
        
        this.showModal('Setor Simpanan', html);
        
        document.getElementById('setorForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitSetoran();
        });
        
        document.getElementById('cancelSetor').addEventListener('click', () => {
            this.closeModal();
        });
    }
    
    submitSetoran() {
        const jenisSimpanan = document.getElementById('jenisSimpanan').value;
        const jumlah = document.getElementById('jumlahSetor').value;
        const metode = document.getElementById('metodeBayar').value;
        
        if (!jumlah || parseInt(jumlah) < 10000) {
            this.showToast('Jumlah setoran minimal Rp 10,000', 'error');
            return;
        }
        
        const jenisNama = {
            'pokok': 'Simpanan Pokok',
            'wajib': 'Simpanan Wajib',
            'sukarela': 'Simpanan Sukarela'
        }[jenisSimpanan] || 'Simpanan';
        
        const completeData = this.getCompleteAnggotaData();
        
        const message = `*PENGAJUAN SETOR SIMPANAN* #koperasijenius\n\n` +
                       `üë§ *Nama:* ${completeData.nama}\n` +
                       `üÜî *NIA:* ${completeData.nia || 'N/A'}\n` +
                       `üìß *Email:* ${this.currentUser.email}\n` +
                       `üìû *WhatsApp:* ${completeData.telepon || completeData.whatsapp || '-'}\n` +
                       `---\n` +
                       `üí∞ *Jenis Simpanan:* ${jenisNama}\n` +
                       `üíµ *Jumlah:* Rp ${parseInt(jumlah).toLocaleString('id-ID')}\n` +
                       `üí≥ *Metode Bayar:* ${metode}\n` +
                       `üìÖ *Tanggal:* ${new Date().toLocaleDateString('id-ID')}\n` +
                       `‚è∞ *Waktu:* ${new Date().toLocaleTimeString('id-ID')}\n\n` +
                       `_Pengajuan ini dikirim via Buku Tabungan Digital Firebase_`;
        
        const adminWhatsApp = '6285218483129';
        const whatsappUrl = `https://wa.me/${adminWhatsApp}?text=${encodeURIComponent(message)}`;
        
        this.savePengajuanHistory({
            jenis: 'Setor Simpanan',
            jumlah: parseInt(jumlah),
            jenisSimpanan: jenisNama,
            metode: metode,
            tanggal: new Date().toISOString(),
            status: 'Menunggu Konfirmasi Admin'
        });
        
        this.closeModal();
        
        const confirmHtml = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; color: #25D366; margin-bottom: 15px;">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    Pengajuan Berhasil Disimpan!
                </h4>
                <p style="color: var(--text-secondary); margin-bottom: 20px; padding: 0 10px;">
                    Pengajuan setoran Anda telah disimpan. Silakan hubungi Admin untuk konfirmasi lebih lanjut.
                </p>
                
                <div style="background: #f0f7f0; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <p style="color: var(--primary); margin: 0 0 10px 0; font-weight: 500;">
                        <i class="fas fa-user-tie"></i> Admin Koperasi
                    </p>
                    <p style="color: var(--text-primary); margin: 0; font-size: 1.1rem;">
                        <i class="fab fa-whatsapp" style="color: #25D366;"></i> 62852-1848-3129
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button type="button" class="modal-btn secondary" onclick="app.closeModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                    <button type="button" class="modal-btn primary" 
                            onclick="window.open('${whatsappUrl}', '_blank'); app.closeModal()" 
                            style="flex: 1; background: #25D366; border-color: #25D366;">
                        <i class="fab fa-whatsapp"></i> WhatsApp Admin
                    </button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            this.showModal('Konfirmasi Pengajuan Setoran', confirmHtml);
        }, 500);
        
        window.pushNotificationSystem.showNotification(
            'Pengajuan Setoran',
            'Pengajuan setoran Anda telah dikirim ke admin.',
            'info',
            false
        );
    }
    
    showPinjamModal() {
        const completeData = this.getCompleteAnggotaData();
        
        const html = `
            <div style="padding: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 20px;">Ajukan Pinjaman</h4>
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: #f57c00; margin: 0 0 10px 0;">
                        <i class="fas fa-info-circle"></i> Status Pinjaman Anda (Firebase):
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <small>Total Pinjaman</small>
                            <p style="margin: 5px 0; font-weight: bold; color: green;">
                                ${AdminDataExtractor.formatRupiah(completeData.totalPinjaman || 0)}
                            </p>
                        </div>
                        <div>
                            <small>Simpanan Saat Ini</small>
                            <p style="margin: 5px 0; font-weight: 500; color: var(--primary);">
                                ${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}
                            </p>
                        </div>
                    </div>
                    ${this.firebaseUserData ? 
                        `<p style="font-size: 0.8rem; color: #4CAF50; margin-top: 10px; text-align: center;">
                            <i class="fas fa-fire"></i> Data real-time dari Firebase
                        </p>` : ''
                    }
                </div>
                
                <form id="pinjamForm">
                    <div class="form-group">
                        <label class="form-label">Jumlah Pinjaman (Rp)</label>
                        <input type="number" class="form-control" id="jumlahPinjam" min="50000" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tujuan Pinjaman</label>
                        <input type="text" class="form-control" id="tujuanPinjam" placeholder="Contoh: Modal usaha" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Tenor (Bulan)</label>
                        <select class="form-control" id="tenorPinjam">
                            <option value="6">6 Bulan</option>
                            <option value="12">12 Bulan</option>
                            <option value="24">24 Bulan</option>
                        </select>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="modal-btn secondary" id="cancelPinjam">Batal</button>
                        <button type="submit" class="modal-btn primary" id="submitPinjam">Ajukan Pinjaman</button>
                    </div>
                </form>
            </div>
        `;
        
        this.showModal('Ajukan Pinjaman', html);
        
        document.getElementById('pinjamForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitPinjaman();
        });
        
        document.getElementById('cancelPinjam').addEventListener('click', () => {
            this.closeModal();
        });
    }
    
    submitPinjaman() {
        const jumlah = document.getElementById('jumlahPinjam').value;
        const tujuan = document.getElementById('tujuanPinjam').value;
        const tenor = document.getElementById('tenorPinjam').value;
        
        if (!jumlah || parseInt(jumlah) < 50000) {
            this.showToast('Jumlah pinjaman minimal Rp 50,000', 'error');
            return;
        }
        
        if (!tujuan) {
            this.showToast('Tujuan pinjaman harus diisi', 'error');
            return;
        }
        
        const completeData = this.getCompleteAnggotaData();
        
        const message = `*PENGAJUAN PINJAMAN* #koperasijenius\n\n` +
                       `üë§ *Nama:* ${completeData.nama}\n` +
                       `üÜî *NIA:* ${completeData.nia || 'N/A'}\n` +
                       `üìß *Email:* ${this.currentUser.email}\n` +
                       `üìû *WhatsApp:* ${completeData.telepon || completeData.whatsapp || '-'}\n` +
                       `---\n` +
                       `üíµ *Jumlah Pinjaman:* Rp ${parseInt(jumlah).toLocaleString('id-ID')}\n` +
                       `üéØ *Tujuan:* ${tujuan}\n` +
                       `üìÖ *Tenor:* ${tenor} Bulan\n` +
                       `üí∞ *Simpanan Saat Ini:* Rp ${(completeData.totalSimpanan || 0).toLocaleString('id-ID')}\n` +
                       `üìÖ *Tanggal:* ${new Date().toLocaleDateString('id-ID')}\n` +
                       `‚è∞ *Waktu:* ${new Date().toLocaleTimeString('id-ID')}\n\n` +
                       `_Pengajuan ini dikirim via Buku Tabungan Digital Firebase_`;
        
        const adminWhatsApp = '6285218483129';
        const whatsappUrl = `https://wa.me/${adminWhatsApp}?text=${encodeURIComponent(message)}`;
        
        this.savePengajuanHistory({
            jenis: 'Pinjaman',
            jumlah: parseInt(jumlah),
            tujuan: tujuan,
            tenor: tenor + ' Bulan',
            tanggal: new Date().toISOString(),
            status: 'Menunggu Konfirmasi Admin'
        });
        
        this.closeModal();
        
        const confirmHtml = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; color: #25D366; margin-bottom: 15px;">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    Pengajuan Pinjaman Berhasil!
                </h4>
                <p style="color: var(--text-secondary); margin-bottom: 20px; padding: 0 10px;">
                    Pengajuan pinjaman Anda telah disimpan. Silakan hubungi Admin untuk konfirmasi lebih lanjut.
                </p>
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <p style="color: #f57c00; margin: 0 0 10px 0; font-weight: 500;">
                        <i class="fas fa-user-tie"></i> Admin Koperasi
                    </p>
                    <p style="color: var(--text-primary); margin: 0; font-size: 1.1rem;">
                        <i class="fab fa-whatsapp" style="color: #25D366;"></i> 62852-1848-3129
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button type="button" class="modal-btn secondary" onclick="app.closeModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                    <button type="button" class="modal-btn primary" 
                            onclick="window.open('${whatsappUrl}', '_blank'); app.closeModal()" 
                            style="flex: 1; background: #25D366; border-color: #25D366;">
                        <i class="fab fa-whatsapp"></i> WhatsApp Admin
                    </button>
                </div>
            </div>
        `;
        
        setTimeout(() => {
            this.showModal('Konfirmasi Pengajuan Pinjaman', confirmHtml);
        }, 500);
        
        window.pushNotificationSystem.showNotification(
            'Pengajuan Pinjaman',
            'Pengajuan pinjaman Anda telah dikirim ke admin.',
            'info',
            false
        );
    }
    
    savePengajuanHistory(pengajuan) {
        try {
            const riwayat = JSON.parse(localStorage.getItem('pengajuan_riwayat') || '[]');
            pengajuan.id = Date.now();
            pengajuan.userEmail = this.currentUser.email;
            pengajuan.userName = this.userData.nama;
            riwayat.unshift(pengajuan);
            
            if (riwayat.length > 50) {
                riwayat.length = 50;
            }
            
            localStorage.setItem('pengajuan_riwayat', JSON.stringify(riwayat));
            console.log('‚úÖ Pengajuan disimpan:', pengajuan);
        } catch (error) {
            console.error('Error saving pengajuan:', error);
        }
    }
    
    showRiwayatModal() {
        const riwayat = this.userData.riwayatTransaksi || [];
        
        let riwayatHtml = '';
        if (riwayat.length > 0) {
            riwayatHtml = `
                <div class="form-group" style="margin-bottom: 15px;">
                    <input type="text" class="form-control" id="searchRiwayat" 
                           placeholder="Cari riwayat transaksi...">
                </div>
                <div id="riwayatList" style="max-height: 300px; overflow-y: auto;">
            `;
            
            riwayatHtml += riwayat.map(t => `
                <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong style="color: var(--primary);">${t.jenis || 'Transaksi'}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${t.tanggal ? new Date(t.tanggal).toLocaleDateString('id-ID') : ''}
                                ${t.deskripsi ? ` ‚Ä¢ ${t.deskripsi}` : ''}
                            </div>
                            ${t.catatan ? `<div style="font-size: 0.85rem; color: #888; margin-top: 5px; font-style: italic;">${t.catatan}</div>` : ''}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: ${t.tipe === 'pemasukan' ? 'green' : '#c62828'};">
                                ${t.tipe === 'pemasukan' ? '+' : '-'}${AdminDataExtractor.formatRupiah(t.nominal || 0)}
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                                ${t.status || 'Selesai'}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            riwayatHtml += '</div>';
        } else {
            riwayatHtml = `
                <div style="text-align: center; padding: 40px 20px; color: #666;">
                    <i class="fas fa-history" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                    <p>Belum ada riwayat transaksi</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        Riwayat transaksi akan muncul setelah admin memproses transaksi Anda
                    </p>
                </div>
            `;
        }
        
        const html = `
            <div style="padding: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-history"></i> RIWAYAT TRANSAKSI
                </h4>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <strong>Total Transaksi:</strong> ${riwayat.length}
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            Update: ${new Date(this.userData.lastUpdated).toLocaleDateString('id-ID')}
                        </div>
                    </div>
                    
                    ${riwayatHtml}
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px;">
                    <p style="color: #1976d2; margin: 0; font-size: 0.9rem;">
                        <i class="fas fa-fire" style="color: #FFA000;"></i> 
                        Data keuangan real-time dari Firebase Firestore
                    </p>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="modal-btn primary" id="closeRiwayatBtn">Tutup</button>
                </div>
            </div>
        `;
        
        this.showModal('Riwayat Transaksi', html);
        
        const searchInput = document.getElementById('searchRiwayat');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const items = document.querySelectorAll('#riwayatList > div');
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            });
        }
        
        document.getElementById('closeRiwayatBtn').addEventListener('click', () => {
            this.closeModal();
        });
    }
    
    forceSync() {
        if (this.isSyncing) return;
        
        this.isSyncing = true;
        this.updateSyncButton('syncing');
        this.showToast('Menyinkronkan data dengan Firebase...', 'info');
        
        if (this.syncTimeout) {
            clearTimeout(this.syncTimeout);
        }
        
        this.syncTimeout = setTimeout(async () => {
            try {
                if (!this.firebaseReady || !window.KoperasiDB) {
                    console.log('üîÑ Mencoba reconnect Firebase...');
                    await this.initializeFirebaseWithRetry();
                }
                
                await this.loadFirebaseData();
                this.loadData();
                
                this.showToast('Data berhasil disinkronkan!', 'success');
                this.updateSyncButton('success');
                
                window.pushNotificationSystem.showNotification(
                    'Firebase Sync Berhasil',
                    'Data keuangan telah diperbarui',
                    'success',
                    false
                );
                
            } catch (error) {
                console.error('Sync error:', error);
                this.showToast('Gagal sinkronisasi: ' + error.message, 'error');
                this.updateSyncButton('error');
            }
            
            setTimeout(() => {
                this.updateSyncButton('normal');
                this.isSyncing = false;
            }, 2000);
        }, 500);
    }
    
    updateSyncButton(state) {
        const syncBtn = document.getElementById('manualSyncButton');
        if (!syncBtn) return;
        
        syncBtn.className = 'sync-button';
        
        switch(state) {
            case 'normal':
                syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Firebase';
                break;
                
            case 'syncing':
                syncBtn.classList.add('syncing');
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                break;
                
            case 'success':
                syncBtn.classList.add('success');
                syncBtn.innerHTML = '<i class="fas fa-check"></i> Synced!';
                break;
                
            case 'error':
                syncBtn.classList.add('error');
                syncBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                break;
        }
    }
    
    resetSessionTimeout() {
        if (this.sessionTimeout) {
            clearTimeout(this.sessionTimeout);
        }
        
        this.sessionTimeout = setTimeout(() => {
            this.showToast('Sesi akan berakhir, silakan login kembali', 'warning');
            setTimeout(() => {
                window.location.href = 'login-register.html';
            }, 5000);
        }, 30 * 60 * 1000);
    }
    
    backupData() {
        localStorage.setItem(`backup_${this.currentUser.email}`, 
            JSON.stringify({
                data: this.userData,
                firebaseData: this.firebaseUserData,
                timestamp: new Date().toISOString()
            })
        );
    }
    
    showPasswordModal() {
        document.getElementById('passwordModal').classList.add('active');
        document.getElementById('currentPassword').focus();
    }
    
    closePasswordModal() {
        document.getElementById('passwordModal').classList.remove('active');
        document.getElementById('changePasswordForm').reset();
    }
    
    async changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        const users = JSON.parse(localStorage.getItem('koperasi_users') || '[]');
        const currentUser = users.find(u => u.email === this.currentUser.email);
        
        if (!currentUser || currentUser.password !== currentPassword) {
            this.showToast('Password saat ini salah', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            this.showToast('Konfirmasi password tidak cocok', 'error');
            return;
        }
        
        if (newPassword.length < 6) {
            this.showToast('Password minimal 6 karakter', 'error');
            return;
        }
        
        try {
            if (window.KoperasiDB && window.KoperasiDB.updatePassword) {
                await window.KoperasiDB.updatePassword(currentPassword, newPassword);
                console.log('‚úÖ Password updated in Firebase');
            }
            
            currentUser.password = newPassword;
            const userIndex = users.findIndex(u => u.email === this.currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('koperasi_users', JSON.stringify(users));
            }
            
            this.currentUser = currentUser;
            localStorage.setItem('koperasi_current_user', JSON.stringify(this.currentUser));
            
            this.userData.password = newPassword;
            
            this.closePasswordModal();
            this.showToast('Password berhasil diubah', 'success');
            
            window.pushNotificationSystem.showNotification(
                'Password Diubah',
                'Password Anda telah berhasil diubah.',
                'success',
                false
            );
            
        } catch (error) {
            console.error('Error changing password:', error);
            this.showToast('Gagal mengubah password: ' + error.message, 'error');
        }
    }
    
    initHologramSystem() {
        setTimeout(() => {
            this.hologramSystem = new HologramStaticSystem();
        }, 1000);
    }
}

// ===== SISTEM-SISTEM LAINNYA =====
class HologramStaticSystem {
    constructor() {
        this.currentUser = null;
        this.data = null;
        this.updateInterval = null;
        this.init();
    }
    
    init() {
        console.log('üåü Initializing Hologram Static Card System...');
        
        this.resetData();
        
        try {
            this.currentUser = JSON.parse(localStorage.getItem('koperasi_current_user') || 'null');
        } catch (error) {
            console.error('Error getting current user:', error);
        }
        
        this.loadData();
        this.setupEventListeners();
        this.startAutoRefresh();
        
        console.log('‚úÖ Hologram Static Card System Ready');
    }
    
    resetData() {
        this.data = {
            totalSimpanan: 0,
            totalPinjaman: 0,
            shuEstimasi: 0,
            statusAnggota: 'Aktif',
            lastUpdated: new Date().toISOString()
        };
        
        console.log('üîÑ Data hologram direset');
    }
    
    async loadData() {
        try {
            if (window.app && window.app.firebaseUserData) {
                const firebaseData = window.app.firebaseUserData;
                
                this.data = {
                    totalSimpanan: firebaseData.total_simpanan || 0,
                    totalPinjaman: firebaseData.total_pinjaman || 0,
                    shuEstimasi: firebaseData.shu || 0,
                    statusAnggota: firebaseData.status || 'AKTIF',
                    lastUpdated: firebaseData.last_update || new Date().toISOString()
                };
                
                console.log('‚úÖ Hologram data loaded from Firebase:', this.data);
            } else {
                const adminData = localStorage.getItem('koperasi_anggota');
                const tabunganData = localStorage.getItem('tabunganDigitalUsers');
                
                if (!adminData && !tabunganData) {
                    this.data = {
                        totalSimpanan: 0,
                        totalPinjaman: 0,
                        shuEstimasi: 0,
                        statusAnggota: 'Aktif',
                        lastUpdated: new Date().toISOString()
                    };
                    this.updateUI();
                    return;
                }
                
                const anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
                const currentUserEmail = this.currentUser?.email;
                
                let userData = null;
                
                if (currentUserEmail && anggotaData.length > 0) {
                    userData = anggotaData.find(a => a.email === currentUserEmail);
                }
                
                if (!userData) {
                    userData = await this.getTabunganUserData();
                }
                
                let totalSimpanan = 0;
                let totalPinjaman = 0;
                let shuEstimasi = 0;
                let statusAnggota = 'Aktif';
                
                if (userData) {
                    totalSimpanan = userData.totalSimpanan || 0;
                    totalPinjaman = userData.totalPinjaman || 0;
                    shuEstimasi = userData.shuEstimasi || 0;
                    statusAnggota = userData?.statusAktif || userData?.status || 'Aktif';
                }
                
                this.data = {
                    totalSimpanan,
                    totalPinjaman,
                    shuEstimasi,
                    statusAnggota,
                    lastUpdated: userData?.lastUpdated || new Date().toISOString()
                };
                
                console.log('‚úÖ Hologram data loaded from local:', this.data);
            }
            
            this.updateUI();
            
        } catch (error) {
            console.error('‚ùå Error loading hologram data:', error);
            this.showFallbackData();
        }
    }
    
    async getTabunganUserData() {
        try {
            const tabunganUsers = JSON.parse(localStorage.getItem('tabunganDigitalUsers') || '[]');
            const currentUserEmail = this.currentUser?.email;
            
            if (currentUserEmail && tabunganUsers.length > 0) {
                return tabunganUsers.find(u => u.email === currentUserEmail);
            }
            
            return null;
        } catch (error) {
            return null;
        }
    }
    
    updateUI() {
        if (!this.data) return;
        
        const formatRupiah = (amount) => {
            if (!amount && amount !== 0) return 'Rp 0';
            return 'Rp ' + amount.toLocaleString('id-ID');
        };
        
        const totalSimpananElement = document.getElementById('hologramTotalSimpanan');
        if (totalSimpananElement) {
            totalSimpananElement.textContent = formatRupiah(this.data.totalSimpanan);
        }
        
        const totalPinjamanElement = document.getElementById('hologramTotalPinjaman');
        if (totalPinjamanElement) {
            totalPinjamanElement.textContent = formatRupiah(this.data.totalPinjaman);
        }
        
        const shuEstimasiElement = document.getElementById('hologramSHUEstimasi');
        if (shuEstimasiElement) {
            shuEstimasiElement.textContent = formatRupiah(this.data.shuEstimasi);
        }
        
        const statusAnggotaElement = document.getElementById('hologramStatusAnggota');
        if (statusAnggotaElement) {
            statusAnggotaElement.textContent = this.data.statusAnggota;
            
            if (this.data.statusAnggota === 'Aktif' || this.data.statusAnggota === 'AKTIF') {
                statusAnggotaElement.style.color = '#2e7d32';
            } else {
                statusAnggotaElement.style.color = '#f44336';
            }
        }
        
        const updateElement = document.getElementById('hologramUpdateTime');
        if (updateElement) {
            const now = new Date();
            updateElement.innerHTML = `
                <i class="fas fa-clock"></i>
                Update: ${now.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                })}
            `;
        }
    }
    
    showFallbackData() {
        this.data = {
            totalSimpanan: 0,
            totalPinjaman: 0,
            shuEstimasi: 0,
            statusAnggota: 'Aktif',
            lastUpdated: new Date().toISOString()
        };
        
        this.updateUI();
        
        const updateElement = document.getElementById('hologramUpdateTime');
        if (updateElement) {
            const now = new Date();
            updateElement.innerHTML = `
                <i class="fas fa-clock"></i>
                Inisialisasi: ${now.toLocaleTimeString('id-ID')}
            `;
        }
    }
    
    setupEventListeners() {
        const hologramCard = document.getElementById('hologramStaticCard');
        if (hologramCard) {
            hologramCard.addEventListener('click', () => {
                this.showDetailModal();
            });
        }
        
        this.setupModalListeners();
        
        window.addEventListener('koperasiDataUpdated', (e) => {
            console.log('üîÑ Data diperbarui dari Firebase');
            this.loadData();
            this.showNotification('Data keuangan Firebase diperbarui!', 'success');
        });
        
        window.addEventListener('sync-data-updated', () => {
            console.log('üîÑ Sync update received, refreshing hologram data...');
            this.loadData();
        });
    }
    
    setupModalListeners() {
        const closeBtn = document.getElementById('closeHologramDetail');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closeDetailModal();
            });
        }
        
        const closeDetailBtn = document.getElementById('closeDetailBtn');
        if (closeDetailBtn) {
            closeDetailBtn.addEventListener('click', () => {
                this.closeDetailModal();
            });
        }
        
        const printBtn = document.getElementById('printHologramDetailBtn');
        if (printBtn) {
            printBtn.addEventListener('click', () => {
                this.printDetail();
            });
        }
        
        const modalOverlay = document.getElementById('hologramDetailModal');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    this.closeDetailModal();
                }
            });
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
                this.closeDetailModal();
            }
        });
    }
    
    showDetailModal() {
        if (!this.data) return;
        
        const formatRupiah = (amount) => {
            if (!amount && amount !== 0) return 'Rp 0';
            return 'Rp ' + amount.toLocaleString('id-ID');
        };
        
        const saldoBersih = this.data.totalSimpanan - this.data.totalPinjaman;
        const anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
        const currentUserEmail = this.currentUser?.email;
        const userData = anggotaData.find(a => a.email === currentUserEmail);
        
        const detailHTML = `
            <div class="hologram-card">
                <div class="hologram-header">
                    <h3><i class="fas fa-chart-line"></i> DETAIL RINGKASAN KEUANGAN FIREBASE</h3>
                    <p>Koperasi Asmara Tani - #koperasijenius</p>
                </div>
                
                <div class="hologram-grid">
                    <!-- User Info -->
                    <div class="hologram-item full-width">
                        <div class="hologram-label">
                            <i class="fas fa-user-circle"></i>
                            Informasi Anggota
                        </div>
                        <div class="hologram-value">${this.currentUser?.name || 'Anggota Koperasi Asmara Tani'}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 8px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                            <span><i class="fas fa-id-card"></i> ${userData?.nia || userData?.id || 'N/A'}</span>
                            <span><i class="fas fa-briefcase"></i> ${userData?.posisi || 'Anggota'}</span>
                            <span><i class="fas fa-envelope"></i> ${this.currentUser?.email || ''}</span>
                        </div>
                    </div>
                    
                    <!-- Simpanan Breakdown -->
                    <div class="hologram-item">
                        <div class="hologram-label">
                            <i class="fas fa-landmark"></i>
                            Simpanan Pokok
                        </div>
                        <div class="hologram-value rp">${formatRupiah(this.data.simpananPokok || 0)}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">
                            <i class="fas fa-check-circle" style="color: #4CAF50;"></i> Dibayar sekali
                        </div>
                    </div>
                    
                    <div class="hologram-item">
                        <div class="hologram-label">
                            <i class="fas fa-calendar-check"></i>
                            Simpanan Wajib
                        </div>
                        <div class="hologram-value rp">${formatRupiah(this.data.simpananWajib || 0)}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">
                            <i class="fas fa-sync-alt" style="color: #FF9800;"></i> Rutin bulanan
                        </div>
                    </div>
                    
                    <div class="hologram-item">
                        <div class="hologram-label">
                            <i class="fas fa-hand-holding-heart"></i>
                            Simpanan Sukarela
                        </div>
                        <div class="hologram-value rp">${formatRupiah(this.data.simpananSukarela || 0)}</div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">
                            <i class="fas fa-heart" style="color: #E91E63;"></i> Opsional
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div class="hologram-item full-width">
                        <div class="hologram-label">
                            <i class="fas fa-hand-holding-usd"></i>
                            Total Simpanan
                        </div>
                        <div class="hologram-value rp" style="font-size: 1.8rem; color: #0d4014;">
                            ${formatRupiah(this.data.totalSimpanan)}
                        </div>
                        <div style="height: 3px; background: linear-gradient(90deg, #4CAF50, #2e7d32, #1a5f23); border-radius: 2px; margin-top: 10px;"></div>
                    </div>
                    
                    <div class="hologram-item">
                        <div class="hologram-label">
                            <i class="fas fa-file-invoice-dollar"></i>
                            Total Pinjaman
                        </div>
                        <div class="hologram-value rp" style="color: green">
                            ${formatRupiah(this.data.totalPinjaman)}
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">
                            <i class="fas fa-check-circle" 
                               style="color: #4CAF50"></i>
                            Tidak ada pinjaman
                        </div>
                    </div>
                    
                    <div class="hologram-item">
                        <div class="hologram-label">
                            <i class="fas fa-calculator"></i>
                            SHU Estimasi
                        </div>
                        <div class="hologram-value rp" style="color: #2196F3;">
                            ${formatRupiah(this.data.shuEstimasi)}
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">
                            <i class="fas fa-chart-line" style="color: #2196F3;"></i> 20% dari simpanan
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="hologram-item">
                        <div class="hologram-label">
                            <i class="fas fa-user-check"></i>
                            Status Keanggotaan
                        </div>
                        <div class="hologram-status ${this.data.statusAnggota === 'Aktif' || this.data.statusAnggota === 'AKTIF' ? 'status-aktif' : 'status-tidak-aktif'}">
                            ${this.data.statusAnggota}
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 5px;">
                            <i class="fas fa-badge-check"></i> ${this.data.statusAnggota === 'Aktif' || this.data.statusAnggota === 'AKTIF' ? 'Akses penuh' : 'Terbatas'}
                        </div>
                    </div>
                    
                    <!-- Saldo Bersih -->
                    <div class="hologram-item full-width">
                        <div class="hologram-label">
                            <i class="fas fa-scale-balanced"></i>
                            Saldo Bersih (Estimasi)
                        </div>
                        <div class="hologram-value rp" style="font-size: 1.6rem; color: green;">
                            ${formatRupiah(saldoBersih)}
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px; text-align: center;">
                            Simpanan (${formatRupiah(this.data.totalSimpanan)}) - Pinjaman (${formatRupiah(this.data.totalPinjaman)}) = Saldo Bersih
                        </div>
                    </div>
                </div>
                
                <div class="hologram-footer">
                    <p>
                        <i class="fas fa-fire" style="color: #FFA000;"></i> 
                        Sumber data: ${window.app && window.app.firebaseUserData ? 'Firebase Firestore' : 'Data Lokal'}
                    </p>
                    <p>
                        <i class="fas fa-clock"></i> 
                        Update terakhir: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}
                    </p>
                    <p style="font-size: 0.75rem; margin-top: 10px; color: rgba(13, 64, 20, 0.6);">
                        *Data ini diperbarui otomatis dari Firebase Firestore
                    </p>
                </div>
            </div>
        `;
        
        document.getElementById('hologramDetailContent').innerHTML = detailHTML;
        document.getElementById('hologramDetailModal').classList.add('active');
        
        document.body.style.overflow = 'hidden';
    }
    
    closeDetailModal() {
        document.getElementById('hologramDetailModal').classList.remove('active');
        document.body.style.overflow = '';
    }
    
    printDetail() {
        const detailContent = document.querySelector('.hologram-card');
        if (!detailContent) return;
        
        try {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Kartu Ringkasan Keuangan - Koperasi Asmara Tani</title>
                    <meta charset="UTF-8">
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0;
                            padding: 20px;
                            background: #f5f5f5;
                        }
                        
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                                background: white;
                            }
                            @page {
                                size: A4;
                                margin: 15mm;
                            }
                        }
                        
                        .print-container {
                            background: white;
                            border: 3px solid #1a5f23;
                            border-radius: 20px;
                            padding: 30px;
                            max-width: 700px;
                            margin: 0 auto;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                        }
                        
                        .watermark {
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(-45deg);
                            opacity: 0.05;
                            font-size: 120px;
                            color: #1a5f23;
                            font-weight: bold;
                            z-index: -1;
                        }
                    </style>
                </head>
                <body>
                    <div class="watermark">KOPERASI ASMARA TANI</div>
                    <div class="print-container">
                        ${detailContent.outerHTML}
                    </div>
                    <script>
                        window.onload = function() {
                            setTimeout(() => {
                                window.print();
                                setTimeout(() => {
                                    window.close();
                                }, 500);
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
            
            window.pushNotificationSystem.showNotification('Mencetak Data', 'Membuka jendela cetak...', 'info', false);
            
        } catch (error) {
            console.error('Error printing:', error);
            window.app.showToast('Gagal mencetak. Silakan coba lagi.', 'error');
        }
    }
    
    showNotification(message, type = 'info') {
        if (window.pushNotificationSystem) {
            window.pushNotificationSystem.showNotification('Hologram System', message, type, false);
        }
    }
    
    startAutoRefresh() {
        this.updateInterval = setInterval(() => {
            this.loadData();
        }, 10000);
        
        window.addEventListener('storage', (e) => {
            if (e.key === 'koperasi_anggota' || e.key === 'koperasiData') {
                console.log('üîÑ Storage change detected, refreshing hologram data');
                this.loadData();
                this.showNotification('Data diperbarui!', 'success');
            }
        });
        
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.loadData();
            }
        });
    }
    
    destroy() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
        }
    }
}

class MenuVoiceSystem {
    constructor() {
        this.speechSynthesis = window.speechSynthesis;
        this.isSpeaking = false;
        this.voiceEnabled = 'speechSynthesis' in window;
        this.currentVoice = null;
        this.init();
    }

    init() {
        if (!this.voiceEnabled) {
            console.warn('‚ö†Ô∏è Browser tidak mendukung Text-to-Speech');
            return;
        }
        
        setTimeout(() => {
            this.setupVoices();
            this.setupAllVoiceListeners();
            console.log('üîä Menu Voice System Ready');
        }, 1000);
    }

    setupVoices() {
        const voices = this.speechSynthesis.getVoices();
        this.currentVoice = voices.find(voice => 
            voice.lang.includes('id') || 
            voice.name.includes('Indonesia') ||
            voice.name.includes('Indonesian')
        ) || voices[0];
    }

    setupAllVoiceListeners() {
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const text = e.currentTarget.querySelector('.menu-text').textContent;
                this.speakButton(text);
            });
        });

        document.querySelectorAll('.btn').forEach(button => {
            button.addEventListener('click', () => {
                const buttonText = button.textContent.trim();
                this.speakButton(buttonText);
            });
        });

        document.getElementById('hologramStaticCard')?.addEventListener('click', () => {
            this.speakCard("Ringkasan Keuangan Firebase");
        });

        document.getElementById('hologramVoiceBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            this.speakButton("Baca Data Keuangan Firebase");
        });

        this.speechSynthesis.onend = () => {
            this.isSpeaking = false;
        };
    }

    speak(text, rate = 0.9, pitch = 1.0) {
        if (!this.voiceEnabled || this.isSpeaking) return;
        
        this.isSpeaking = true;
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'id-ID';
        utterance.rate = rate;
        utterance.pitch = pitch;
        utterance.volume = 1.0;
        
        if (this.currentVoice) {
            utterance.voice = this.currentVoice;
        }
        
        this.speechSynthesis.speak(utterance);
    }

    speakButton(buttonName) {
        const text = `Tombol ${buttonName}`;
        this.speak(text);
    }

    speakCard(cardName) {
        const text = `Kartu ${cardName}`;
        this.speak(text);
    }
}

class PushNotificationSystem {
    constructor() {
        this.notificationPermission = 'default';
        this.notificationQueue = [];
        this.notificationSound = null;
        this.unreadCount = 0;
        this.init();
    }

    init() {
        console.log('üîî Initializing Push Notification System...');
        
        this.setupNotificationSound();
        this.checkPermission();
        this.setupEventListeners();
        this.loadNotifications();
        this.startQueueProcessor();
        
        console.log('‚úÖ Push Notification System Ready');
    }

    setupNotificationSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.notificationSound = audioContext;
        } catch (e) {
            console.warn('‚ö†Ô∏è Audio not supported');
        }
    }

    checkPermission() {
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                this.notificationPermission = permission;
                console.log('üîî Notification permission:', permission);
            });
        }
    }

    setupEventListeners() {
        window.addEventListener('admin-data-updated', (e) => {
            this.showNotification(
                'Firebase Data Updated', 
                'Data keuangan telah diperbarui dari Firebase.', 
                'warning',
                true
            );
        });

        const notificationToggle = document.getElementById('notificationToggle');
        const notificationPanel = document.getElementById('notificationPanel');
        const notificationClear = document.getElementById('notificationClear');
        
        if (notificationToggle && notificationPanel) {
            notificationToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationPanel.classList.toggle('active');
                this.markAllAsRead();
            });
        }
        
        if (notificationClear) {
            notificationClear.addEventListener('click', () => {
                this.clearAllNotifications();
            });
        }

        document.addEventListener('click', (e) => {
            if (notificationPanel && notificationPanel.classList.contains('active')) {
                if (!notificationPanel.contains(e.target) && !notificationToggle.contains(e.target)) {
                    notificationPanel.classList.remove('active');
                }
            }
        });
    }

    loadNotifications() {
        try {
            const savedNotifications = localStorage.getItem('koperasi_notifications');
            if (savedNotifications) {
                this.notificationQueue = JSON.parse(savedNotifications);
                this.unreadCount = this.notificationQueue.filter(n => !n.read).length;
                this.updateNotificationUI();
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    saveNotifications() {
        try {
            localStorage.setItem('koperasi_notifications', JSON.stringify(this.notificationQueue));
        } catch (error) {
            console.error('Error saving notifications:', error);
        }
    }

    showNotification(title, message, type = 'info', playSound = false) {
        const notification = {
            id: Date.now(),
            title,
            message,
            type,
            timestamp: new Date(),
            read: false,
            fromAdmin: type === 'warning'
        };

        this.notificationQueue.unshift(notification);
        
        if (this.notificationQueue.length > 50) {
            this.notificationQueue.pop();
        }

        this.unreadCount++;
        this.saveNotifications();

        if (playSound && type === 'warning' && this.notificationSound) {
            this.playNotificationSound();
        }

        this.updateNotificationUI();
        this.showInAppNotification(notification);

        return notification;
    }

    playNotificationSound() {
        try {
            const context = this.notificationSound;
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, context.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.3);
            
            oscillator.start(context.currentTime);
            oscillator.stop(context.currentTime + 0.3);
        } catch (e) {
            console.warn('‚ö†Ô∏è Could not play notification sound');
        }
    }

    showInAppNotification(notification) {
        const notificationEl = document.createElement('div');
        notificationEl.className = `notification-item ${notification.read ? '' : 'unread'}`;
        notificationEl.dataset.id = notification.id;
        
        const timeAgo = this.getTimeAgo(notification.timestamp);
        
        notificationEl.innerHTML = `
            <div class="notification-title">
                <span>${notification.title}</span>
                <span class="notification-time">${timeAgo}</span>
            </div>
            <div class="notification-message">${notification.message}</div>
        `;
        
        notificationEl.addEventListener('click', () => {
            this.markAsRead(notification.id);
            notificationEl.classList.remove('unread');
        });
        
        const notificationBody = document.getElementById('notificationBody');
        if (notificationBody) {
            const emptyState = notificationBody.querySelector('div[style*="text-align: center"]');
            if (emptyState) {
                emptyState.remove();
            }
            
            notificationBody.insertBefore(notificationEl, notificationBody.firstChild);
        }
    }

    updateNotificationUI() {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.textContent = this.unreadCount;
            
            const toggleBtn = document.getElementById('notificationToggle');
            if (toggleBtn) {
                if (this.unreadCount > 0) {
                    toggleBtn.classList.add('has-notifications');
                } else {
                    toggleBtn.classList.remove('has-notifications');
                }
            }
        }
        
        this.updateNotificationPanel();
    }

    updateNotificationPanel() {
        const notificationBody = document.getElementById('notificationBody');
        if (!notificationBody) return;
        
        notificationBody.innerHTML = '';
        
        if (this.notificationQueue.length === 0) {
            notificationBody.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #666;">
                    <i class="fas fa-bell-slash" style="font-size: 48px; color: #ccc;"></i>
                    <p>Tidak ada notifikasi</p>
                    <p style="font-size: 0.9rem;">Notifikasi akan muncul di sini</p>
            </div>
            `;
            return;
        }
        
        this.notificationQueue.forEach(notification => {
            this.showInAppNotification(notification);
        });
    }

    markAsRead(id) {
        const notification = this.notificationQueue.find(n => n.id === id);
        if (notification && !notification.read) {
            notification.read = true;
            this.unreadCount--;
            this.saveNotifications();
            this.updateNotificationUI();
        }
    }

    markAllAsRead() {
        this.notificationQueue.forEach(notification => {
            if (!notification.read) {
                notification.read = true;
            }
        });
        this.unreadCount = 0;
        this.saveNotifications();
        this.updateNotificationUI();
    }

    clearAllNotifications() {
        this.notificationQueue = [];
        this.unreadCount = 0;
        this.saveNotifications();
        this.updateNotificationUI();
        
        window.app.showToast('Semua notifikasi telah dihapus', 'success');
    }

    getTimeAgo(timestamp) {
        const now = new Date();
        const past = new Date(timestamp);
        const diff = now - past;
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);
        
        if (minutes < 1) return 'Baru saja';
        if (minutes < 60) return `${minutes} menit lalu`;
        if (hours < 24) return `${hours} jam lalu`;
        if (days < 7) return `${days} hari lalu`;
        
        return past.toLocaleDateString('id-ID');
    }

    startQueueProcessor() {
        setInterval(() => {
            if (this.notificationQueue.length > 0) {
                this.updateNotificationUI();
            }
        }, 5000);
    }
}

class ARExperienceSystem {
    constructor() {
        this.isARActive = false;
        this.arScene = null;
        this.init();
    }

    init() {
        console.log('üï∂Ô∏è Initializing AR Experience System...');
        console.log('‚úÖ AR Experience System Ready');
    }

    showARExperience() {
        const completeData = window.app.getCompleteAnggotaData();
        
        const html = `
            <div style="padding: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-vr-cardboard"></i> AR Experience - Kartu Digital 3D
                </h4>
                
                <div style="background: #f0f7f0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p style="color: var(--primary); margin: 0 0 10px 0;">
                        <i class="fas fa-info-circle"></i> Cara menggunakan AR:
                    </p>
                    <ol style="margin: 0; padding-left: 20px; font-size: 0.9rem;">
                        <li>Izinkan akses kamera saat diminta</li>
                        <li>Arahkan kamera ke permukaan datar</li>
                        <li>Ketuk layar untuk menempatkan kartu digital</li>
                        <li>Geser untuk memutar dan zoom in/out</li>
                    </ol>
                </div>
                
                <div class="ar-container" id="arContainer">
                    <div class="ar-marker-notice">
                        <i class="fas fa-camera"></i> Arahkan kamera ke permukaan datar
                    </div>
                    <a-scene 
                        class="ar-scene"
                        embedded 
                        arjs="sourceType: webcam; debugUIEnabled: false;"
                        vr-mode-ui="enabled: false"
                        gesture-detector
                        id="gestureDetector">
                        
                        <!-- Marker-based AR (Hiro marker) -->
                        <a-marker type="pattern" preset="custom" url="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.patt">
                            <a-entity position="0 0 0" scale="0.05 0.05 0.05" rotation="0 0 0">
                                <!-- Kartu 3D -->
                                <a-plane 
                                    position="0 0 0" 
                                    width="1.5" 
                                    height="1" 
                                    color="#1a5f23"
                                    opacity="0.9"
                                    shader="flat">
                                </a-plane>
                                
                                <!-- Border kartu -->
                                <a-plane 
                                    position="0 0 0.001" 
                                    width="1.55" 
                                    height="1.05" 
                                    color="#0d4014"
                                    opacity="0.3">
                                </a-plane>
                                
                                <!-- Logo -->
                                <a-text 
                                    value="Koperasi Asmara Tani" 
                                    position="0 0.35 0.002" 
                                    align="center" 
                                    color="#FFFFFF" 
                                    width="1.4"
                                    scale="0.5 0.5 0.5">
                                </a-text>
                                
                                <!-- Nama -->
                                <a-text 
                                    value="${completeData.nama.substring(0, 20)}${completeData.nama.length > 20 ? '...' : ''}" 
                                    position="0 0.15 0.002" 
                                    align="center" 
                                    color="#FFFFFF" 
                                    width="1.4"
                                    scale="0.3 0.3 0.3">
                                </a-text>
                                
                                <!-- NIA -->
                                <a-text 
                                    value="NIA: ${completeData.nia || 'N/A'}" 
                                    position="-0.5 -0.1 0.002" 
                                    align="left" 
                                    color="#FFD700" 
                                    width="0.7"
                                    scale="0.2 0.2 0.2">
                                </a-text>
                                
                                <!-- Total Simpanan -->
                                <a-text 
                                    value="Simpanan: ${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}" 
                                    position="0.5 -0.1 0.002" 
                                    align="right" 
                                    color="#4CAF50" 
                                    width="0.7"
                                    scale="0.2 0.2 0.2">
                                </a-text>
                                
                                <!-- QR Code placeholder -->
                                <a-plane 
                                    position="0 -0.3 0.002" 
                                    width="0.3" 
                                    height="0.3" 
                                    color="#FFFFFF">
                                    <a-text 
                                        value="QR" 
                                        position="0 0 0.001" 
                                        align="center" 
                                        color="#1a5f23" 
                                        scale="0.5 0.5 0.5">
                                    </a-text>
                                </a-plane>
                            </a-entity>
                        </a-marker>
                        
                        <!-- Camera -->
                        <a-entity camera></a-entity>
                    </a-scene>
                    
                    <div class="ar-controls">
                        <button class="ar-control-btn" id="arRotateLeft">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="ar-control-btn" id="arRotateRight">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="ar-control-btn" id="arReset">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="ar-control-btn" id="arClose">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="color: #1976d2; margin: 0; font-size: 0.9rem; text-align: center;">
                        <i class="fas fa-mobile-alt"></i> 
                        Gunakan AR untuk melihat kartu anggota dalam bentuk 3D
                    </p>
                </div>
                
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div style="text-align: center;">
                        <button class="modal-btn secondary" id="arHelpBtn" style="width: 100%;">
                            <i class="fas fa-question-circle"></i> Bantuan
                        </button>
                    </div>
                    <div style="text-align: center;">
                        <button class="modal-btn primary" id="arCloseBtn" style="width: 100%;">
                            <i class="fas fa-times"></i> Tutup AR
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('arExperienceContent').innerHTML = html;
        document.getElementById('arExperienceModal').classList.add('active');
        
        this.setupARControls();
        
        if (window.menuVoiceSystem) {
            window.menuVoiceSystem.speak("Pengalaman Augmented Reality. Arahkan kamera Anda ke permukaan datar untuk melihat kartu digital dalam bentuk 3D.");
        }
    }

    setupARControls() {
        const arCloseBtn = document.getElementById('arCloseBtn');
        const arHelpBtn = document.getElementById('arHelpBtn');
        const closeARModal = document.getElementById('closeARModal');
        const arRotateLeft = document.getElementById('arRotateLeft');
        const arRotateRight = document.getElementById('arRotateRight');
        const arReset = document.getElementById('arReset');
        const arClose = document.getElementById('arClose');
        
        if (arCloseBtn) {
            arCloseBtn.addEventListener('click', () => {
                this.closeARExperience();
            });
        }
        
        if (arHelpBtn) {
            arHelpBtn.addEventListener('click', () => {
                this.showARHelp();
            });
        }
        
        if (closeARModal) {
            closeARModal.addEventListener('click', () => {
                this.closeARExperience();
            });
        }
        
        if (arRotateLeft) {
            arRotateLeft.addEventListener('click', () => {
                this.rotateModel(-15);
            });
        }
        
        if (arRotateRight) {
            arRotateRight.addEventListener('click', () => {
                this.rotateModel(15);
            });
        }
        
        if (arReset) {
            arReset.addEventListener('click', () => {
                this.resetModel();
            });
        }
        
        if (arClose) {
            arClose.addEventListener('click', () => {
                this.closeARExperience();
            });
        }
        
        const arModal = document.getElementById('arExperienceModal');
        if (arModal) {
            arModal.addEventListener('click', (e) => {
                if (e.target === arModal) {
                    this.closeARExperience();
                }
            });
        }
    }

    rotateModel(degrees) {
        const marker = document.querySelector('a-marker');
        if (marker) {
            const entity = marker.querySelector('a-entity');
            if (entity) {
                const currentRotation = entity.getAttribute('rotation');
                const newY = (currentRotation.y + degrees) % 360;
                entity.setAttribute('rotation', {
                    x: currentRotation.x,
                    y: newY,
                    z: currentRotation.z
                });
            }
        }
    }

    resetModel() {
        const marker = document.querySelector('a-marker');
        if (marker) {
            const entity = marker.querySelector('a-entity');
            if (entity) {
                entity.setAttribute('rotation', { x: 0, y: 0, z: 0 });
                entity.setAttribute('scale', '0.05 0.05 0.05');
            }
        }
    }

    showARHelp() {
        const helpHtml = `
            <div style="text-align: center; padding: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-question-circle"></i> Panduan AR Experience
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: #2196F3; margin-bottom: 5px;">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div style="font-size: 0.9rem; font-weight: 500;">Izinkan Kamera</div>
                    </div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: #4CAF50; margin-bottom: 5px;">
                            <i class="fas fa-search"></i>
                        </div>
                        <div style="font-size: 0.9rem; font-weight: 500;">Scan Permukaan</div>
                    </div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: #FF9800; margin-bottom: 5px;">
                            <i class="fas fa-hand-pointer"></i>
                        </div>
                        <div style="font-size: 0.9rem; font-weight: 500;">Ketuk untuk Tempatkan</div>
                    </div>
                    
                    <div style="text-align: center;">
                        <div style="font-size: 24px; color: #9C27B0; margin-bottom: 5px;">
                            <i class="fas fa-expand-alt"></i>
                        </div>
                        <div style="font-size: 0.9rem; font-weight: 500;">Geser untuk Zoom</div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">
                        <strong>Tips:</strong> Gunakan ruangan dengan pencahayaan yang baik. 
                        Pastikan permukaan datar tidak berkilau.
                    </p>
                </div>
                
                <button class="modal-btn primary" id="closeHelpBtn" style="width: 100%;">
                    <i class="fas fa-check"></i> Mengerti
                </button>
            </div>
        `;
        
        window.app.showModal('Panduan AR Experience', helpHtml);
        
        document.getElementById('closeHelpBtn').addEventListener('click', () => {
            window.app.closeModal();
        });
    }

    closeARExperience() {
        document.getElementById('arExperienceModal').classList.remove('active');
        document.getElementById('arExperienceContent').innerHTML = '';
        
        const scene = document.querySelector('a-scene');
        if (scene) {
            scene.parentNode.removeChild(scene);
        }
    }
}

class VoiceCommandSystem {
    constructor() {
        this.recognition = null;
        this.isListening = false;
        this.commands = [];
        this.init();
    }

    init() {
        console.log('üé§ Initializing Voice Command System...');
        
        this.setupCommands();
        this.setupSpeechRecognition();
        
        console.log('‚úÖ Voice Command System Ready');
    }

    setupCommands() {
        this.commands = [
            {
                keyword: 'buka profil',
                action: () => window.app.showEditProfileModal(),
                description: 'Membuka halaman edit profil'
            },
            {
                keyword: 'lihat simpanan',
                action: () => {
                    const card = document.querySelector('.hologram-static-card');
                    if (card) card.click();
                },
                description: 'Menampilkan ringkasan simpanan'
            },
            {
                keyword: 'setor uang',
                action: () => window.app.showSetorModal(),
                description: 'Membuka formulir setor simpanan'
            },
            {
                keyword: 'pinjam uang',
                action: () => window.app.showPinjamModal(),
                description: 'Membuka formulir pengajuan pinjaman'
            },
            {
                keyword: 'lihat kartu',
                action: () => window.app.showKartuModal(),
                description: 'Menampilkan kartu anggota digital'
            },
            {
                keyword: 'lihat riwayat',
                action: () => window.app.showRiwayatModal(),
                description: 'Menampilkan riwayat transaksi'
            },
            {
                keyword: 'buka qr',
                action: () => window.app.showQRModal(),
                description: 'Menampilkan QR Code'
            },
            {
                keyword: 'sinkronisasi',
                action: () => window.app.forceSync(),
                description: 'Melakukan sinkronisasi dengan Firebase'
            },
            {
                keyword: 'baca data',
                action: () => {
                    if (window.menuVoiceSystem) {
                        const completeData = window.app.getCompleteAnggotaData();
                        const message = `Halo ${completeData.nama}. Total simpanan Anda ${AdminDataExtractor.formatRupiah(completeData.totalSimpanan || 0)}. Total pinjaman ${AdminDataExtractor.formatRupiah(completeData.totalPinjaman || 0)}. Status keanggotaan ${completeData.status}.`;
                        window.menuVoiceSystem.speak(message);
                    }
                },
                description: 'Membacakan data keuangan Anda'
            },
            {
                keyword: 'tutup',
                action: () => {
                    const modal = document.querySelector('.modal-overlay.active');
                    if (modal) {
                        window.app.closeModal();
                    }
                },
                description: 'Menutup modal yang terbuka'
            },
            {
                keyword: 'bantuan',
                action: () => this.showVoiceCommandHelp(),
                description: 'Menampilkan daftar perintah suara'
            }
        ];
    }

    setupSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SpeechRecognition();
            
            this.recognition.lang = 'id-ID';
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
            this.recognition.maxAlternatives = 1;
            
            this.recognition.onstart = () => {
                this.isListening = true;
                this.updateVoiceButton(true);
                this.showListeningIndicator();
            };
            
            this.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                console.log('üé§ Speech recognized:', transcript);
                this.processCommand(transcript);
            };
            
            this.recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                this.isListening = false;
                this.updateVoiceButton(false);
                window.app.showToast('Gagal mengenali suara', 'error');
            };
            
            this.recognition.onend = () => {
                this.isListening = false;
                this.updateVoiceButton(false);
            };
        } else {
            console.warn('‚ö†Ô∏è Browser tidak mendukung Web Speech API');
        }
    }

    startListening() {
        if (!this.recognition) {
            window.app.showToast('Browser tidak mendukung perintah suara', 'error');
            return;
        }
        
        try {
            this.recognition.start();
        } catch (error) {
            console.error('Error starting speech recognition:', error);
        }
    }

    processCommand(transcript) {
        let commandExecuted = false;
        
        for (const command of this.commands) {
            if (transcript.includes(command.keyword.toLowerCase())) {
                command.action();
                commandExecuted = true;
                
                if (window.menuVoiceSystem) {
                    window.menuVoiceSystem.speak(`Melakukan perintah: ${command.description}`);
                }
                
                window.app.showToast(`Perintah: ${command.description}`, 'success');
                break;
            }
        }
        
        if (!commandExecuted) {
            if (window.menuVoiceSystem) {
                window.menuVoiceSystem.speak('Perintah tidak dikenali. Katakan bantuan untuk melihat daftar perintah.');
            }
            window.app.showToast('Perintah tidak dikenali', 'warning');
        }
    }

    updateVoiceButton(listening) {
        const voiceBtn = document.getElementById('voiceCommandBtn');
        if (voiceBtn) {
            if (listening) {
                voiceBtn.classList.add('listening');
                voiceBtn.innerHTML = '<i class="fas fa-microphone-alt"></i>';
            } else {
                voiceBtn.classList.remove('listening');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }
    }

    showListeningIndicator() {
        window.app.showToast('Mendengarkan... Katakan perintah Anda', 'info');
    }

    showVoiceCommandHelp() {
        const html = `
            <div style="padding: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-microphone-alt"></i> Voice Commands
                </h4>
                
                <div class="voice-listening-indicator" id="voiceListeningDemo">
                    <i class="fas fa-microphone-alt"></i>
                    <h5 style="margin: 10px 0;">Mendengarkan Perintah Suara...</h5>
                    <p style="margin: 0; font-size: 0.9rem;">Klik tombol mikrofon untuk mulai</p>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
                    <button class="modal-btn primary" id="startListeningBtn" style="flex: 1;">
                        <i class="fas fa-microphone"></i> Mulai Dengarkan
                    </button>
                    <button class="modal-btn secondary" id="stopListeningBtn" style="flex: 1;">
                        <i class="fas fa-stop"></i> Berhenti
                    </button>
                </div>
                
                <h5 style="color: var(--primary); margin: 25px 0 15px 0;">Daftar Perintah Suara:</h5>
                <div class="voice-commands-list">
                    ${this.commands.map(cmd => `
                        <div class="voice-command-item">
                            <div class="voice-command-keyword">
                                <i class="fas fa-chevron-right"></i>
                                "${cmd.keyword}"
                            </div>
                            <div class="voice-command-desc">${cmd.description}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Tips:</strong> Ucapkan perintah dengan jelas. Gunakan dalam lingkungan yang tenang untuk hasil terbaik.
                    </p>
                </div>
                
                <div style="margin-top: 25px;">
                    <button class="modal-btn primary" id="closeVoiceHelpBtn" style="width: 100%;">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('voiceCommandContent').innerHTML = html;
        document.getElementById('voiceCommandModal').classList.add('active');
        
        this.setupVoiceHelpListeners();
        
        if (window.menuVoiceSystem) {
            window.menuVoiceSystem.speak("Sistem perintah suara. Anda dapat mengontrol aplikasi dengan perintah suara. Katakan bantuan untuk melihat daftar perintah yang tersedia.");
        }
    }

    setupVoiceHelpListeners() {
        const startBtn = document.getElementById('startListeningBtn');
        const stopBtn = document.getElementById('stopListeningBtn');
        const closeBtn = document.getElementById('closeVoiceHelpBtn');
        const closeVoiceModal = document.getElementById('closeVoiceModal');
        
        if (startBtn) {
            startBtn.addEventListener('click', () => {
                this.startListening();
            });
        }
        
        if (stopBtn) {
            stopBtn.addEventListener('click', () => {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            });
        }
        
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closeVoiceHelp();
            });
        }
        
        if (closeVoiceModal) {
            closeVoiceModal.addEventListener('click', () => {
                this.closeVoiceHelp();
            });
        }
        
        const voiceModal = document.getElementById('voiceCommandModal');
        if (voiceModal) {
            voiceModal.addEventListener('click', (e) => {
                if (e.target === voiceModal) {
                    this.closeVoiceHelp();
                }
            });
        }
    }

    closeVoiceHelp() {
        document.getElementById('voiceCommandModal').classList.remove('active');
        document.getElementById('voiceCommandContent').innerHTML = '';
        
        if (this.recognition && this.isListening) {
            this.recognition.stop();
        }
    }
}

class AdminDataExtractor {
    static extractDataForUser(email) {
        try {
            const allAnggota = JSON.parse(localStorage.getItem('koperasi_anggota') || '[]');
            const adminData = allAnggota.find(a => a.email === email);
            
            const koperasiData = JSON.parse(localStorage.getItem('koperasiData') || '{}');
            const adminUpdates = koperasiData.adminUpdates || {};
            const userUpdate = adminUpdates[email];
            
            let userData = {
                email: email,
                nama: 'Anggota Koperasi Asmara Tani',
                foto: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
                status: 'Aktif',
                lastUpdated: new Date().toISOString()
            };
            
            if (adminData) {
                userData.nama = adminData.nama || adminData.name || userData.nama;
                userData.foto = adminData.foto || userData.foto;
                userData.status = adminData.statusAktif || adminData.status || userData.status;
                userData.nia = adminData.nia || adminData.id || '';
                userData.alamat = adminData.alamat || '';
                userData.telepon = adminData.whatsapp || adminData.telepon || '';
                userData.posisi = adminData.posisi || 'Anggota';
                userData.tanggalGabung = adminData.tanggal_bergabung || adminData.tanggal_daftar || '';
                userData.jenisKelamin = adminData.jenisKelamin || '';
                userData.agama = adminData.agama || '';
                userData.nik = adminData.nik || '';
                
                userData.simpananPokok = adminData.simpananPokok || adminData.simpanan_pokok || 0;
                userData.simpananWajib = adminData.simpananWajib || adminData.simpanan_wajib || 0;
                userData.simpananSukarela = adminData.simpananSukarela || adminData.simpanan_sukarela || 0;
                userData.totalSimpanan = adminData.totalSimpanan || adminData.total_simpanan || 0;
                userData.totalPinjaman = adminData.totalPinjaman || adminData.total_pinjaman || 0;
                userData.shuEstimasi = adminData.shuEstimasi || adminData.shu || 0;
                
                userData.pinjamanAktif = adminData.pinjaman?.aktif || [];
                userData.riwayatTransaksi = adminData.riwayatTransaksi || [];
                userData.lastUpdated = adminData.lastUpdated || userData.lastUpdated;
                userData.lastUpdatedBy = adminData.lastUpdatedBy || 'admin';
            }
            
            if (userUpdate && userUpdate.personal) {
                Object.assign(userData, userUpdate.personal);
            }
            
            if (userUpdate && userUpdate.simpanan) {
                Object.assign(userData, userUpdate.simpanan);
            }
            
            console.log('üìä Data extracted from Admin:', userData);
            return userData;
            
        } catch (error) {
            console.error('‚ùå Error extracting admin data:', error);
            return null;
        }
    }
    
    static extractNumber(value) {
        if (!value && value !== 0) return 0;
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
            const numStr = value.replace(/[^\d]/g, '');
            return parseInt(numStr) || 0;
        }
        return 0;
    }
    
    static formatRupiah(amount) {
        if (!amount && amount !== 0) return 'Rp 0';
        return 'Rp ' + amount.toLocaleString('id-ID');
    }
}

// ===== FUNGSI TAMBAHAN =====
function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 2 * 1024 * 1024) {
        window.app.showToast('Ukuran file maksimal 2MB', 'error');
        return;
    }
    
    if (!file.type.match('image.*')) {
        window.app.showToast('Hanya file gambar yang diizinkan', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = document.getElementById('currentPhoto');
        if (img) img.src = e.target.result;
        
        const fotoInput = document.getElementById('editFoto');
        if (fotoInput) fotoInput.value = e.target.result;
        
        localStorage.setItem('temp_profile_photo', e.target.result);
        
        window.app.showToast('Foto berhasil diunggah', 'success');
    };
    reader.readAsDataURL(file);
}

function resetPhoto() {
    const defaultPhoto = 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg';
    
    const img = document.getElementById('currentPhoto');
    if (img) img.src = defaultPhoto;
    
    const fotoInput = document.getElementById('editFoto');
    if (fotoInput) fotoInput.value = defaultPhoto;
    
    localStorage.removeItem('temp_profile_photo');
    window.app.showToast('Foto direset ke default', 'info');
}

// ===== INISIALISASI APLIKASI =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM siap, memulai aplikasi Tabungan Digital dengan Generator QR Code...');
    
    try {
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            showGlobalErrorToast(event.error);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showGlobalErrorToast(event.reason);
        });
        
        function showGlobalErrorToast(error) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background: #f44336; color: white; padding: 12px 24px;
                border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex; align-items: center; gap: 10px;
                max-width: 80%; text-align: center;
            `;
            toast.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>Terjadi kesalahan sistem: ${error.message ? error.message.substring(0, 50) : 'Unknown error'}</span>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }
        
        const appInitTimeout = setTimeout(() => {
            console.warn('‚ö†Ô∏è App initialization taking too long, forcing continue...');
            if (!window.app) {
                window.app = new TabunganApp();
            }
        }, 10000);
        
        window.app = new TabunganApp();
        clearTimeout(appInitTimeout);
        
        console.log('‚úÖ Aplikasi Tabungan Digital dengan Generator QR Code berhasil dimulai!');
        
    } catch (error) {
        console.error('‚ùå Error initializing app:', error);
        
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px; text-align: center;
        `;
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f44336; margin-bottom: 20px;"></i>
            <h2 style="color: #333; margin-bottom: 15px;">Terjadi Kesalahan Sistem</h2>
            <p style="color: #666; margin-bottom: 25px;">${error.message || 'Gagal memuat aplikasi'}</p>
            <button onclick="window.location.reload()" style="
                background: #1a5f23; color: white; border: none; padding: 12px 24px;
                border-radius: 8px; font-size: 16px; cursor: pointer;
            ">
                <i class="fas fa-redo"></i> Muat Ulang Halaman
            </button>
        `;
        document.body.innerHTML = '';
        document.body.appendChild(errorDiv);
    }
});
</script>
</body>
</html>
