<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>E-KTP Digital Anggota</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  background:linear-gradient(180deg,#061b12,#020b07);
  font-family:'Poppins',sans-serif;
  display:flex;
  justify-content:center;
  padding:16px;
  color:#fff;
}

/* KARTU */
.card{
  width:100%;
  max-width:390px;
  background:linear-gradient(160deg,#0f3d28,#062015);
  border-radius:22px;
  padding:18px;
  box-shadow:0 0 35px rgba(0,255,160,.35);
  border:1px solid rgba(0,255,160,.35);
}

/* HEADER */
.header{
  text-align:center;
  border-bottom:1px dashed rgba(255,255,255,.25);
  padding-bottom:14px;
}

/* LOGO GLASS - UNTUK FOTO PROFIL */
.logo-wrap{
  width:86px;
  height:86px;
  margin:0 auto 10px;
  border-radius:50%;
  background:rgba(255,255,255,.12);
  backdrop-filter:blur(12px);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:
    0 0 18px rgba(0,255,160,.6),
    inset 0 0 12px rgba(255,255,255,.25);
  transition:.4s ease;
  animation:float 4s ease-in-out infinite;
  overflow:hidden; /* Tambahan untuk memastikan foto tidak keluar dari lingkaran */
}
.logo-wrap:hover{
  transform:scale(1.08);
  box-shadow:0 0 28px rgba(0,255,160,.9);
}
.logo-wrap img{
  width:100%;
  height:100%;
  object-fit:cover; /* Memastikan foto ter-crop dengan baik */
  border-radius:50%;
}

@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

.header h1{
  font-size:16px;
  margin:0;
  font-weight:700;
  color:#7dffb2;
}
.header small{
  font-size:11px;
  opacity:.85;
}

/* STATUS */
.status{
  margin:12px auto;
  text-align:center;
}
.status span{
  padding:6px 18px;
  border-radius:20px;
  background:#00ff9d33;
  color:#00ff9d;
  font-size:12px;
  font-weight:600;
}
.status-inactive{
  background:#ff3d0033 !important;
  color:#ffa000 !important;
}

/* IDENTITAS */
.identity{
  text-align:center;
  margin:14px 0;
}
.identity h2{
  margin:4px 0;
  font-size:17px;
}
.identity p{
  margin:0;
  font-size:12px;
  color:#a9ffd1;
}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin:16px 0;
}
.stat{
  background:rgba(0,255,160,.15);
  border-radius:14px;
  padding:10px;
  text-align:center;
}
.stat small{
  font-size:10px;
  opacity:.9;
}
.stat b{
  display:block;
  margin-top:6px;
  font-size:13px;
}

/* DATA */
.data{
  font-size:12px;
}
.data div{
  display:flex;
  justify-content:space-between;
  padding:7px 0;
  border-bottom:1px dashed rgba(255,255,255,.25);
}
.data span{
  color:#b6ffd9;
}

/* ACTION BUTTON */
.actions{
  display:flex;
  gap:12px;
  margin:18px 0 6px;
}
.actions button{
  flex:1;
  border:none;
  padding:10px;
  border-radius:14px;
  background:rgba(0,255,160,.2);
  color:#00ff9d;
  font-weight:600;
  backdrop-filter:blur(10px);
  box-shadow:0 0 14px rgba(0,255,160,.5);
  transition:.3s;
}
.actions button:hover{
  background:#00ff9d;
  color:#003a24;
  transform:translateY(-2px);
}

/* FOOTER */
.footer{
  margin-top:10px;
  text-align:center;
  font-size:10px;
  opacity:.75;
}

/* LOADING */
.loading{
  text-align:center;
  padding:30px;
}
.spinner{
  width:40px;
  height:40px;
  border:3px solid rgba(0,255,160,.3);
  border-top:3px solid #00ff9d;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 15px;
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

/* LAST UPDATE */
.last-update{
  font-size:9px;
  text-align:center;
  margin-top:5px;
  opacity:.6;
}

/* FALLBACK IMAGE */
.fallback-img {
  background: linear-gradient(145deg, #2E7D32, #4CAF50);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="card" id="cardContent">
  <!-- LOADING STATE -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Memuat data anggota...</p>
  </div>
  
  <!-- CONTENT (hidden by default) -->
  <div id="content" style="display:none;">
    <div class="header">
      <div class="logo-wrap" id="profilePhotoContainer">
        <img id="profilePhoto" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg" 
             alt="Foto Profil" 
             onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Eldi+Sugianto&background=2E7D32&color=fff&size=128';">
      </div>
      <h1>KOPERASI ASMARA TANI</h1>
      <small>Kartu Anggota Digital (Mobile-Only)</small>
    </div>

    <div class="status">
      <span id="statusText">AKTIF</span>
    </div>

    <div class="identity">
      <h2 id="nama">Eldi Sugianto, S.Kom</h2>
      <p id="nia">NIA : #01-2026-001</p>
    </div>

    <div class="stats">
      <div class="stat"><small>Simpanan Pokok</small><b id="pokok">Rp 0</b></div>
      <div class="stat"><small>Simpanan Wajib</small><b id="wajib">Rp 0</b></div>
      <div class="stat"><small>Simpanan Sukarela</small><b id="sukarela">Rp 0</b></div>
    </div>

    <div class="data">
      <div><span>Alamat</span><b id="alamat">Kp. Banjar Karya Rt. 02 Rw. 01 Desa Ciasmara Kecamatan Pamijahan Kabupaten Bogor Kode POS 16810</b></div>
      <div><span>Jenis Kelamin</span><b id="jk">Laki-laki</b></div>
      <div><span>Agama</span><b id="agama">Islam</b></div>
      <div><span>NIK</span><b id="nik">3201171212810011</b></div>
      <div><span>Email</span><b id="email">siliwangi4212@gmail.com</b></div>
      <div><span>Telepon</span><b id="telepon">6285218483129</b></div>
      <div><span>Tanggal Daftar</span><b id="tglDaftar">18-09-2020</b></div>
      <div><span>Total Simpanan</span><b id="totalSimpanan">Rp 0</b></div>
      <div><span>Total Pinjaman</span><b id="totalPinjaman">Rp 0</b></div>
      <div><span>Estimasi SHU</span><b id="shu">Rp 0</b></div>
    </div>

    <div class="actions">
      <button onclick="window.print()">Cetak</button>
      <button onclick="exportPDF()">Export PDF</button>
    </div>

    <div class="footer">
      Data tersinkronisasi dari Dashboard Admin<br>
      ¬© Koperasi Asmara Tani 2026
      <div class="last-update" id="lastUpdate">Terakhir update: -</div>
    </div>
  </div>
</div>

<script>
// =================== KONFIGURASI APPS SCRIPT ===================
const CONFIG = {
    // URL Web App Google Apps Script (sama dengan akun-anggota.html)
    GOOGLE_SHEETS_WEBAPP_URL: 'https://script.google.com/macros/s/AKfycbw2Lspxf4UB7x0KZ2GUCVQc-eEFmCCNsUXco5XcOlh2E2x0NDFqIOfx6Vji4oLu4ZuO/exec',
    
    // Spreadsheet ID yang benar
    SPREADSHEET_ID: '1L4zbMihd_ViXHZEQu1Fjnv0QI0HY4s8c1UdEudzKuwA',
    
    // Default Member ID (bisa diganti via URL parameter)
    DEFAULT_MEMBER_ID: '#01-2026-001',
    
    // Data default untuk fallback
    DEFAULT_MEMBER_NAME: 'Eldi Sugianto, S.Kom',
    DEFAULT_MEMBER_EMAIL: 'siliwangi4212@gmail.com',
    DEFAULT_MEMBER_PHONE: '6285218483129',
    DEFAULT_MEMBER_ADDRESS: 'Kp. Banjar Karya Rt. 02 Rw. 01 Desa Ciasmara Kecamatan Pamijahan Kabupaten Bogor Kode POS 16810',
    DEFAULT_FOTO_URL: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg'
};

// =================== DATA ANGGOTA ===================
let memberData = {
    // Data Profil
    id: CONFIG.DEFAULT_MEMBER_ID,
    nama: CONFIG.DEFAULT_MEMBER_NAME,
    email: CONFIG.DEFAULT_MEMBER_EMAIL,
    wa: CONFIG.DEFAULT_MEMBER_PHONE,
    alamat: CONFIG.DEFAULT_MEMBER_ADDRESS,
    nik: '3201171212810011',
    jk: 'Laki-laki',
    agama: 'Islam',
    tglDaftar: '2020-09-18',
    status: 'AKTIF',
    fotoUrl: CONFIG.DEFAULT_FOTO_URL, // Tambahan field foto
    
    // Data Keuangan
    pokok: 200000,
    wajib: 0,
    sukarela: 200000,
    
    // Data Pinjaman
    loanActive: 10000000,
    loanRejected: 1000000,
    loanPaid: 6000000,
    
    // Persentase
    shuPercentage: 0.05
};

// =================== HELPER FUNCTIONS ===================
function formatRupiah(angka) {
    if (angka === undefined || angka === null) return "Rp 0";
    return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return date.toLocaleDateString('id-ID', options).replace(/\//g, '-');
    } catch (e) {
        return dateString;
    }
}

function getParameterByName(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

// =================== FUNGSI UPDATE FOTO PROFIL ===================
function updateProfilePhoto(fotoUrl, nama) {
    const photoElement = document.getElementById('profilePhoto');
    
    if (fotoUrl && fotoUrl !== '') {
        photoElement.src = fotoUrl;
    } else {
        // Fallback ke UI Avatars jika tidak ada foto
        const namaForUrl = encodeURIComponent(nama || 'Anggota');
        photoElement.src = `https://ui-avatars.com/api/?name=${namaForUrl}&background=2E7D32&color=fff&size=128`;
    }
    
    // Handler jika gambar gagal load
    photoElement.onerror = function() {
        this.onerror = null;
        const namaForUrl = encodeURIComponent(nama || 'Anggota');
        this.src = `https://ui-avatars.com/api/?name=${namaForUrl}&background=2E7D32&color=fff&size=128`;
    };
}

// =================== FUNGSI UPDATE UI ===================
function updateUI(data) {
    if (!data) return;
    
    // Update foto profil
    updateProfilePhoto(data.fotoUrl, data.nama);
    
    // Update basic info
    document.getElementById('nama').textContent = data.nama || CONFIG.DEFAULT_MEMBER_NAME;
    document.getElementById('nia').textContent = `NIA : ${data.id || CONFIG.DEFAULT_MEMBER_ID}`;
    
    // Update status
    const statusElement = document.getElementById('statusText');
    statusElement.textContent = data.status || 'AKTIF';
    if (data.status === 'TIDAK AKTIF') {
        statusElement.className = 'status-inactive';
    } else {
        statusElement.className = '';
    }
    
    // Update simpanan
    document.getElementById('pokok').textContent = formatRupiah(data.pokok || 0);
    document.getElementById('wajib').textContent = formatRupiah(data.wajib || 0);
    document.getElementById('sukarela').textContent = formatRupiah(data.sukarela || 0);
    
    // Update data pribadi
    document.getElementById('alamat').textContent = data.alamat || CONFIG.DEFAULT_MEMBER_ADDRESS;
    document.getElementById('jk').textContent = data.jk || 'Laki-laki';
    document.getElementById('agama').textContent = data.agama || 'Islam';
    document.getElementById('nik').textContent = data.nik || '3201171212810011';
    document.getElementById('email').textContent = data.email || CONFIG.DEFAULT_MEMBER_EMAIL;
    document.getElementById('telepon').textContent = data.wa || CONFIG.DEFAULT_MEMBER_PHONE;
    document.getElementById('tglDaftar').textContent = formatDate(data.tglDaftar || '2020-09-18');
    
    // Update keuangan
    const totalSimpanan = (data.pokok || 0) + (data.wajib || 0) + (data.sukarela || 0);
    document.getElementById('totalSimpanan').textContent = formatRupiah(totalSimpanan);
    document.getElementById('totalPinjaman').textContent = formatRupiah(data.loanActive || 0);
    
    const shuEstimation = Math.floor(totalSimpanan * (data.shuPercentage || 0.05));
    document.getElementById('shu').textContent = formatRupiah(shuEstimation);
    
    // Update timestamp
    const now = new Date();
    const options = { 
        day: '2-digit', month: '2-digit', year: 'numeric', 
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
    };
    const timeStr = now.toLocaleDateString('id-ID', options).replace(/\//g, '-');
    document.getElementById('lastUpdate').textContent = `Terakhir update: ${timeStr} WIB`;
    
    // Hide loading, show content
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'block';
}

// =================== FUNGSI LOAD DATA DARI GOOGLE SHEETS ===================
async function loadMemberDataFromSheets(memberId) {
    try {
        console.log('üîÑ Mengambil data anggota dari Google Sheets...');
        
        const response = await fetch(`${CONFIG.GOOGLE_SHEETS_WEBAPP_URL}?memberId=${encodeURIComponent(memberId)}`, {
            method: 'GET',
            mode: 'cors'
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.data && result.data.member) {
                const sheetsData = result.data.member;
                
                // Update memberData dengan data dari Google Sheets (termasuk fotoUrl)
                memberData = {
                    ...memberData,
                    id: sheetsData.nia || memberId,
                    nama: sheetsData.nama || memberData.nama,
                    email: sheetsData.email || memberData.email,
                    wa: sheetsData.wa || memberData.wa,
                    alamat: sheetsData.alamat || memberData.alamat,
                    nik: sheetsData.nik || memberData.nik,
                    jk: sheetsData.jenisKelamin || memberData.jk,
                    agama: sheetsData.agama || memberData.agama,
                    tglDaftar: sheetsData.tanggalGabung || memberData.tglDaftar,
                    status: sheetsData.statusKeanggotaan || memberData.status,
                    fotoUrl: sheetsData.fotoUrl || memberData.fotoUrl, // Ambil fotoUrl dari sheets
                    pokok: sheetsData.pokok || memberData.pokok,
                    wajib: sheetsData.wajib || memberData.wajib,
                    sukarela: sheetsData.sukarela || memberData.sukarela,
                    shuPercentage: memberData.shuPercentage
                };
                
                // Update loan data jika ada
                if (result.data.loans) {
                    memberData.loanActive = result.data.loans.berjalan?.nominal || 0;
                    memberData.loanRejected = result.data.loans.ditolak?.nominal || 0;
                    memberData.loanPaid = result.data.loans.lunas?.nominal || 0;
                }
                
                console.log('‚úÖ Data berhasil dimuat dari Google Sheets');
                return true;
            }
        }
        
        console.log('‚ö†Ô∏è Gagal memuat dari Google Sheets, menggunakan data lokal');
        return false;
        
    } catch (error) {
        console.error('‚ùå Error loading from Google Sheets:', error);
        return false;
    }
}

// =================== FUNGSI LOAD DATA UTAMA ===================
async function loadMemberData() {
    try {
        // Ambil ID dari URL parameter atau pakai default
        const memberId = getParameterByName('id') || CONFIG.DEFAULT_MEMBER_ID;
        
        // Coba ambil data dari Google Sheets
        const sheetsSuccess = await loadMemberDataFromSheets(memberId);
        
        // Update UI dengan data yang ada (dari sheets atau default)
        updateUI(memberData);
        
    } catch (error) {
        console.error('Error loading data:', error);
        // Fallback ke default data
        updateUI(memberData);
    }
}

// =================== EXPORT FUNCTION ===================
function exportPDF() {
    alert('Fitur Export PDF akan diintegrasikan dengan Dashboard Admin');
    // Bisa diarahkan ke dashboard admin untuk generate PDF
    window.open('dashboard-admin.html?export=pdf&id=' + encodeURIComponent(memberData.id), '_blank');
}

// =================== AUTO REFRESH ===================
// Auto refresh data setiap 30 detik
setInterval(loadMemberData, 30000);

// =================== INITIAL LOAD ===================
// Load data saat halaman dibuka
document.addEventListener('DOMContentLoaded', loadMemberData);

// =================== SYNC WITH DASHBOARD ===================
// Fungsi untuk diupdate dari dashboard-admin.html
window.updateMemberData = function(memberId, newData) {
    if (memberId === memberData.id) {
        // Update data
        memberData = {
            ...memberData,
            ...newData
        };
        
        // Update UI
        updateUI(memberData);
        
        // Trigger sinkron ke Google Sheets
        syncToGoogleSheets();
    }
    return true;
};

// Fungsi sinkron ke Google Sheets
async function syncToGoogleSheets() {
    try {
        const totalSimpanan = memberData.pokok + memberData.wajib + memberData.sukarela;
        
        const dataToSend = {
            action: 'sync',
            timestamp: new Date().toISOString(),
            memberId: memberData.id,
            memberName: memberData.nama,
            fotoUrl: memberData.fotoUrl, // Kirim fotoUrl juga
            simpananPokok: memberData.pokok,
            simpananWajib: memberData.wajib,
            simpananSukarela: memberData.sukarela,
            totalSimpanan: totalSimpanan,
            pinjamanAktif: memberData.loanActive,
            pinjamanDitolak: memberData.loanRejected,
            pinjamanLunas: memberData.loanPaid,
            shuEstimasi: Math.floor(totalSimpanan * (memberData.shuPercentage || 0.05))
        };
        
        await fetch(CONFIG.GOOGLE_SHEETS_WEBAPP_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        });
        
        console.log('‚úÖ Data tersinkron ke Google Sheets');
        
    } catch (error) {
        console.error('‚ùå Gagal sinkron ke Google Sheets:', error);
    }
}

// =================== DEBUG / TEST ===================
window.debugUpdate = function() {
    const testData = {
        pokok: 250000,
        sukarela: 250000,
        loanActive: 12000000,
        fotoUrl: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEitHwKW04cRgPXw3b8d7SBgwklv_0jmxB-cAiU3m_kPBMh459fH74hQ9O4xp3evk1E44AUsPu08yFElOe40HlvY1ouC4QDsdu2GI-IM5Jm5gXhtwOA5lQEGba2eAEX1kAV4XeG9HpUN-ouz3fn-7rzinxdhjk3GD9a8c5-FHqY0WXVwXff1ftHS4NHwRZo/s320/1000577072.png'
    };
    
    window.updateMemberData(memberData.id, testData);
    alert('Data test telah diupdate!');
};

// =================== LISTENER UNTUK STORAGE CHANGES ===================
// Jika ada perubahan dari tab lain
window.addEventListener('storage', function(e) {
    if (e.key === 'koperasiData') {
        console.log('üîÑ Data berubah di tab lain, reload...');
        loadMemberData();
    }
});
</script>

</body>
</html>
