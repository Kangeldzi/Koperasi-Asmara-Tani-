<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>E-KTP Digital + QR Hybrid - Koperasi Asmara Tani</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<style>
body{
  margin:0;
  background:linear-gradient(180deg,#061b12,#020b07);
  font-family:'Poppins',sans-serif;
  display:flex;
  justify-content:center;
  padding:16px;
  color:#fff;
}

/* KARTU */
.card{
  width:100%;
  max-width:390px;
  background:linear-gradient(160deg,#0f3d28,#062015);
  border-radius:22px;
  padding:18px;
  box-shadow:0 0 35px rgba(0,255,160,.35);
  border:1px solid rgba(0,255,160,.35);
}

/* HEADER */
.header{
  text-align:center;
  border-bottom:1px dashed rgba(255,255,255,.25);
  padding-bottom:14px;
}

/* LOGO GLASS - UNTUK FOTO PROFIL */
.logo-wrap{
  width:86px;
  height:86px;
  margin:0 auto 10px;
  border-radius:50%;
  background:rgba(255,255,255,.12);
  backdrop-filter:blur(12px);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:
    0 0 18px rgba(0,255,160,.6),
    inset 0 0 12px rgba(255,255,255,.25);
  transition:.4s ease;
  animation:float 4s ease-in-out infinite;
  overflow:hidden;
}
.logo-wrap:hover{
  transform:scale(1.08);
  box-shadow:0 0 28px rgba(0,255,160,.9);
}
.logo-wrap img{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:50%;
}

@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

.header h1{
  font-size:16px;
  margin:0;
  font-weight:700;
  color:#7dffb2;
}
.header small{
  font-size:11px;
  opacity:.85;
}

/* STATUS */
.status{
  margin:12px auto;
  text-align:center;
}
.status span{
  padding:6px 18px;
  border-radius:20px;
  background:#00ff9d33;
  color:#00ff9d;
  font-size:12px;
  font-weight:600;
}
.status-inactive{
  background:#ff3d0033 !important;
  color:#ffa000 !important;
}

/* QR CODE SECTION */
.qr-section {
  background: rgba(0, 255, 160, 0.1);
  border-radius: 16px;
  padding: 15px;
  margin: 15px 0;
  text-align: center;
  border: 1px solid rgba(0, 255, 160, 0.3);
}

.qr-title {
  font-size: 14px;
  font-weight: 600;
  color: #7dffb2;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.qr-container {
  display: flex;
  justify-content: center;
  margin: 10px 0;
}

#qrcode {
  width: 150px;
  height: 150px;
  background: white;
  padding: 10px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#qrcode canvas {
  width: 100% !important;
  height: 100% !important;
  border-radius: 8px;
}

.qr-footer {
  font-size: 10px;
  color: #a9ffd1;
  margin-top: 8px;
  opacity: 0.8;
}

.qr-badge {
  display: inline-block;
  background: #2e7d32;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 10px;
  margin-top: 5px;
}

/* IDENTITAS */
.identity{
  text-align:center;
  margin:14px 0;
}
.identity h2{
  margin:4px 0;
  font-size:17px;
}
.identity p{
  margin:0;
  font-size:12px;
  color:#a9ffd1;
}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin:16px 0;
}
.stat{
  background:rgba(0,255,160,.15);
  border-radius:14px;
  padding:10px;
  text-align:center;
}
.stat small{
  font-size:10px;
  opacity:.9;
}
.stat b{
  display:block;
  margin-top:6px;
  font-size:13px;
}

/* DATA */
.data{
  font-size:12px;
}
.data div{
  display:flex;
  justify-content:space-between;
  padding:7px 0;
  border-bottom:1px dashed rgba(255,255,255,.25);
}
.data span{
  color:#b6ffd9;
}

/* ACTION BUTTON */
.actions{
  display:flex;
  gap:12px;
  margin:18px 0 6px;
}
.actions button{
  flex:1;
  border:none;
  padding:10px;
  border-radius:14px;
  background:rgba(0,255,160,.2);
  color:#00ff9d;
  font-weight:600;
  backdrop-filter:blur(10px);
  box-shadow:0 0 14px rgba(0,255,160,.5);
  transition:.3s;
  cursor: pointer;
}
.actions button:hover{
  background:#00ff9d;
  color:#003a24;
  transform:translateY(-2px);
}

/* SHARE BUTTON */
.share-btn {
  background: rgba(255,255,255,0.15) !important;
  color: white !important;
  box-shadow: none !important;
}

.share-btn:hover {
  background: rgba(255,255,255,0.3) !important;
  color: #00ff9d !important;
}

/* FOOTER */
.footer{
  margin-top:10px;
  text-align:center;
  font-size:10px;
  opacity:.75;
}

/* LOADING */
.loading{
  text-align:center;
  padding:30px;
}
.spinner{
  width:40px;
  height:40px;
  border:3px solid rgba(0,255,160,.3);
  border-top:3px solid #00ff9d;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 15px;
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

/* LAST UPDATE */
.last-update{
  font-size:9px;
  text-align:center;
  margin-top:5px;
  opacity:.6;
}

/* FALLBACK IMAGE */
.fallback-img {
  background: linear-gradient(145deg, #2E7D32, #4CAF50);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: bold;
}

/* SYNC STATUS */
.sync-status {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-top: 8px;
  font-size: 10px;
  color: #a9ffd1;
}

.sync-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #00ff9d;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
</style>
</head>

<body>

<div class="card" id="cardContent">
  <!-- LOADING STATE -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Memuat data anggota...</p>
  </div>
  
  <!-- CONTENT (hidden by default) -->
  <div id="content" style="display:none;">
    <div class="header">
      <div class="logo-wrap" id="profilePhotoContainer">
        <img id="profilePhoto" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEitHwKW04cRgPXw3b8d7SBgwklv_0jmxB-cAiU3m_kPBMh459fH74hQ9O4xp3evk1E44AUsPu08yFElOe40HlvY1ouC4QDsdu2GI-IM5Jm5gXhtwOA5lQEGba2eAEX1kAV4XeG9HpUN-ouz3fn-7rzinxdhjk3GD9a8c5-FHqY0WXVwXff1ftHS4NHwRZo/s320/1000577072.png" 
             alt="Foto Profil" 
             onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Eldi+Sugianto&background=2E7D32&color=fff&size=128';">
      </div>
      <h1>KOPERASI ASMARA TANI</h1>
      <small>Kartu Anggota Digital + QR Hybrid</small>
    </div>

    <div class="status">
      <span id="statusText">AKTIF</span>
    </div>

    <!-- QR CODE SECTION -->
    <div class="qr-section">
      <div class="qr-title">
        <i class="fas fa-qrcode"></i> QR CODE ANGGOTA
      </div>
      <div class="qr-container">
        <div id="qrcode"></div>
      </div>
      <div class="qr-footer" id="qrData">NIA : #01-2026-001</div>
      <span class="qr-badge" id="qrBadge">Scan untuk verifikasi</span>
    </div>

    <div class="identity">
      <h2 id="nama">Eldi Sugianto, S.Kom</h2>
      <p id="nia">NIA : #01-2026-001</p>
      <p id="posisi">Ketua</p>
    </div>

    <div class="stats">
      <div class="stat"><small>Simpanan Pokok</small><b id="pokok">Rp 0</b></div>
      <div class="stat"><small>Simpanan Wajib</small><b id="wajib">Rp 0</b></div>
      <div class="stat"><small>Simpanan Sukarela</small><b id="sukarela">Rp 0</b></div>
    </div>

    <div class="data">
      <div><span>Alamat</span><b id="alamat">Kp. Banjar Karya Rt. 02 Rw. 01 Desa Ciasmara Kecamatan Pamijahan Kabupaten Bogor Kode POS 16810</b></div>
      <div><span>Jenis Kelamin</span><b id="jk">Laki-laki</b></div>
      <div><span>Agama</span><b id="agama">Islam</b></div>
      <div><span>NIK</span><b id="nik">3201171212810011</b></div>
      <div><span>Email</span><b id="email">siliwangi4212@gmail.com</b></div>
      <div><span>WhatsApp</span><b id="telepon">085218483129</b></div>
      <div><span>Tanggal Daftar</span><b id="tglDaftar">18-09-2020</b></div>
      <div><span>Total Simpanan</span><b id="totalSimpanan">Rp 0</b></div>
      <div><span>Total Pinjaman</span><b id="totalPinjaman">Rp 0</b></div>
      <div><span>Estimasi SHU</span><b id="shu">Rp 0</b></div>
      <div><span>Hutang Toko</span><b id="hutangToko">Rp 0</b></div>
    </div>

    <div class="actions">
      <button onclick="shareQR()" class="share-btn"><i class="fas fa-share-alt"></i> Share QR</button>
      <button onclick="exportCard()">Export PDF</button>
    </div>

    <div class="sync-status">
      <div class="sync-dot"></div>
      <span id="syncStatus">Tersinkron dengan Google Sheets</span>
    </div>

    <div class="footer">
      Data realtime dari Dashboard Admin<br>
      ¬© Koperasi Asmara Tani 2026
      <div class="last-update" id="lastUpdate">Terakhir update: -</div>
    </div>
  </div>
</div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
// =================== KONFIGURASI APPS SCRIPT ===================
const CONFIG = {
    // URL Web App Google Apps Script
    GOOGLE_SHEETS_WEBAPP_URL: 'https://script.google.com/macros/s/AKfycbwqPS3eNKzgT4NW9wCJTxO902ARq15MRy2B7fNjdRiJ1qqdPWqp_9MuXsNc16du6YaM/exec',
    
    // Spreadsheet ID
    SPREADSHEET_ID: '1L4zbMihd_ViXHZEQu1Fjnv0QI0HY4s8c1UdEudzKuwA',
    
    // Default Member ID
    DEFAULT_MEMBER_ID: '01-2026-001',
    
    // Data default sesuai referensi
    DEFAULT_MEMBER: {
        nia: '01-2026-001',
        nama: 'Eldi Sugianto, S.Kom',
        posisi: 'Ketua',
        email: 'siliwangi4212@gmail.com',
        wa: '085218483129',
        alamat: 'Kp. Banjar Karya Rt. 02 Rw. 01 Desa Ciasmara Kecamatan Pamijahan Kabupaten Bogor Kode POS 16810',
        nik: '3201171212810011',
        jk: 'Laki-laki',
        agama: 'Islam',
        tglDaftar: '2020-09-18',
        status: 'AKTIF',
        fotoUrl: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEitHwKW04cRgPXw3b8d7SBgwklv_0jmxB-cAiU3m_kPBMh459fH74hQ9O4xp3evk1E44AUsPu08yFElOe40HlvY1ouC4QDsdu2GI-IM5Jm5gXhtwOA5lQEGba2eAEX1kAV4XeG9HpUN-ouz3fn-7rzinxdhjk3GD9a8c5-FHqY0WXVwXff1ftHS4NHwRZo/s320/1000577072.png',
        pokok: 200000,
        wajib: 0,
        sukarela: 200000,
        totalPinjaman: 0,
        hutangToko: 0,
        shuPercentage: 0.05
    }
};

// =================== DATA ANGGOTA ===================
let memberData = { ...CONFIG.DEFAULT_MEMBER };

// =================== HELPER FUNCTIONS ===================
function formatRupiah(angka) {
    if (angka === undefined || angka === null) return "Rp 0";
    return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return date.toLocaleDateString('id-ID', options).replace(/\//g, '-');
    } catch (e) {
        return dateString;
    }
}

function getParameterByName(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

// =================== GENERATE QR CODE ===================
function generateQRCode(data) {
    const qrElement = document.getElementById('qrcode');
    qrElement.innerHTML = ''; // Clear existing QR
    
    // Data QR berisi informasi lengkap anggota
    const qrData = JSON.stringify({
        nia: data.nia,
        nama: data.nama,
        status: data.status,
        timestamp: new Date().toISOString(),
        url: window.location.href.split('?')[0] + '?id=' + encodeURIComponent(data.nia)
    });
    
    // Generate QR Code
    QRCode.toCanvas(qrData, { 
        width: 200,
        margin: 2,
        color: {
            dark: '#000000',
            light: '#ffffff'
        }
    }, function(err, canvas) {
        if (err) {
            console.error('Error generating QR:', err);
            qrElement.innerHTML = '<div style="color:red;">Gagal generate QR</div>';
            return;
        }
        qrElement.appendChild(canvas);
    });
    
    // Update QR info
    document.getElementById('qrData').innerHTML = `NIA : ${data.nia}<br>Scan untuk verifikasi data`;
    document.getElementById('qrBadge').innerHTML = data.status === 'AKTIF' ? '‚úì Anggota Aktif' : '‚ö†Ô∏è Tidak Aktif';
}

// =================== FUNGSI UPDATE FOTO PROFIL ===================
function updateProfilePhoto(fotoUrl, nama) {
    const photoElement = document.getElementById('profilePhoto');
    
    if (fotoUrl && fotoUrl !== '') {
        photoElement.src = fotoUrl;
    } else {
        // Fallback ke UI Avatars
        const namaForUrl = encodeURIComponent(nama || 'Anggota');
        photoElement.src = `https://ui-avatars.com/api/?name=${namaForUrl}&background=2E7D32&color=fff&size=128`;
    }
    
    photoElement.onerror = function() {
        this.onerror = null;
        const namaForUrl = encodeURIComponent(nama || 'Anggota');
        this.src = `https://ui-avatars.com/api/?name=${namaForUrl}&background=2E7D32&color=fff&size=128`;
    };
}

// =================== FUNGSI UPDATE UI ===================
function updateUI(data) {
    if (!data) return;
    
    // Update foto profil
    updateProfilePhoto(data.fotoUrl, data.nama);
    
    // Update basic info
    document.getElementById('nama').textContent = data.nama || CONFIG.DEFAULT_MEMBER.nama;
    document.getElementById('nia').textContent = `NIA : ${data.nia || CONFIG.DEFAULT_MEMBER.nia}`;
    document.getElementById('posisi').textContent = data.posisi || 'Anggota';
    
    // Update status
    const statusElement = document.getElementById('statusText');
    statusElement.textContent = data.status || 'AKTIF';
    if (data.status !== 'AKTIF') {
        statusElement.className = 'status-inactive';
    } else {
        statusElement.className = '';
    }
    
    // Update simpanan
    document.getElementById('pokok').textContent = formatRupiah(data.pokok || 0);
    document.getElementById('wajib').textContent = formatRupiah(data.wajib || 0);
    document.getElementById('sukarela').textContent = formatRupiah(data.sukarela || 0);
    
    // Update data pribadi
    document.getElementById('alamat').textContent = data.alamat || CONFIG.DEFAULT_MEMBER.alamat;
    document.getElementById('jk').textContent = data.jk || 'Laki-laki';
    document.getElementById('agama').textContent = data.agama || 'Islam';
    document.getElementById('nik').textContent = data.nik || '3201171212810011';
    document.getElementById('email').textContent = data.email || CONFIG.DEFAULT_MEMBER.email;
    document.getElementById('telepon').textContent = data.wa || '085218483129';
    document.getElementById('tglDaftar').textContent = formatDate(data.tglDaftar || '2020-09-18');
    
    // Update keuangan
    const totalSimpanan = (data.pokok || 0) + (data.wajib || 0) + (data.sukarela || 0);
    document.getElementById('totalSimpanan').textContent = formatRupiah(totalSimpanan);
    document.getElementById('totalPinjaman').textContent = formatRupiah(data.totalPinjaman || 0);
    document.getElementById('hutangToko').textContent = formatRupiah(data.hutangToko || 0);
    
    const shuEstimation = Math.floor(totalSimpanan * (data.shuPercentage || 0.05));
    document.getElementById('shu').textContent = formatRupiah(shuEstimation);
    
    // Generate QR Code
    generateQRCode(data);
    
    // Update timestamp
    const now = new Date();
    const options = { 
        day: '2-digit', month: '2-digit', year: 'numeric', 
        hour: '2-digit', minute: '2-digit', second: '2-digit' 
    };
    const timeStr = now.toLocaleDateString('id-ID', options).replace(/\//g, '-');
    document.getElementById('lastUpdate').textContent = `Terakhir update: ${timeStr} WIB`;
    
    // Update sync status
    document.getElementById('syncStatus').innerHTML = '‚úì Tersinkron dengan Google Sheets';
    
    // Hide loading, show content
    document.getElementById('loading').style.display = 'none';
    document.getElementById('content').style.display = 'block';
}

// =================== FUNGSI LOAD DATA DARI GOOGLE SHEETS ===================
async function loadMemberDataFromSheets(memberId) {
    try {
        console.log('üîÑ Mengambil data anggota dari Google Sheets...');
        
        // Coba ambil dari localStorage dulu (data dari halaman lain)
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            const localData = JSON.parse(savedUser);
            if (localData.nia === memberId) {
                console.log('‚úÖ Data ditemukan di localStorage');
                memberData = {
                    ...memberData,
                    ...localData,
                    fotoUrl: localData.fotoUrl || memberData.fotoUrl
                };
                return true;
            }
        }
        
        // Ambil dari Google Sheets via API
        const response = await fetch(`${CONFIG.GOOGLE_SHEETS_WEBAPP_URL}?action=getMember&memberId=${encodeURIComponent(memberId)}&sheetId=${CONFIG.SPREADSHEET_ID}`, {
            method: 'GET',
            mode: 'cors'
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.data) {
                const sheetsData = result.data;
                
                // Update memberData dengan data dari Google Sheets
                memberData = {
                    nia: sheetsData.nia || memberId,
                    nama: sheetsData.nama || memberData.nama,
                    posisi: sheetsData.posisi || memberData.posisi,
                    email: sheetsData.email || memberData.email,
                    wa: sheetsData.whatsapp || sheetsData.wa || memberData.wa,
                    alamat: sheetsData.alamat || memberData.alamat,
                    nik: sheetsData.nik || memberData.nik,
                    jk: sheetsData.jenisKelamin || memberData.jk,
                    agama: sheetsData.agama || memberData.agama,
                    tglDaftar: sheetsData.tanggalBergabung || memberData.tglDaftar,
                    status: sheetsData.status || memberData.status,
                    fotoUrl: sheetsData.fotoUrl || memberData.fotoUrl,
                    pokok: sheetsData.simpananPokok || memberData.pokok,
                    wajib: sheetsData.simpananWajib || memberData.wajib,
                    sukarela: sheetsData.simpananSukarela || memberData.sukarela,
                    totalPinjaman: sheetsData.totalPinjaman || 0,
                    hutangToko: sheetsData.hutangToko || 0,
                    shuPercentage: memberData.shuPercentage
                };
                
                console.log('‚úÖ Data berhasil dimuat dari Google Sheets');
                return true;
            }
        }
        
        console.log('‚ö†Ô∏è Menggunakan data default');
        return false;
        
    } catch (error) {
        console.error('‚ùå Error loading from Google Sheets:', error);
        return false;
    }
}

// =================== FUNGSI LOAD DATA UTAMA ===================
async function loadMemberData() {
    try {
        // Ambil ID dari URL parameter atau pakai default
        const memberId = getParameterByName('id') || CONFIG.DEFAULT_MEMBER_ID;
        
        // Coba ambil data
        await loadMemberDataFromSheets(memberId);
        
        // Update UI
        updateUI(memberData);
        
        // Simpan ke localStorage untuk digunakan halaman lain
        localStorage.setItem('currentUser', JSON.stringify(memberData));
        
    } catch (error) {
        console.error('Error loading data:', error);
        // Fallback ke default data
        updateUI(CONFIG.DEFAULT_MEMBER);
    }
}

// =================== SHARE QR FUNCTION ===================
function shareQR() {
    const qrCanvas = document.querySelector('#qrcode canvas');
    if (!qrCanvas) {
        alert('QR Code belum siap');
        return;
    }
    
    // Convert canvas to data URL
    const qrDataURL = qrCanvas.toDataURL('image/png');
    
    // Buat teks untuk dishare
    const shareText = `Kartu Anggota Koperasi Asmara Tani\nNama: ${memberData.nama}\nNIA: ${memberData.nia}\nStatus: ${memberData.status}\n\nScan QR Code untuk verifikasi data lengkap.`;
    
    // Coba gunakan Web Share API jika tersedia
    if (navigator.share) {
        navigator.share({
            title: 'Kartu Anggota Digital',
            text: shareText,
            url: window.location.href
        }).catch(() => {
            // Fallback
            window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + window.location.href)}`, '_blank');
        });
    } else {
        // Fallback ke WhatsApp
        window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + window.location.href)}`, '_blank');
    }
}

// =================== EXPORT FUNCTION ===================
function exportCard() {
    // Arahkan ke dashboard admin untuk generate PDF
    window.open('dashboard-admin.html?export=pdf&type=memberCard&id=' + encodeURIComponent(memberData.nia), '_blank');
}

// =================== AUTO REFRESH ===================
// Auto refresh data setiap 30 detik
setInterval(loadMemberData, 30000);

// =================== INITIAL LOAD ===================
document.addEventListener('DOMContentLoaded', loadMemberData);

// =================== SYNC WITH OTHER PAGES ===================
// Fungsi untuk diupdate dari halaman lain
window.updateMemberData = function(memberId, newData) {
    if (memberId === memberData.nia) {
        // Update data
        memberData = {
            ...memberData,
            ...newData
        };
        
        // Update UI
        updateUI(memberData);
        
        // Simpan ke localStorage
        localStorage.setItem('currentUser', JSON.stringify(memberData));
        
        // Trigger sync ke Google Sheets
        syncToGoogleSheets();
    }
    return true;
};

// Fungsi sinkron ke Google Sheets
async function syncToGoogleSheets() {
    try {
        const totalSimpanan = (memberData.pokok || 0) + (memberData.wajib || 0) + (memberData.sukarela || 0);
        
        const dataToSend = {
            action: 'sync',
            timestamp: new Date().toISOString(),
            sheetId: CONFIG.SPREADSHEET_ID,
            memberId: memberData.nia,
            memberName: memberData.nama,
            posisi: memberData.posisi,
            fotoUrl: memberData.fotoUrl,
            simpananPokok: memberData.pokok,
            simpananWajib: memberData.wajib,
            simpananSukarela: memberData.sukarela,
            totalSimpanan: totalSimpanan,
            hutangToko: memberData.hutangToko || 0,
            shuEstimasi: Math.floor(totalSimpanan * (memberData.shuPercentage || 0.05))
        };
        
        await fetch(CONFIG.GOOGLE_SHEETS_WEBAPP_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        });
        
        console.log('‚úÖ Data tersinkron ke Google Sheets');
        document.getElementById('syncStatus').innerHTML = '‚úì Tersinkron dengan Google Sheets';
        
    } catch (error) {
        console.error('‚ùå Gagal sinkron ke Google Sheets:', error);
        document.getElementById('syncStatus').innerHTML = '‚ö†Ô∏è Mode offline';
    }
}

// =================== LISTENER UNTUK STORAGE CHANGES ===================
window.addEventListener('storage', function(e) {
    if (e.key === 'currentUser') {
        console.log('üîÑ Data berubah di tab lain, reload...');
        try {
            const newData = JSON.parse(e.newValue);
            if (newData && newData.nia === memberData.nia) {
                memberData = { ...memberData, ...newData };
                updateUI(memberData);
            }
        } catch (err) {
            console.error('Error parsing storage data:', err);
        }
    }
});

// =================== DEBUG ===================
console.log('‚úÖ QR Code Hybrid siap dengan integrasi Google Sheets');
</script>

</body>
</html>
