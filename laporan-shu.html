<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laporan SHU - Koperasi Asmara Tani</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ===== VARIABEL DESAIN MOBILE FIRST ===== */
        :root {
            /* Warna utama */
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --accent: #00bcd4;
            --info: #2196f3;
            --success: #4caf50;
            --warning: #ffc107;
            --danger: #f44336;
            
            /* Neutral colors */
            --dark: #121212;
            --light: #ffffff;
            --gray: #757575;
            --gray-light: #e0e0e0;
            --gray-lighter: #f5f5f5;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* Spacing */
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 14px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== CONTAINER MOBILE OPTIMIZED ===== */
        .mobile-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* ===== HEADER SECTION ===== */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: var(--space-lg) var(--space-md);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
        }
        
        .header-title {
            flex: 1;
        }
        
        .header-title h1 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .header-title p {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .back-button {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        /* ===== FILTER SECTION - MOBILE FRIENDLY ===== */
        .filter-section {
            background: white;
            margin: var(--space-md);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }
        
        .filter-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        
        .filter-title i {
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .filter-title h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .filter-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
        }
        
        .filter-group {
            flex: 1;
            min-width: calc(50% - 8px);
        }
        
        .filter-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 6px;
        }
        
        .filter-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            background: white;
            color: var(--dark);
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        /* ===== STATS SECTION - MOBILE OPTIMIZED ===== */
        .stats-section {
            padding: 0 var(--space-md) var(--space-md);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--primary-light));
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }
        
        .stat-title {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: 500;
            line-height: 1.4;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .stat-detail {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
        }
        
        /* ===== TABLE SECTION - MOBILE OPTIMIZED ===== */
        .table-section {
            padding: 0 var(--space-md) var(--space-md);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding: 0 var(--space-sm);
        }
        
        .table-header h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .table-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        /* ===== TABEL UTAMA - DESAIN MOBILE FIRST ===== */
        .responsive-table {
            width: 100%;
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0;
        }
        
        .mobile-table {
            width: 100%;
            min-width: 320px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .mobile-table thead {
            display: none;
        }
        
        .mobile-table tbody tr {
            display: block;
            border-bottom: 1px solid var(--gray-lighter);
            padding: var(--space-md);
            transition: background-color 0.2s ease;
        }
        
        .mobile-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .mobile-table tbody tr:hover {
            background-color: rgba(46, 125, 50, 0.02);
        }
        
        .mobile-table td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border: none;
            position: relative;
        }
        
        .mobile-table td::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--gray);
            font-size: 0.85rem;
            min-width: 100px;
            padding-right: var(--space-sm);
        }
        
        .mobile-table td .cell-content {
            flex: 1;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ===== CARD VIEW UNTUK TABEL - ALTERNATIF MOBILE ===== */
        .card-view {
            display: block;
        }
        
        .shu-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }
        
        .card-title {
            flex: 1;
        }
        
        .card-title h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }
        
        .card-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: var(--space-sm);
        }
        
        .card-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .card-item {
            display: flex;
            flex-direction: column;
        }
        
        .card-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 4px;
        }
        
        .card-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
            padding-top: var(--space-md);
            border-top: 1px solid var(--gray-lighter);
        }
        
        /* ===== BUTTONS - MOBILE FRIENDLY ===== */
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            box-shadow: 0 6px 16px rgba(46, 125, 50, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #ffb74d);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
            min-height: 36px;
            min-width: 36px;
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1;
        }
        
        .badge-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .badge-warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #e6a700;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .badge-info {
            background-color: rgba(33, 150, 243, 0.1);
            color: var(--info);
            border: 1px solid rgba(33, 150, 243, 0.2);
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--gray);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: var(--gray-lighter);
            color: var(--primary);
            border-color: var(--primary-light);
        }
        
        /* ===== FOOTER ===== */
        .footer {
            background: white;
            padding: var(--space-lg) var(--space-md);
            text-align: center;
            color: var(--gray);
            font-size: 0.85rem;
            border-top: 1px solid var(--gray-lighter);
            margin-top: var(--space-xl);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-primary {
            color: var(--primary);
        }
        
        .text-success {
            color: var(--success);
        }
        
        .fw-bold {
            font-weight: 700;
        }
        
        .d-flex {
            display: flex;
        }
        
        .align-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .mb-1 { margin-bottom: var(--space-xs); }
        .mb-2 { margin-bottom: var(--space-sm); }
        .mb-3 { margin-bottom: var(--space-md); }
        .mb-4 { margin-bottom: var(--space-lg); }
        .mb-5 { margin-bottom: var(--space-xl); }
        
        .mt-1 { margin-top: var(--space-xs); }
        .mt-2 { margin-top: var(--space-sm); }
        .mt-3 { margin-top: var(--space-md); }
        .mt-4 { margin-top: var(--space-lg); }
        .mt-5 { margin-top: var(--space-xl); }
        
        /* ===== MEDIA QUERIES ===== */
        @media screen and (min-width: 768px) {
            html {
                font-size: 15px;
            }
            
            .mobile-container {
                max-width: 720px;
                padding: 0 var(--space-md);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .filter-row {
                flex-wrap: nowrap;
            }
            
            .filter-group {
                min-width: auto;
            }
            
            .mobile-table thead {
                display: table-header-group;
            }
            
            .mobile-table thead th {
                background: rgba(46, 125, 50, 0.05);
                color: var(--primary-dark);
                font-weight: 600;
                padding: 14px 16px;
                text-align: left;
                font-size: 0.9rem;
                border-bottom: 2px solid var(--primary-light);
            }
            
            .mobile-table tbody tr {
                display: table-row;
                padding: 0;
            }
            
            .mobile-table td {
                display: table-cell;
                padding: 14px 16px;
                border-bottom: 1px solid var(--gray-lighter);
                text-align: left;
            }
            
            .mobile-table td::before {
                display: none;
            }
            
            .mobile-table td .cell-content {
                text-align: left;
            }
            
            .card-view {
                display: none;
            }
        }
        
        @media screen and (min-width: 992px) {
            .mobile-container {
                max-width: 960px;
            }
            
            .header {
                padding: var(--space-xl) var(--space-lg);
            }
            
            .header-title h1 {
                font-size: 1.5rem;
            }
            
            .stats-section,
            .table-section {
                padding: 0 var(--space-lg) var(--space-lg);
            }
            
            .filter-section {
                margin: var(--space-lg);
                padding: var(--space-xl);
            }
        }
        
        @media screen and (max-width: 767px) and (orientation: landscape) {
            .mobile-table tbody tr {
                padding: var(--space-sm);
            }
            
            .stat-card {
                padding: var(--space-md);
            }
            
            .filter-section {
                margin: var(--space-sm);
                padding: var(--space-md);
            }
        }
        
        @media screen and (max-width: 360px) {
            html {
                font-size: 13px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            
            .stat-card {
                padding: var(--space-md);
            }
            
            .mobile-table td {
                flex-direction: column;
                align-items: flex-start;
                padding: 8px 0;
            }
            
            .mobile-table td::before {
                margin-bottom: 4px;
                min-width: auto;
            }
            
            .mobile-table td .cell-content {
                text-align: left;
                width: 100%;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--gray-lighter);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <header class="header">
            <div class="header-content">
                <button class="back-button" onclick="goBack()" aria-label="Kembali">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="header-title">
                    <h1>Laporan SHU</h1>
                    <p>Sisa Hasil Usaha - Koperasi Asmara Tani</p>
                </div>
                <div class="sync-status" id="syncStatus" title="Status Sinkronisasi">
                    <i class="fas fa-sync-alt" style="color: white; opacity: 0.8;"></i>
                </div>
            </div>
        </header>
        
        <section class="filter-section">
            <div class="filter-title">
                <i class="fas fa-filter"></i>
                <h2>Filter Laporan</h2>
            </div>
            
            <div class="filter-grid">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Tahun</label>
                        <select class="filter-select" id="tahunSHU">
                            <option value="2028">2028</option>
                            <option value="2027">2027</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Periode</label>
                        <select class="filter-select" id="periodeSHU">
                            <option value="tahunan">Tahunan</option>
                            <option value="semester1">Semester 1</option>
                            <option value="semester2">Semester 2</option>
                            <option value="triwulan1">Triwulan 1</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="statusSHU">
                            <option value="all">Semua Status</option>
                            <option value="dibagikan">Sudah Dibagikan</option>
                            <option value="dialokasikan">Dialokasikan</option>
                            <option value="disetorkan">Disetorkan</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" id="applyFilterBtn" style="flex: 1;">
                        <i class="fas fa-sync-alt"></i>
                        <span>Terapkan Filter</span>
                    </button>
                    <button class="btn btn-outline btn-icon" id="resetFilterBtn" title="Reset Filter">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <section class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total SHU Tahun Ini</div>
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalSHUDisplay">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span id="growthPercent">0%</span> pertumbuhan
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">SHU Dibagikan</div>
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="shuAnggotaDisplay">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-users"></i>
                        <span id="jumlahAnggotaSHU">0</span> anggota
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Dana Cadangan</div>
                        <div class="stat-icon">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="danaCadanganDisplay">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-percentage"></i>
                        40% dari total SHU
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Rata-rata/Anggota</div>
                        <div class="stat-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="rataRataSHU">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-chart-line"></i>
                        Berdasarkan simpanan
                    </div>
                </div>
            </div>
        </section>
        
        <section class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-chart-pie"></i>
                    Distribusi SHU
                </h2>
                <div class="table-actions">
                    <button class="btn btn-outline btn-sm" id="exportBtn" title="Export Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                    <button class="btn btn-outline btn-sm" id="printBtn" title="Print">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="mobile-table">
                    <thead>
                        <tr>
                            <th>Jenis Alokasi</th>
                            <th>Persentase</th>
                            <th>Jumlah</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="shuTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                                <p style="margin-top: 16px; color: var(--gray);">Memuat data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card-view" id="shuCardView">
                <div class="shu-card" style="text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                    <p style="margin-top: 16px; color: var(--gray);">Memuat data...</p>
                </div>
            </div>
        </section>
        
        <section class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-users"></i>
                    Daftar Penerima SHU per Anggota
                </h2>
                <div class="table-actions">
                    <button class="btn btn-outline btn-sm" id="exportPenerimaBtn" title="Export Data Penerima">
                        <i class="fas fa-file-excel"></i>
                    </button>
                </div>
            </div>
            
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: var(--space-lg);">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Anggota</div>
                        <div class="stat-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalAnggotaPenerima">0</div>
                    <div class="stat-detail">
                        <i class="fas fa-check-circle text-success"></i>
                        Aktif menerima SHU
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Rata-rata/Anggota</div>
                        <div class="stat-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="avgPerAnggota">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-coins"></i>
                        Berdasarkan simpanan
                    </div>
                </div>
            </div>
            
            <div class="card-view" id="penerimaCardView">
                <div class="shu-card" style="text-align: center;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
                    <p style="margin-top: 16px; color: var(--gray);">Memuat data penerima...</p>
                </div>
            </div>
        </section>
        
        <section class="table-section">
            <div class="action-buttons">
                <button class="action-btn" id="refreshDataBtn">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh Data</span>
                </button>
                <button class="action-btn" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i>
                    <span>Export Excel</span>
                </button>
                <button class="action-btn" id="exportPdfBtn">
                    <i class="fas fa-file-pdf"></i>
                    <span>Export PDF</span>
                </button>
                <button class="action-btn" id="viewChartBtn">
                    <i class="fas fa-chart-bar"></i>
                    <span>Lihat Chart</span>
                </button>
            </div>
        </section>
        
        <footer class="footer">
            <p>Â© 2026 Koperasi Asmara Tani</p>
            <p>Laporan SHU - Terintegrasi dengan Sistem Database</p>
            <p class="last-sync" id="lastSyncText">Terakhir sinkron: -</p>
        </footer>
    </div>
    
    <script>
        // ===== KONFIGURASI APPS SCRIPT =====
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2Lspxf4UB7x0KZ2GUCVQc-eEFmCCNsUXco5XcOlh2E2x0NDFqIOfx6Vji4oLu4ZuO/exec';
        
        // ===== STATE MANAGEMENT =====
        let shuData = [];
        let penerimaData = [];
        let anggotaData = [];
        let currentUser = null;
        let currentFilter = {
            tahun: '2024',
            periode: 'tahunan',
            status: 'all'
        };
        let chartInstance = null;
        let chartType = 'pie';

        // ===== INITIALIZE APP =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸ“± SHU Report Initializing with Apps Script integration...');
            
            // Load current user from localStorage
            loadCurrentUser();
            
            // Load data from Apps Script
            await loadDataFromAppsScript();
            
            // Setup event listeners
            setupEventListeners();
            
            // Apply initial filter
            applyFilter();
            
            // Sync with other pages
            setupDataSync();
            
            console.log('âœ… SHU Report Ready');
        });

        // ===== LOAD CURRENT USER =====
        function loadCurrentUser() {
            try {
                const userStr = localStorage.getItem('koperasi_current_user');
                if (userStr) {
                    currentUser = JSON.parse(userStr);
                    console.log('ðŸ‘¤ Current user:', currentUser.email);
                    
                    // Update header with user info
                    const headerTitle = document.querySelector('.header-title p');
                    if (headerTitle && currentUser.role) {
                        headerTitle.innerHTML = `${currentUser.role} - ${currentUser.email}`;
                    }
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        // ===== LOAD DATA FROM APPS SCRIPT =====
        async function loadDataFromAppsScript() {
            showLoading(true);
            
            try {
                // First, try to load from localStorage cache
                loadFromLocalCache();
                
                // Then fetch fresh data from Apps Script
                await fetchFromAppsScript();
                
                // Also load from dashboard if available
                loadFromDashboard();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Gagal memuat data dari server', 'error');
                generateSampleData();
            } finally {
                showLoading(false);
                updateLastSyncTime();
            }
        }

        function loadFromLocalCache() {
            try {
                const cachedSHU = localStorage.getItem('shuData_cache');
                const cachedPenerima = localStorage.getItem('penerimaData_cache');
                const cachedAnggota = localStorage.getItem('anggotaData_cache');
                
                if (cachedSHU) shuData = JSON.parse(cachedSHU);
                if (cachedPenerima) penerimaData = JSON.parse(cachedPenerima);
                if (cachedAnggota) anggotaData = JSON.parse(cachedAnggota);
                
                console.log('ðŸ“¦ Loaded from cache:', {
                    shu: shuData.length,
                    penerima: penerimaData.length,
                    anggota: anggotaData.length
                });
            } catch (error) {
                console.error('Error loading cache:', error);
            }
        }

        async function fetchFromAppsScript() {
            try {
                const tahun = document.getElementById('tahunSHU').value;
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'getSHUData',
                        tahun: tahun,
                        timestamp: new Date().toISOString(),
                        user: currentUser?.email || 'anonymous'
                    })
                });
                
                // Karena mode no-cors, kita tidak bisa membaca response
                // Tandai bahwa request sudah dikirim
                updateSyncStatus('sending');
                
                // Simulasi data dari server (dalam implementasi nyata, server akan mengirim response)
                setTimeout(() => {
                    // Data akan di-update melalui polling atau WebSocket
                    checkForUpdates();
                }, 2000);
                
            } catch (error) {
                console.error('Fetch error:', error);
                updateSyncStatus('error');
            }
        }

        function loadFromDashboard() {
            try {
                const dashboardData = localStorage.getItem('dashboardData');
                if (dashboardData) {
                    const data = JSON.parse(dashboardData);
                    
                    if (data.anggota && Array.isArray(data.anggota)) {
                        anggotaData = data.anggota;
                        console.log('ðŸ“Š Loaded anggota from dashboard:', anggotaData.length);
                    }
                    
                    if (data.shu) {
                        // Update SHU data from dashboard
                        if (data.shu.distribusi) {
                            shuData = data.shu.distribusi;
                        }
                        
                        // Update stats
                        updateStatsFromDashboard(data.shu);
                    }
                }
                
                // Load penerima from anggota data
                generatePenerimaFromAnggota();
                
            } catch (error) {
                console.error('Error loading from dashboard:', error);
            }
        }

        function generatePenerimaFromAnggota() {
            if (anggotaData.length === 0) {
                generateSamplePenerima();
                return;
            }
            
            const totalSHUAnggota = shuData.find(d => d.jenis === 'Dana Anggota')?.jumlah || 31362500;
            const totalSimpanan = anggotaData.reduce((sum, a) => sum + (a.totalSimpanan || 0), 0);
            
            penerimaData = anggotaData.map((anggota, index) => {
                const persentase = totalSimpanan > 0 ? (anggota.totalSimpanan / totalSimpanan) * 100 : 0;
                const shuDiterima = Math.round((persentase / 100) * totalSHUAnggota);
                
                return {
                    id: `P${(index + 1).toString().padStart(3, '0')}`,
                    noAnggota: anggota.nia || anggota.id || `AGT-${(index + 1).toString().padStart(3, '0')}`,
                    nama: anggota.nama || `Anggota ${index + 1}`,
                    simpananPokok: anggota.simpananPokok || 500000,
                    simpananWajib: anggota.simpananWajib || (index + 1) * 20000,
                    simpananSukarela: anggota.simpananSukarela || index * 100000,
                    totalSimpanan: anggota.totalSimpanan || 0,
                    shuDiterima: shuDiterima,
                    persentase: parseFloat(persentase.toFixed(2)),
                    tanggalTerima: new Date().toISOString().split('T')[0],
                    status: 'Diterima',
                    bukti: `SHU-${anggota.nia || anggota.id}-${new Date().getFullYear()}`
                };
            });
            
            // Sort by SHU received (highest first)
            penerimaData.sort((a, b) => b.shuDiterima - a.shuDiterima);
            
            console.log('ðŸ‘¥ Generated penerima from anggota:', penerimaData.length);
        }

        function updateStatsFromDashboard(shuFromDashboard) {
            if (shuFromDashboard) {
                document.getElementById('totalSHUDisplay').textContent = formatCurrency(shuFromDashboard.total || 0);
                document.getElementById('shuAnggotaDisplay').textContent = formatCurrency(shuFromDashboard.dibagikan || 0);
                document.getElementById('danaCadanganDisplay').textContent = formatCurrency(shuFromDashboard.cadangan || 0);
                
                const rataRata = shuFromDashboard.anggota > 0 ? 
                    Math.round(shuFromDashboard.dibagikan / shuFromDashboard.anggota) : 0;
                document.getElementById('rataRataSHU').textContent = formatCurrency(rataRata);
                document.getElementById('jumlahAnggotaSHU').textContent = shuFromDashboard.anggota || 0;
                
                if (shuFromDashboard.pertumbuhan) {
                    document.getElementById('growthPercent').textContent = `${shuFromDashboard.pertumbuhan}%`;
                }
            }
        }

        function generateSampleData() {
            console.log('ðŸ“ Generating sample SHU data...');
            
            shuData = [
                {
                    id: 'SHU-001',
                    jenis: 'Dana Cadangan',
                    persentase: 40,
                    jumlah: 50180000,
                    deskripsi: 'Dana untuk pengembangan koperasi',
                    status: 'Disetorkan',
                    sumber: 'Simpanan Anggota',
                    tanggal: '2024-12-31',
                    bukti: 'SHU-CAD-2024-001',
                    color: '#2e7d32'
                },
                {
                    id: 'SHU-002',
                    jenis: 'Dana Anggota',
                    persentase: 25,
                    jumlah: 31362500,
                    deskripsi: 'Dibagikan kepada anggota sesuai simpanan',
                    status: 'Dibagikan',
                    sumber: 'Simpanan Anggota',
                    tanggal: '2024-12-31',
                    bukti: 'SHU-ANG-2024-001',
                    color: '#2196f3'
                },
                {
                    id: 'SHU-003',
                    jenis: 'Dana Pengurus',
                    persentase: 10,
                    jumlah: 12545000,
                    deskripsi: 'Honorarium pengurus koperasi',
                    status: 'Dibayarkan',
                    sumber: 'Simpanan Anggota',
                    tanggal: '2024-12-31',
                    bukti: 'SHU-PEN-2024-001',
                    color: '#ff9800'
                },
                {
                    id: 'SHU-004',
                    jenis: 'Dana Karyawan',
                    persentase: 5,
                    jumlah: 6272500,
                    deskripsi: 'Bonus untuk karyawan',
                    status: 'Dibayarkan',
                    sumber: 'Simpanan Anggota',
                    tanggal: '2024-12-31',
                    bukti: 'SHU-KAR-2024-001',
                    color: '#9c27b0'
                },
                {
                    id: 'SHU-005',
                    jenis: 'Dana Pendidikan',
                    persentase: 5,
                    jumlah: 6272500,
                    deskripsi: 'Program pendidikan anggota',
                    status: 'Dialokasikan',
                    sumber: 'Simpanan Anggota',
                    tanggal: '2024-12-31',
                    bukti: 'SHU-PDK-2024-001',
                    color: '#00bcd4'
                },
                {
                    id: 'SHU-006',
                    jenis: 'Dana Sosial',
                    persentase: 5,
                    jumlah: 6272500,
                    deskripsi: 'Kegiatan sosial kemasyarakatan',
                    status: 'Dialokasikan',
                    sumber: 'Simpanan Anggota',
                    tanggal: '2024-12-31',
                    bukti: 'SHU-SOS-2024-001',
                    color: '#ff5722'
                },
                {
                    id: 'SHU-007',
                    jenis: 'Dana Pembangunan',
                    persentase: 10,
                    jumlah: 12545000,
                    deskripsi: 'Pengembangan sarana prasarana',
                    status: 'Dialokasikan',
                    sumber: 'Simpanan Anggota',
                    tanggal: '2024-12-31',
                    bukti: 'SHU-BNG-2024-001',
                    color: '#795548'
                }
            ];
            
            console.log('âœ… Sample SHU data generated');
        }

        function generateSamplePenerima() {
            console.log('ðŸ“ Generating sample penerima data...');
            
            penerimaData = [
                {
                    id: 'P001',
                    nama: 'Budi Santoso',
                    noAnggota: '#01-2026-001',
                    simpananPokok: 500000,
                    simpananWajib: 1200000,
                    simpananSukarela: 800000,
                    totalSimpanan: 2500000,
                    shuDiterima: 843750,
                    persentase: 3.2,
                    tanggalTerima: '2024-12-15',
                    status: 'Diterima',
                    bukti: 'SHU-001-2024'
                },
                {
                    id: 'P002',
                    nama: 'Siti Rahayu',
                    noAnggota: '#01-2026-002',
                    simpananPokok: 500000,
                    simpananWajib: 1800000,
                    simpananSukarela: 1200000,
                    totalSimpanan: 3500000,
                    shuDiterima: 1181250,
                    persentase: 4.5,
                    tanggalTerima: '2024-12-15',
                    status: 'Diterima',
                    bukti: 'SHU-002-2024'
                },
                {
                    id: 'P003',
                    nama: 'Agus Wijaya',
                    noAnggota: '#01-2026-003',
                    simpananPokok: 500000,
                    simpananWajib: 2400000,
                    simpananSukarela: 1600000,
                    totalSimpanan: 4500000,
                    shuDiterima: 1518750,
                    persentase: 5.8,
                    tanggalTerima: '2024-12-16',
                    status: 'Diterima',
                    bukti: 'SHU-003-2024'
                }
            ];
            
            console.log('âœ… Sample penerima data generated');
        }

        // ===== UPDATE STATISTICS =====
        function updateStats() {
            const totalSHU = shuData.reduce((sum, item) => sum + (item.jumlah || 0), 0);
            const shuAnggota = shuData.find(item => item.jenis === 'Dana Anggota')?.jumlah || 0;
            const danaCadangan = shuData.find(item => item.jenis === 'Dana Cadangan')?.jumlah || 0;
            const totalAnggota = penerimaData.length || anggotaData.length || 48;
            const rataRata = totalAnggota > 0 ? Math.round(shuAnggota / totalAnggota) : 0;
            
            document.getElementById('totalSHUDisplay').textContent = formatCurrency(totalSHU);
            document.getElementById('shuAnggotaDisplay').textContent = formatCurrency(shuAnggota);
            document.getElementById('danaCadanganDisplay').textContent = formatCurrency(danaCadangan);
            document.getElementById('rataRataSHU').textContent = formatCurrency(rataRata);
            document.getElementById('jumlahAnggotaSHU').textContent = totalAnggota;
            
            // Update growth percent (simulasi)
            const growth = ((totalSHU / (totalSHU * 0.85)) - 1) * 100;
            document.getElementById('growthPercent').textContent = growth.toFixed(1) + '%';
            
            // Update penerima stats
            document.getElementById('totalAnggotaPenerima').textContent = totalAnggota;
            document.getElementById('avgPerAnggota').textContent = formatCurrency(rataRata);
        }

        // ===== APPLY FILTER =====
        function applyFilter() {
            const tahun = document.getElementById('tahunSHU').value;
            const periode = document.getElementById('periodeSHU').value;
            const status = document.getElementById('statusSHU').value;
            
            currentFilter = { tahun, periode, status };
            
            // Filter SHU data
            let filteredSHU = [...shuData];
            
            if (status !== 'all') {
                filteredSHU = filteredSHU.filter(item => 
                    item.status.toLowerCase().includes(status.toLowerCase())
                );
            }
            
            // Filter penerima berdasarkan tahun (simulasi)
            let filteredPenerima = [...penerimaData];
            
            // Apply multiplier based on year
            const yearMultiplier = {
                '2024': 1,
                '2023': 0.85,
                '2022': 0.72,
                '2021': 0.65
            };
            
            const multiplier = yearMultiplier[tahun] || 1;
            
            // Update displays
            displaySHUData(filteredSHU, multiplier);
            displayPenerimaData(filteredPenerima, multiplier);
            updateStats();
            
            // Save filter to localStorage
            localStorage.setItem('shu_last_filter', JSON.stringify(currentFilter));
            
            showMessage(`Filter diterapkan: ${tahun}`, 'info');
        }

        // ===== DISPLAY SHU DATA =====
        function displaySHUData(data, multiplier = 1) {
            const tableBody = document.getElementById('shuTableBody');
            const cardView = document.getElementById('shuCardView');
            
            tableBody.innerHTML = '';
            cardView.innerHTML = '';
            
            if (data.length === 0) {
                const emptyMessage = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 16px;"></i>
                            <p style="color: var(--gray);">Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML = emptyMessage;
                
                cardView.innerHTML = `
                    <div class="shu-card" style="text-align: center;">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 16px;"></i>
                        <p style="color: var(--gray);">Tidak ada data</p>
                    </div>
                `;
                return;
            }
            
            data.forEach((item) => {
                const adjustedAmount = Math.round(item.jumlah * multiplier);
                
                let badgeClass = 'badge-info';
                let badgeIcon = 'fa-info-circle';
                
                if (item.status === 'Disetorkan') {
                    badgeClass = 'badge-success';
                    badgeIcon = 'fa-check-circle';
                } else if (item.status === 'Dibagikan') {
                    badgeClass = 'badge-warning';
                    badgeIcon = 'fa-share-alt';
                } else if (item.status === 'Dibayarkan') {
                    badgeClass = 'badge-info';
                    badgeIcon = 'fa-money-bill-wave';
                }
                
                // Table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Jenis">
                        <div style="font-weight: 600; color: var(--primary-dark);">${item.jenis}</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">${item.deskripsi}</div>
                    </td>
                    <td data-label="Persentase">
                        <div style="font-weight: 700; color: var(--primary);">${item.persentase}%</div>
                        <div style="width: 60px; height: 4px; background: var(--gray-light); border-radius: 2px; margin-top: 4px;">
                            <div style="width: ${item.persentase}%; height: 100%; background: var(--primary); border-radius: 2px;"></div>
                        </div>
                    </td>
                    <td data-label="Jumlah">
                        <div style="font-weight: 700; color: var(--dark);">${formatCurrency(adjustedAmount)}</div>
                    </td>
                    <td data-label="Status">
                        <span class="badge ${badgeClass}">
                            <i class="fas ${badgeIcon}"></i>
                            ${item.status}
                        </span>
                    </td>
                    <td data-label="Aksi">
                        <button class="action-btn btn-sm" onclick="showDetail('${item.id}')" title="Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
                
                // Card view
                const card = document.createElement('div');
                card.className = 'shu-card';
                card.style.borderLeftColor = item.color || '#2e7d32';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <h3>${item.jenis}</h3>
                            <span class="card-badge">${item.persentase}%</span>
                        </div>
                        <span class="badge ${badgeClass}">
                            ${item.status}
                        </span>
                    </div>
                    
                    <div class="card-content">
                        <div class="card-item">
                            <div class="card-label">Jumlah</div>
                            <div class="card-value">${formatCurrency(adjustedAmount)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Sumber</div>
                            <div class="card-value">${item.sumber}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Tanggal</div>
                            <div class="card-value">${item.tanggal}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">No. Bukti</div>
                            <div class="card-value">${item.bukti}</div>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="action-btn" onclick="showDetail('${item.id}')">
                            <i class="fas fa-eye"></i>
                            <span>Detail</span>
                        </button>
                        <button class="action-btn" onclick="printItem('${item.id}')">
                            <i class="fas fa-print"></i>
                            <span>Cetak</span>
                        </button>
                    </div>
                `;
                cardView.appendChild(card);
            });
        }

        // ===== DISPLAY PENERIMA DATA =====
        function displayPenerimaData(data, multiplier = 1) {
            const cardView = document.getElementById('penerimaCardView');
            cardView.innerHTML = '';
            
            if (data.length === 0) {
                cardView.innerHTML = `
                    <div class="shu-card" style="text-align: center;">
                        <i class="fas fa-users" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 16px;"></i>
                        <p style="color: var(--gray);">Tidak ada data penerima</p>
                    </div>
                `;
                return;
            }
            
            data.forEach((anggota) => {
                const adjustedSHU = Math.round(anggota.shuDiterima * multiplier);
                
                const card = document.createElement('div');
                card.className = 'shu-card';
                card.style.borderLeftColor = '#2e7d32';
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <h3>${anggota.nama}</h3>
                            <span class="card-badge">${anggota.noAnggota}</span>
                        </div>
                        <span class="badge badge-success">
                            <i class="fas fa-check-circle"></i>
                            ${anggota.status}
                        </span>
                    </div>
                    
                    <div class="card-content">
                        <div class="card-item">
                            <div class="card-label">Total Simpanan</div>
                            <div class="card-value">${formatCurrency(anggota.totalSimpanan)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">SHU Diterima</div>
                            <div class="card-value text-success fw-bold">${formatCurrency(adjustedSHU)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Persentase</div>
                            <div class="card-value">${anggota.persentase}%</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Tanggal</div>
                            <div class="card-value">${anggota.tanggalTerima}</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--gray-lighter); border-radius: var(--radius-sm); padding: var(--space-sm); margin-bottom: var(--space-md);">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                            <span>Pokok: ${formatCurrency(anggota.simpananPokok)}</span>
                            <span>Wajib: ${formatCurrency(anggota.simpananWajib)}</span>
                            <span>Sukarela: ${formatCurrency(anggota.simpananSukarela)}</span>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="action-btn" onclick="showDetailPenerima('${anggota.id}')">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Detail</span>
                        </button>
                        <button class="action-btn" onclick="printKwitansi('${anggota.id}')">
                            <i class="fas fa-receipt"></i>
                            <span>Kwitansi</span>
                        </button>
                    </div>
                `;
                
                cardView.appendChild(card);
            });
        }

        // ===== SHOW DETAIL =====
        function showDetail(itemId) {
            const item = shuData.find(d => d.id === itemId);
            if (!item) return;
            
            const detailHTML = `
                <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); max-width: 500px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--primary-dark); font-size: 1.2rem;">Detail SHU</h3>
                        <button class="back-button" onclick="closeModal()" style="background: var(--gray-lighter); color: var(--gray);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Jenis Alokasi</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-dark);">${item.jenis}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Persentase</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">${item.persentase}%</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Jumlah</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary-dark);">${formatCurrency(item.jumlah)}</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Status</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">${item.status}</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Tanggal</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary-dark);">${item.tanggal}</div>
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 8px;">Deskripsi</div>
                        <div style="color: var(--dark); line-height: 1.6;">${item.deskripsi}</div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-sm);">
                        <button class="btn btn-primary" style="flex: 1;" onclick="printItem('${item.id}')">
                            <i class="fas fa-print"></i>
                            Cetak Detail
                        </button>
                        <button class="btn btn-outline" onclick="closeModal()">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            showModal(detailHTML);
        }

        function showDetailPenerima(id) {
            const anggota = penerimaData.find(a => a.id === id);
            if (!anggota) return;
            
            const detailHTML = `
                <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); max-width: 500px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--primary-dark); font-size: 1.2rem;">Detail Penerima SHU</h3>
                        <button class="back-button" onclick="closeModal()" style="background: var(--gray-lighter); color: var(--gray);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Nama Anggota</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary-dark);">${anggota.nama}</div>
                        <div style="font-size: 0.9rem; color: var(--gray); margin-top: 4px;">No. Anggota: ${anggota.noAnggota}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Total Simpanan</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary-dark);">${formatCurrency(anggota.totalSimpanan)}</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">SHU Diterima</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--success);">${formatCurrency(anggota.shuDiterima)}</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Persentase</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">${anggota.persentase}%</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 4px;">Tanggal Terima</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary-dark);">${anggota.tanggalTerima}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <h4 style="color: var(--primary-dark); margin-bottom: var(--space-sm);">Rincian Simpanan</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm);">
                            <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-sm); text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--gray);">Pokok</div>
                                <div style="font-weight: 600;">${formatCurrency(anggota.simpananPokok)}</div>
                            </div>
                            <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-sm); text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--gray);">Wajib</div>
                                <div style="font-weight: 600;">${formatCurrency(anggota.simpananWajib)}</div>
                            </div>
                            <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-sm); text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--gray);">Sukarela</div>
                                <div style="font-weight: 600;">${formatCurrency(anggota.simpananSukarela)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-sm);">
                        <button class="btn btn-primary" style="flex: 1;" onclick="printKwitansi('${anggota.id}')">
                            <i class="fas fa-receipt"></i>
                            Cetak Kwitansi
                        </button>
                        <button class="btn btn-outline" onclick="closeModal()">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            showModal(detailHTML);
        }

        function showModal(content) {
            closeModal(); // Remove existing modal
            
            const overlay = document.createElement('div');
            overlay.id = 'modalOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: var(--space-md);
                animation: fadeIn 0.3s ease;
                overflow-y: auto;
            `;
            
            overlay.innerHTML = content;
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.remove();
                document.body.style.overflow = '';
            }
        }

        // ===== PRINT FUNCTIONS =====
        function printItem(itemId) {
            const item = shuData.find(d => d.id === itemId);
            if (!item) return;
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Detail SHU - ${item.jenis}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2e7d32; padding-bottom: 20px; }
                        h1 { color: #2e7d32; font-size: 24px; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
                        .info-item { background: #f5f5f5; padding: 15px; border-radius: 8px; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>KOPERASI ASMARA TANI</h1>
                        <h2>Detail Distribusi SHU</h2>
                        <p>Dicetak dari Sistem Laporan SHU</p>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Jenis Alokasi</strong><br>
                            ${item.jenis}
                        </div>
                        <div class="info-item">
                            <strong>Jumlah</strong><br>
                            ${formatCurrency(item.jumlah)}
                        </div>
                        <div class="info-item">
                            <strong>Persentase</strong><br>
                            ${item.persentase}%
                        </div>
                        <div class="info-item">
                            <strong>Status</strong><br>
                            ${item.status}
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <strong>Deskripsi:</strong>
                        <p>${item.deskripsi}</p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <strong>Informasi Tambahan:</strong>
                        <p>No. Bukti: ${item.bukti}</p>
                        <p>Tanggal: ${item.tanggal}</p>
                        <p>Sumber: ${item.sumber}</p>
                    </div>
                    
                    <div class="footer">
                        <p>Dicetak dari Sistem Laporan SHU - Koperasi Asmara Tani</p>
                        <p>Tanggal cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                </body>
                </html>
            `;
            
            printDocument(printContent);
        }

        function printKwitansi(id) {
            const anggota = penerimaData.find(a => a.id === id);
            if (!anggota) return;
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Kwitansi SHU - ${anggota.nama}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2e7d32; padding-bottom: 20px; }
                        h1 { color: #2e7d32; font-size: 24px; }
                        h2 { color: #333; font-size: 20px; margin-bottom: 5px; }
                        .content { margin: 30px 0; }
                        .info-item { margin-bottom: 10px; }
                        .info-label { font-weight: bold; color: #666; width: 200px; display: inline-block; }
                        .amount { font-size: 28px; font-weight: bold; color: #2e7d32; text-align: center; margin: 30px 0; }
                        .signature { margin-top: 50px; display: flex; justify-content: space-between; }
                        .signature-box { width: 300px; text-align: center; }
                        .signature-line { border-top: 1px solid #000; width: 200px; margin: 0 auto; padding-top: 10px; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>KOPERASI ASMARA TANI</h1>
                        <h2>BUKTI PENERIMAAN SHU</h2>
                        <p>Tahun Anggaran ${currentFilter.tahun}</p>
                    </div>
                    
                    <div class="content">
                        <div class="info-item">
                            <span class="info-label">No. Kwitansi:</span> ${anggota.bukti}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tanggal:</span> ${anggota.tanggalTerima}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Nama Anggota:</span> ${anggota.nama}
                        </div>
                        <div class="info-item">
                            <span class="info-label">No. Anggota:</span> ${anggota.noAnggota}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Simpanan:</span> ${formatCurrency(anggota.totalSimpanan)}
                        </div>
                        <div class="info-item">
                            <span class="info-label">Persentase SHU:</span> ${anggota.persentase}%
                        </div>
                        
                        <div class="amount">
                            Jumlah SHU yang diterima:<br>
                            ${formatCurrency(anggota.shuDiterima)}
                        </div>
                        
                        <div style="text-align: center; margin: 20px 0;">
                            <p>Terbilang: <em>${terbilang(anggota.shuDiterima)} rupiah</em></p>
                        </div>
                    </div>
                    
                    <div class="signature">
                        <div class="signature-box">
                            <p>Penerima,</p>
                            <div class="signature-line"></div>
                            <p><strong>${anggota.nama}</strong></p>
                        </div>
                        <div class="signature-box">
                            <p>Bendahara Koperasi,</p>
                            <div class="signature-line"></div>
                            <p><strong>Koperasi Asmara Tani</strong></p>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Kwitansi ini sebagai bukti sah penerimaan Sisa Hasil Usaha</p>
                        <p>Dicetak dari Sistem Laporan SHU - ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                </body>
                </html>
            `;
            
            printDocument(printContent);
        }

        function printDocument(content) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function printReport() {
            const totalSHU = shuData.reduce((sum, item) => sum + item.jumlah, 0);
            
            let tableRows = '';
            shuData.forEach((item, index) => {
                tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.jenis}</td>
                        <td>${item.persentase}%</td>
                        <td>${formatCurrency(item.jumlah)}</td>
                        <td>${item.status}</td>
                    </tr>
                `;
            });
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan SHU ${currentFilter.tahun}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2e7d32; padding-bottom: 20px; }
                        h1 { color: #2e7d32; font-size: 24px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th { background: #2e7d32; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border-bottom: 1px solid #ddd; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 30px 0; }
                        .summary-item { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>KOPERASI ASMARA TANI</h1>
                        <h2>LAPORAN SISA HASIL USAHA (SHU)</h2>
                        <p>Tahun ${currentFilter.tahun} | Total SHU: ${formatCurrency(totalSHU)}</p>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <strong>Total SHU</strong><br>
                            ${formatCurrency(totalSHU)}
                        </div>
                        <div class="summary-item">
                            <strong>SHU Anggota</strong><br>
                            ${formatCurrency(shuData.find(d => d.jenis === 'Dana Anggota')?.jumlah || 0)}
                        </div>
                        <div class="summary-item">
                            <strong>Dana Cadangan</strong><br>
                            ${formatCurrency(shuData.find(d => d.jenis === 'Dana Cadangan')?.jumlah || 0)}
                        </div>
                        <div class="summary-item">
                            <strong>Jumlah Anggota</strong><br>
                            ${penerimaData.length}
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Jenis Alokasi</th>
                                <th>Persentase</th>
                                <th>Jumlah</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Dicetak dari Sistem Laporan SHU - Koperasi Asmara Tani</p>
                        <p>Tanggal cetak: ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                </body>
                </html>
            `;
            
            printDocument(printContent);
        }

        // ===== EXPORT FUNCTIONS =====
        function exportToExcel() {
            try {
                const exportData = shuData.map(item => ({
                    'Jenis Alokasi': item.jenis,
                    'Persentase (%)': item.persentase,
                    'Jumlah (Rp)': item.jumlah,
                    'Deskripsi': item.deskripsi,
                    'Status': item.status,
                    'Sumber Dana': item.sumber,
                    'Tanggal': item.tanggal,
                    'No. Bukti': item.bukti
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Laporan SHU');
                
                XLSX.writeFile(wb, `Laporan_SHU_${currentFilter.tahun}.xlsx`);
                
                showMessage('Laporan berhasil diexport ke Excel!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Gagal mengekspor data!', 'error');
            }
        }

        function exportPenerimaToExcel() {
            try {
                const exportData = penerimaData.map(anggota => ({
                    'No. Anggota': anggota.noAnggota,
                    'Nama Anggota': anggota.nama,
                    'Simpanan Pokok': anggota.simpananPokok,
                    'Simpanan Wajib': anggota.simpananWajib,
                    'Simpanan Sukarela': anggota.simpananSukarela,
                    'Total Simpanan': anggota.totalSimpanan,
                    'SHU Diterima': anggota.shuDiterima,
                    'Persentase (%)': anggota.persentase,
                    'Tanggal Terima': anggota.tanggalTerima,
                    'Status': anggota.status,
                    'No. Bukti': anggota.bukti
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Penerima SHU');
                
                XLSX.writeFile(wb, `Penerima_SHU_${currentFilter.tahun}.xlsx`);
                
                showMessage('Data penerima berhasil diexport ke Excel!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Gagal mengekspor data penerima!', 'error');
            }
        }

        // ===== CHART FUNCTIONS =====
        function showChartModal() {
            const totalSHU = shuData.reduce((sum, item) => sum + (item.jumlah || 0), 0);
            
            const chartHTML = `
                <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); width: 95%; max-width: 500px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--primary-dark); font-size: 1.2rem;">
                            <i class="fas fa-chart-pie"></i> Visualisasi Distribusi SHU
                        </h3>
                        <button class="back-button" onclick="closeModal()" style="background: var(--gray-lighter); color: var(--gray);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <div style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-md);">
                            <button class="btn btn-sm ${chartType === 'pie' ? 'btn-primary' : 'btn-outline'}" 
                                    onclick="changeChartType('pie')">
                                <i class="fas fa-chart-pie"></i> Pie
                            </button>
                            <button class="btn btn-sm ${chartType === 'bar' ? 'btn-primary' : 'btn-outline'}" 
                                    onclick="changeChartType('bar')">
                                <i class="fas fa-chart-bar"></i> Bar
                            </button>
                            <button class="btn btn-sm ${chartType === 'doughnut' ? 'btn-primary' : 'btn-outline'}" 
                                    onclick="changeChartType('doughnut')">
                                <i class="fas fa-chart-pie"></i> Donat
                            </button>
                        </div>
                        
                        <div style="position: relative; height: 300px;">
                            <canvas id="shuChartCanvas"></canvas>
                        </div>
                        
                        <div style="text-align: center; margin-top: var(--space-md); color: var(--gray); font-size: 0.9rem;">
                            Total SHU: <strong>${formatCurrency(totalSHU)}</strong>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm);">
                        ${shuData.map(item => `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                                <div style="width: 12px; height: 12px; border-radius: 2px; background: ${item.color || '#2e7d32'}"></div>
                                <div style="font-size: 0.85rem; flex: 1;">${item.jenis}</div>
                                <div style="font-weight: 600; font-size: 0.85rem;">${item.persentase}%</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            showModal(chartHTML);
            
            // Initialize chart after modal is shown
            setTimeout(() => {
                renderChart(chartType);
            }, 100);
        }

        function renderChart(type) {
            chartType = type;
            
            const canvas = document.getElementById('shuChartCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const labels = shuData.map(item => item.jenis);
            const data = shuData.map(item => item.jumlah);
            const colors = shuData.map(item => item.color || '#2e7d32');
            const percentages = shuData.map(item => item.persentase);
            
            chartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'white',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = percentages[context.dataIndex] || 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function changeChartType(type) {
            renderChart(type);
            
            // Update button states
            const buttons = document.querySelectorAll('#modalOverlay .btn-sm');
            buttons.forEach(btn => {
                btn.className = btn.className.replace('btn-primary', 'btn-outline');
            });
            
            const activeBtn = document.querySelector(`#modalOverlay button[onclick="changeChartType('${type}')"]`);
            if (activeBtn) {
                activeBtn.className = activeBtn.className.replace('btn-outline', 'btn-primary');
            }
        }

        // ===== DATA SYNC =====
        function setupDataSync() {
            // Listen for storage events (updates from other tabs)
            window.addEventListener('storage', function(e) {
                if (e.key === 'dashboardData' || e.key === 'shuData_cache' || e.key === 'anggotaData_cache') {
                    console.log('ðŸ”„ Data updated from another tab, reloading...');
                    loadFromLocalCache();
                    loadFromDashboard();
                    applyFilter();
                    showMessage('Data diperbarui dari sistem', 'info');
                }
            });
            
            // Check for updates every 30 seconds
            setInterval(() => {
                checkForUpdates();
            }, 30000);
        }

        async function checkForUpdates() {
            try {
                // Try to fetch latest data from Apps Script
                await fetchFromAppsScript();
                
                // Also check dashboard
                loadFromDashboard();
                
                // Update display
                applyFilter();
                
            } catch (error) {
                console.error('Update check failed:', error);
            }
        }

        async function sendToAppsScript(data) {
            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...data,
                        timestamp: new Date().toISOString(),
                        user: currentUser?.email || 'anonymous'
                    })
                });
                
                updateSyncStatus('sent');
                
            } catch (error) {
                console.error('Send to Apps Script failed:', error);
                updateSyncStatus('error');
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            if (!amount) return 'Rp 0';
            return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function terbilang(angka) {
            const bilangan = ['', 'satu', 'dua', 'tiga', 'empat', 'lima', 'enam', 'tujuh', 'delapan', 'sembilan', 'sepuluh', 'sebelas'];
            
            if (angka < 12) return bilangan[angka];
            if (angka < 20) return terbilang(angka - 10) + ' belas';
            if (angka < 100) return terbilang(Math.floor(angka / 10)) + ' puluh ' + terbilang(angka % 10);
            if (angka < 200) return 'seratus ' + terbilang(angka - 100);
            if (angka < 1000) return terbilang(Math.floor(angka / 100)) + ' ratus ' + terbilang(angka % 100);
            if (angka < 2000) return 'seribu ' + terbilang(angka - 1000);
            if (angka < 1000000) return terbilang(Math.floor(angka / 1000)) + ' ribu ' + terbilang(angka % 1000);
            if (angka < 1000000000) return terbilang(Math.floor(angka / 1000000)) + ' juta ' + terbilang(angka % 1000000);
            
            return 'jumlah besar';
        }

        function showMessage(message, type = 'info') {
            const existingMsg = document.getElementById('flashMessage');
            if (existingMsg) existingMsg.remove();
            
            const msg = document.createElement('div');
            msg.id = 'flashMessage';
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                color: white;
                padding: 12px 20px;
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 300px;
            `;
            
            msg.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(msg);
            
            setTimeout(() => {
                msg.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }

        function showLoading(show) {
            const syncIcon = document.querySelector('.sync-status i');
            if (syncIcon) {
                if (show) {
                    syncIcon.className = 'fas fa-spinner fa-spin';
                } else {
                    syncIcon.className = 'fas fa-sync-alt';
                }
            }
        }

        function updateSyncStatus(status) {
            const syncIcon = document.querySelector('.sync-status i');
            if (!syncIcon) return;
            
            switch(status) {
                case 'sending':
                    syncIcon.className = 'fas fa-spinner fa-spin';
                    syncIcon.style.color = '#ffd700';
                    break;
                case 'sent':
                    syncIcon.className = 'fas fa-check-circle';
                    syncIcon.style.color = '#4caf50';
                    setTimeout(() => {
                        syncIcon.className = 'fas fa-sync-alt';
                        syncIcon.style.color = 'white';
                    }, 2000);
                    break;
                case 'error':
                    syncIcon.className = 'fas fa-exclamation-triangle';
                    syncIcon.style.color = '#f44336';
                    setTimeout(() => {
                        syncIcon.className = 'fas fa-sync-alt';
                        syncIcon.style.color = 'white';
                    }, 2000);
                    break;
                default:
                    syncIcon.className = 'fas fa-sync-alt';
                    syncIcon.style.color = 'white';
            }
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit' 
            });
            
            const syncText = document.getElementById('lastSyncText');
            if (syncText) {
                syncText.textContent = `Terakhir sinkron: ${timeStr}`;
            }
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'dashboard-admin.html';
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
            
            document.getElementById('resetFilterBtn').addEventListener('click', function() {
                document.getElementById('tahunSHU').value = '2024';
                document.getElementById('periodeSHU').value = 'tahunan';
                document.getElementById('statusSHU').value = 'all';
                applyFilter();
                showMessage('Filter direset ke default', 'info');
            });
            
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportPdfBtn').addEventListener('click', () => {
                showMessage('Fitur export PDF akan segera tersedia', 'info');
            });
            document.getElementById('printBtn').addEventListener('click', printReport);
            document.getElementById('exportPenerimaBtn').addEventListener('click', exportPenerimaToExcel);
            document.getElementById('refreshDataBtn').addEventListener('click', async function() {
                showLoading(true);
                await loadDataFromAppsScript();
                applyFilter();
                showLoading(false);
                showMessage('Data diperbarui', 'success');
            });
            document.getElementById('viewChartBtn').addEventListener('click', showChartModal);
            
            // Auto-apply filter on select change
            document.getElementById('tahunSHU').addEventListener('change', applyFilter);
            document.getElementById('periodeSHU').addEventListener('change', applyFilter);
            document.getElementById('statusSHU').addEventListener('change', applyFilter);
            
            // Load last filter from localStorage
            const lastFilter = localStorage.getItem('shu_last_filter');
            if (lastFilter) {
                try {
                    const filter = JSON.parse(lastFilter);
                    document.getElementById('tahunSHU').value = filter.tahun || '2024';
                    document.getElementById('periodeSHU').value = filter.periode || 'tahunan';
                    document.getElementById('statusSHU').value = filter.status || 'all';
                } catch (e) {
                    console.error('Error loading last filter:', e);
                }
            }
            
            // Touch events for mobile
            document.querySelectorAll('.action-btn, .btn').forEach(btn => {
                btn.addEventListener('touchstart', function() {
                    this.style.transform = 'translateY(1px)';
                });
                btn.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
            
            // Close modal on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // Add slide animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
