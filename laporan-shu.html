<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laporan SHU - Koperasi Asmara Tani</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ===== VARIABEL DESAIN MOBILE FIRST ===== */
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --accent: #00bcd4;
            --info: #2196f3;
            --success: #4caf50;
            --warning: #ffc107;
            --danger: #f44336;
            --gray: #757575;
            --gray-light: #e0e0e0;
            --gray-lighter: #f5f5f5;
            --dark: #121212;
            --light: #ffffff;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 14px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .mobile-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* ===== HEADER SECTION ===== */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: var(--space-lg) var(--space-md);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
        }
        
        .header-title {
            flex: 1;
        }
        
        .header-title h1 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .header-title p {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .back-button {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        /* ===== FILTER SECTION ===== */
        .filter-section {
            background: white;
            margin: var(--space-md);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }
        
        .filter-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        
        .filter-title i {
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .filter-title h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .filter-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
        }
        
        .filter-group {
            flex: 1;
            min-width: calc(50% - 8px);
        }
        
        .filter-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 6px;
        }
        
        .filter-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            background: white;
            color: var(--dark);
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        /* ===== STATS SECTION ===== */
        .stats-section {
            padding: 0 var(--space-md) var(--space-md);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--primary-light));
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }
        
        .stat-title {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: 500;
            line-height: 1.4;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .stat-detail {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
        }
        
        /* ===== TABLE SECTION ===== */
        .table-section {
            padding: 0 var(--space-md) var(--space-md);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding: 0 var(--space-sm);
        }
        
        .table-header h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .table-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0;
        }
        
        .mobile-table {
            width: 100%;
            min-width: 320px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .mobile-table thead {
            display: none;
        }
        
        .mobile-table tbody tr {
            display: block;
            border-bottom: 1px solid var(--gray-lighter);
            padding: var(--space-md);
            transition: background-color 0.2s ease;
        }
        
        .mobile-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .mobile-table td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border: none;
            position: relative;
        }
        
        .mobile-table td::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--gray);
            font-size: 0.85rem;
            min-width: 100px;
            padding-right: var(--space-sm);
        }
        
        .mobile-table td .cell-content {
            flex: 1;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .card-view {
            display: none;
        }
        
        .shu-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }
        
        .card-title {
            flex: 1;
        }
        
        .card-title h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }
        
        .card-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: var(--space-sm);
        }
        
        .card-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .card-item {
            display: flex;
            flex-direction: column;
        }
        
        .card-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 4px;
        }
        
        .card-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
            padding-top: var(--space-md);
            border-top: 1px solid var(--gray-lighter);
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            min-height: 44px;
            min-width: 44px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            box-shadow: 0 6px 16px rgba(46, 125, 50, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
            min-height: 36px;
            min-width: 36px;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1;
        }
        
        .badge-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .badge-warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #e6a700;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .badge-info {
            background-color: rgba(33, 150, 243, 0.1);
            color: var(--info);
            border: 1px solid rgba(33, 150, 243, 0.2);
        }
        
        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--gray);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: var(--gray-lighter);
            color: var(--primary);
            border-color: var(--primary-light);
        }
        
        .footer {
            background: white;
            padding: var(--space-lg) var(--space-md);
            text-align: center;
            color: var(--gray);
            font-size: 0.85rem;
            border-top: 1px solid var(--gray-lighter);
            margin-top: var(--space-xl);
        }
        
        .text-success {
            color: var(--success);
        }
        
        .fw-bold {
            font-weight: 700;
        }
        
        /* Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: var(--space-md);
            padding: var(--space-sm);
            background: rgba(46, 125, 50, 0.05);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .sync-status .badge {
            padding: 4px 8px;
            font-size: 0.75rem;
        }
        
        @media screen and (min-width: 768px) {
            html {
                font-size: 15px;
            }
            
            .mobile-container {
                max-width: 720px;
                padding: 0 var(--space-md);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .filter-row {
                flex-wrap: nowrap;
            }
            
            .filter-group {
                min-width: auto;
            }
            
            .mobile-table thead {
                display: table-header-group;
            }
            
            .mobile-table thead th {
                background: rgba(46, 125, 50, 0.05);
                color: var(--primary-dark);
                font-weight: 600;
                padding: 14px 16px;
                text-align: left;
                font-size: 0.9rem;
                border-bottom: 2px solid var(--primary-light);
            }
            
            .mobile-table tbody tr {
                display: table-row;
                padding: 0;
            }
            
            .mobile-table td {
                display: table-cell;
                padding: 14px 16px;
                border-bottom: 1px solid var(--gray-lighter);
                text-align: left;
            }
            
            .mobile-table td::before {
                display: none;
            }
            
            .mobile-table td .cell-content {
                text-align: left;
            }
        }
        
        @media screen and (max-width: 360px) {
            .table-container {
                display: none;
            }
            
            .card-view {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- HEADER -->
        <header class="header">
            <div class="header-content">
                <button class="back-button" onclick="window.location.href='dashboard-admin.html'">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="header-title">
                    <h1>Laporan SHU</h1>
                    <p>Sisa Hasil Usaha - Koperasi Asmara Tani</p>
                </div>
                <button class="back-button" onclick="refreshData()" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </header>
        
        <!-- FILTER SECTION -->
        <section class="filter-section">
            <div class="filter-title">
                <i class="fas fa-filter"></i>
                <h2>Filter Laporan</h2>
            </div>
            
            <div class="filter-grid">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Tahun</label>
                        <select class="filter-select" id="tahunSHU">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Periode</label>
                        <select class="filter-select" id="periodeSHU">
                            <option value="tahunan">Tahunan</option>
                            <option value="semester1">Semester 1</option>
                            <option value="semester2">Semester 2</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" id="applyFilterBtn" style="flex: 1;">
                        <i class="fas fa-sync-alt"></i> Terapkan Filter
                    </button>
                    <button class="btn btn-outline btn-icon" id="resetFilterBtn">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
            
            <!-- STATUS SINKRONISASI -->
            <div class="sync-status">
                <i class="fas fa-database" style="color: var(--primary);"></i>
                <span>Sumber Data: <strong>Dashboard Admin</strong></span>
                <span class="badge badge-success" id="syncStatus">âœ“ Sinkron</span>
                <span style="margin-left: auto; font-size: 0.75rem;" id="lastSyncTime"></span>
            </div>
        </section>
        
        <!-- STATS SECTION -->
        <section class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total SHU</div>
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalSHUDisplay">Rp 0</div>
                    <div class="stat-detail" id="totalSHUDetail">Tahun 2026</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">SHU Anggota (60%)</div>
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="shuAnggotaDisplay">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-users"></i>
                        <span id="jumlahAnggotaSHU">0</span> anggota
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Dana Cadangan (20%)</div>
                        <div class="stat-icon">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="danaCadanganDisplay">Rp 0</div>
                    <div class="stat-detail" id="cadanganDetail">Dana pengembangan</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Pertumbuhan</div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="growthDisplay">0%</div>
                    <div class="stat-detail">Dari tahun sebelumnya</div>
                </div>
            </div>
        </section>
        
        <!-- TABLE SECTION - DISTRIBUSI SHU -->
        <section class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-chart-pie"></i>
                    Distribusi SHU
                </h2>
                <div class="table-actions">
                    <button class="btn btn-outline btn-sm" id="exportBtn" title="Export Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                    <button class="btn btn-outline btn-sm" id="printBtn" title="Print">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="mobile-table">
                    <thead>
                        <tr>
                            <th>Jenis Alokasi</th>
                            <th>Persentase</th>
                            <th>Jumlah</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="shuTableBody"></tbody>
                </table>
            </div>
            
            <div class="card-view" id="shuCardView"></div>
        </section>
        
        <!-- DAFTAR PENERIMA SHU SECTION -->
        <section class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-users"></i>
                    Penerima SHU per Anggota
                </h2>
                <div class="table-actions">
                    <button class="btn btn-outline btn-sm" id="exportPenerimaBtn">
                        <i class="fas fa-file-excel"></i>
                    </button>
                </div>
            </div>
            
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: var(--space-lg);">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Anggota Aktif</div>
                        <div class="stat-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalAnggotaPenerima">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Simpanan</div>
                        <div class="stat-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalSimpananSemua">Rp 0</div>
                </div>
            </div>
            
            <div class="card-view" id="penerimaCardView"></div>
        </section>
        
        <!-- ACTION BUTTONS -->
        <section class="table-section">
            <div class="action-buttons">
                <button class="action-btn" id="refreshDataBtn">
                    <i class="fas fa-sync-alt"></i> Sinkron Dashboard
                </button>
                <button class="action-btn" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
                <button class="action-btn" id="viewChartBtn">
                    <i class="fas fa-chart-bar"></i> Lihat Chart
                </button>
                <button class="action-btn" id="checkSyncBtn">
                    <i class="fas fa-check-circle"></i> Cek Sinkron
                </button>
            </div>
        </section>
        
        <!-- FOOTER -->
        <footer class="footer">
            <p>Â© 2026 Koperasi Asmara Tani</p>
            <p id="footerInfo">Data sinkron dengan Dashboard Admin</p>
        </footer>
    </div>
    
    <script>
        // ===== DATA UTAMA =====
        let dashboardData = null;
        let anggotaData = [];
        let shuData = [];
        let penerimaData = [];
        
        let currentFilter = {
            tahun: '2026',
            periode: 'tahunan'
        };
        
        let chartInstance = null;

        // ===== KONSTANTA =====
        const SHU_DISTRIBUSI = [
            { jenis: 'Dana Cadangan', persentase: 20, status: 'Disetorkan', color: '#2e7d32' },
            { jenis: 'Dana Anggota', persentase: 60, status: 'Dibagikan', color: '#2196f3' },
            { jenis: 'Dana Pengurus', persentase: 10, status: 'Dibayarkan', color: '#ff9800' },
            { jenis: 'Dana Pendidikan', persentase: 5, status: 'Dialokasikan', color: '#00bcd4' },
            { jenis: 'Dana Sosial', persentase: 5, status: 'Dialokasikan', color: '#ff5722' }
        ];

        // ===== INITIALIZE =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“Š SHU Report - Mengambil data dari Dashboard...');
            
            // Load data dari dashboard
            loadDataFromDashboard();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update tampilan
            updateDisplay();
            updateLastSyncTime();
        });

        // ===== LOAD DATA LANGSUNG DARI DASHBOARD =====
        function loadDataFromDashboard() {
            try {
                // Coba ambil dari localStorage yang digunakan Dashboard Admin
                const storedDashboard = localStorage.getItem('dashboardData');
                
                if (storedDashboard) {
                    dashboardData = JSON.parse(storedDashboard);
                    console.log('âœ… Data dashboard ditemukan:', dashboardData);
                    
                    // Cek apakah ada data SHU di dashboard
                    if (dashboardData.shu) {
                        console.log('âœ… Data SHU dari dashboard:', dashboardData.shu);
                        processSHUFromDashboard();
                        
                        // Update status sinkron
                        document.getElementById('syncStatus').innerHTML = 'âœ“ Sinkron';
                        document.getElementById('syncStatus').className = 'badge badge-success';
                        return;
                    }
                }
                
                // Jika tidak ada data SHU di dashboard, coba ambil dari sumber lain
                const anggota = localStorage.getItem('koperasi_anggota');
                if (anggota) {
                    anggotaData = JSON.parse(anggota);
                    calculateSHUFromAnggota();
                    
                    document.getElementById('syncStatus').innerHTML = 'âš ï¸ Data Anggota';
                    document.getElementById('syncStatus').className = 'badge badge-warning';
                    return;
                }
                
                // Fallback ke data dummy
                generateDummyData();
                document.getElementById('syncStatus').innerHTML = 'âš ï¸ Data Demo';
                document.getElementById('syncStatus').className = 'badge badge-warning';
                
            } catch (error) {
                console.error('âŒ Error loading data:', error);
                generateDummyData();
                document.getElementById('syncStatus').innerHTML = 'âŒ Error';
                document.getElementById('syncStatus').className = 'badge badge-danger';
            }
        }

        // ===== PROSES SHU LANGSUNG DARI DASHBOARD =====
        function processSHUFromDashboard() {
            if (!dashboardData || !dashboardData.shu) return;
            
            const shu = dashboardData.shu;
            const tahun = currentFilter.tahun;
            
            // Ambil nilai dari dashboard
            const totalSHU = shu.total || 0;
            const shuAnggota = shu.dibagikan || 0;
            const danaCadangan = shu.cadangan || 0;
            const jumlahAnggota = shu.anggota || 0;
            const pertumbuhan = shu.pertumbuhan || 0;
            
            // Buat data distribusi dari dashboard
            if (shu.distribusi && shu.distribusi.length > 0) {
                // Gunakan distribusi dari dashboard
                shuData = shu.distribusi.map((item, index) => ({
                    id: `SHU-${String(index + 1).padStart(3, '0')}`,
                    jenis: item.jenis,
                    persentase: item.persentase,
                    jumlah: item.jumlah,
                    deskripsi: getDeskripsiSHU(item.jenis),
                    status: item.status || getStatusSHU(item.jenis),
                    sumber: 'SHU Tahun Berjalan',
                    tanggal: `${tahun}-12-31`,
                    bukti: `SHU-${item.jenis.substring(0,3)}-${tahun}`,
                    color: getColorSHU(item.jenis)
                }));
            } else {
                // Buat distribusi manual dari nilai total
                shuData = SHU_DISTRIBUSI.map((item, index) => {
                    let jumlah = 0;
                    if (item.jenis === 'Dana Cadangan') jumlah = danaCadangan;
                    else if (item.jenis === 'Dana Anggota') jumlah = shuAnggota;
                    else if (item.jenis === 'Dana Pengurus') jumlah = Math.round(totalSHU * 0.1);
                    else if (item.jenis === 'Dana Pendidikan') jumlah = Math.round(totalSHU * 0.05);
                    else if (item.jenis === 'Dana Sosial') jumlah = Math.round(totalSHU * 0.05);
                    
                    return {
                        id: `SHU-${String(index + 1).padStart(3, '0')}`,
                        jenis: item.jenis,
                        persentase: item.persentase,
                        jumlah: jumlah,
                        deskripsi: getDeskripsiSHU(item.jenis),
                        status: item.status,
                        sumber: 'SHU Tahun Berjalan',
                        tanggal: `${tahun}-12-31`,
                        bukti: `SHU-${item.jenis.substring(0,3)}-${tahun}`,
                        color: item.color
                    };
                });
            }
            
            // Ambil data anggota dari dashboard
            if (dashboardData.anggota && dashboardData.anggota.length > 0) {
                anggotaData = dashboardData.anggota;
            }
            
            // Hitung SHU per anggota (proporsional)
            calculatePerAnggotaSHU(totalSHU, shuAnggota, jumlahAnggota);
            
            // Update statistik
            updateStats(totalSHU, shuAnggota, danaCadangan, jumlahAnggota, pertumbuhan);
        }

        // ===== HITUNG SHU DARI DATA ANGGOTA (FALLBACK) =====
        function calculateSHUFromAnggota() {
            const tahun = currentFilter.tahun;
            
            // Hitung total simpanan
            const totalSimpananSemua = anggotaData.reduce((sum, a) => 
                sum + (a.totalSimpanan || a.simpananPokok + a.simpananWajib + a.simpananSukarela || 200000), 0);
            
            // Asumsi SHU = 10% dari total simpanan
            const totalSHU = Math.round(totalSimpananSemua * 0.1);
            const shuAnggota = Math.round(totalSHU * 0.6);
            const danaCadangan = Math.round(totalSHU * 0.2);
            const jumlahAnggota = anggotaData.length;
            
            shuData = SHU_DISTRIBUSI.map((item, index) => {
                let jumlah = 0;
                if (item.jenis === 'Dana Cadangan') jumlah = danaCadangan;
                else if (item.jenis === 'Dana Anggota') jumlah = shuAnggota;
                else if (item.jenis === 'Dana Pengurus') jumlah = Math.round(totalSHU * 0.1);
                else if (item.jenis === 'Dana Pendidikan') jumlah = Math.round(totalSHU * 0.05);
                else if (item.jenis === 'Dana Sosial') jumlah = Math.round(totalSHU * 0.05);
                
                return {
                    id: `SHU-${String(index + 1).padStart(3, '0')}`,
                    jenis: item.jenis,
                    persentase: item.persentase,
                    jumlah: jumlah,
                    deskripsi: getDeskripsiSHU(item.jenis),
                    status: item.status,
                    sumber: 'SHU Tahun Berjalan',
                    tanggal: `${tahun}-12-31`,
                    bukti: `SHU-${item.jenis.substring(0,3)}-${tahun}`,
                    color: item.color
                };
            });
            
            calculatePerAnggotaSHU(totalSHU, shuAnggota, jumlahAnggota);
            updateStats(totalSHU, shuAnggota, danaCadangan, jumlahAnggota, 12.5);
        }

        // ===== HITUNG SHU PER ANGGOTA =====
        function calculatePerAnggotaSHU(totalSHU, shuAnggota, jumlahAnggota) {
            if (anggotaData.length === 0) {
                generateDummyPenerima(jumlahAnggota || 48, shuAnggota);
                return;
            }
            
            const totalSimpananSemua = anggotaData.reduce((sum, a) => 
                sum + (a.totalSimpanan || a.simpananPokok + a.simpananWajib + a.simpananSukarela || 200000), 0);
            
            penerimaData = anggotaData.map((anggota, index) => {
                const totalSimpanan = anggota.totalSimpanan || 
                    (anggota.simpananPokok + anggota.simpananWajib + anggota.simpananSukarela) || 200000;
                
                const proporsi = totalSimpanan / totalSimpananSemua;
                const shuTerima = Math.round(shuAnggota * proporsi);
                
                return {
                    id: anggota.id || anggota.nia || `AGT-${String(index + 1).padStart(3, '0')}`,
                    nia: anggota.nia || `#01-2026-${String(index + 1).padStart(3, '0')}`,
                    nama: anggota.nama || `Anggota ${index + 1}`,
                    noAnggota: anggota.nia || anggota.id || `AGT-${String(index + 1).padStart(3, '0')}`,
                    simpananPokok: anggota.simpananPokok || 200000,
                    simpananWajib: anggota.simpananWajib || 0,
                    simpananSukarela: anggota.simpananSukarela || 0,
                    totalSimpanan: totalSimpanan,
                    shuDiterima: shuTerima,
                    persentase: parseFloat((proporsi * 100).toFixed(2)),
                    tanggalTerima: `${currentFilter.tahun}-12-20`,
                    status: 'Diterima',
                    bukti: `SHU-${anggota.id || index + 1}-${currentFilter.tahun}`
                };
            });
        }

        function generateDummyPenerima(jumlah, shuAnggota) {
            const names = ['Budi Santoso', 'Siti Rahayu', 'Agus Wijaya', 'Dewi Lestari', 'Hendra Gunawan'];
            penerimaData = [];
            
            for (let i = 0; i < Math.min(jumlah, 10); i++) {
                const totalSimpanan = 200000 + (i * 50000);
                penerimaData.push({
                    id: `AGT-${String(i + 1).padStart(3, '0')}`,
                    nia: `#01-2026-${String(i + 1).padStart(3, '0')}`,
                    nama: names[i % names.length] + (i > 4 ? ` ${i + 1}` : ''),
                    noAnggota: `AGT-${String(i + 1).padStart(3, '0')}`,
                    simpananPokok: 200000,
                    simpananWajib: (i + 1) * 20000,
                    simpananSukarela: i * 100000,
                    totalSimpanan: totalSimpanan,
                    shuDiterima: Math.round(shuAnggota / jumlah * (i + 1)),
                    persentase: parseFloat(((i + 1) / jumlah * 100).toFixed(2)),
                    tanggalTerima: `${currentFilter.tahun}-12-20`,
                    status: 'Diterima',
                    bukti: `SHU-${i + 1}-${currentFilter.tahun}`
                });
            }
        }

        function generateDummyData() {
            anggotaData = [
                { id: 'AGT-001', nama: 'Budi Santoso', simpananPokok: 200000, simpananWajib: 240000, simpananSukarela: 500000 },
                { id: 'AGT-002', nama: 'Siti Rahayu', simpananPokok: 200000, simpananWajib: 360000, simpananSukarela: 750000 },
                { id: 'AGT-003', nama: 'Agus Wijaya', simpananPokok: 200000, simpananWajib: 480000, simpananSukarela: 1000000 }
            ];
            
            calculateSHUFromAnggota();
        }

        function getDeskripsiSHU(jenis) {
            const desc = {
                'Dana Cadangan': 'Cadangan pengembangan koperasi',
                'Dana Anggota': 'Dibagikan ke anggota sesuai simpanan',
                'Dana Pengurus': 'Honorarium pengurus',
                'Dana Pendidikan': 'Program pendidikan',
                'Dana Sosial': 'Kegiatan sosial'
            };
            return desc[jenis] || '-';
        }

        function getStatusSHU(jenis) {
            const status = {
                'Dana Cadangan': 'Disetorkan',
                'Dana Anggota': 'Dibagikan',
                'Dana Pengurus': 'Dibayarkan',
                'Dana Pendidikan': 'Dialokasikan',
                'Dana Sosial': 'Dialokasikan'
            };
            return status[jenis] || 'Dialokasikan';
        }

        function getColorSHU(jenis) {
            const colors = {
                'Dana Cadangan': '#2e7d32',
                'Dana Anggota': '#2196f3',
                'Dana Pengurus': '#ff9800',
                'Dana Pendidikan': '#00bcd4',
                'Dana Sosial': '#ff5722'
            };
            return colors[jenis] || '#2e7d32';
        }

        // ===== UPDATE STATISTICS =====
        function updateStats(totalSHU, shuAnggota, danaCadangan, jumlahAnggota, pertumbuhan) {
            const rataRata = jumlahAnggota > 0 ? Math.round(shuAnggota / jumlahAnggota) : 0;
            
            document.getElementById('totalSHUDisplay').textContent = formatCurrency(totalSHU);
            document.getElementById('totalSHUDetail').innerHTML = `Tahun ${currentFilter.tahun}`;
            
            document.getElementById('shuAnggotaDisplay').textContent = formatCurrency(shuAnggota);
            document.getElementById('jumlahAnggotaSHU').textContent = jumlahAnggota;
            
            document.getElementById('danaCadanganDisplay').textContent = formatCurrency(danaCadangan);
            document.getElementById('growthDisplay').textContent = pertumbuhan + '%';
            
            document.getElementById('totalAnggotaPenerima').textContent = jumlahAnggota;
            
            const totalSimpanan = penerimaData.reduce((sum, a) => sum + a.totalSimpanan, 0);
            document.getElementById('totalSimpananSemua').textContent = formatCurrency(totalSimpanan);
        }

        // ===== APPLY FILTER =====
        function applyFilter() {
            currentFilter.tahun = document.getElementById('tahunSHU').value;
            currentFilter.periode = document.getElementById('periodeSHU').value;
            
            // Jika ada data dashboard, gunakan multiplier untuk simulasi tahun
            if (dashboardData && dashboardData.shu) {
                const multiplier = getYearMultiplier(currentFilter.tahun);
                const baseSHU = dashboardData.shu.total / getYearMultiplier('2026');
                
                const totalSHU = Math.round(baseSHU * multiplier);
                const shuAnggota = Math.round(totalSHU * 0.6);
                const danaCadangan = Math.round(totalSHU * 0.2);
                
                // Update distribusi
                shuData = shuData.map(item => ({
                    ...item,
                    jumlah: item.jenis === 'Dana Cadangan' ? danaCadangan :
                            item.jenis === 'Dana Anggota' ? shuAnggota :
                            item.jenis === 'Dana Pengurus' ? Math.round(totalSHU * 0.1) :
                            item.jenis === 'Dana Pendidikan' ? Math.round(totalSHU * 0.05) :
                            Math.round(totalSHU * 0.05),
                    tanggal: `${currentFilter.tahun}-12-31`,
                    bukti: `SHU-${item.jenis.substring(0,3)}-${currentFilter.tahun}`
                }));
                
                // Update penerima
                penerimaData = penerimaData.map(p => ({
                    ...p,
                    shuDiterima: Math.round(p.shuDiterima * multiplier / getYearMultiplier('2026')),
                    tanggalTerima: `${currentFilter.tahun}-12-20`,
                    bukti: `SHU-${p.id}-${currentFilter.tahun}`
                }));
                
                updateStats(totalSHU, shuAnggota, danaCadangan, penerimaData.length, 
                           dashboardData.shu.pertumbuhan || 12.5);
            }
            
            displayData(shuData);
            displayPenerimaData();
            
            showMessage(`Filter: Tahun ${currentFilter.tahun}`, 'info');
        }

        function getYearMultiplier(tahun) {
            const mult = { '2025': 0.85, '2026': 1.0, '2027': 1.15, '2028': 1.3 };
            return mult[tahun] || 1.0;
        }

        // ===== DISPLAY DATA =====
        function displayData(data) {
            const tableBody = document.getElementById('shuTableBody');
            const cardView = document.getElementById('shuCardView');
            
            tableBody.innerHTML = '';
            cardView.innerHTML = '';
            
            data.forEach((item) => {
                let badgeClass = item.status === 'Disetorkan' ? 'badge-success' :
                                item.status === 'Dibagikan' ? 'badge-warning' : 'badge-info';
                let badgeIcon = item.status === 'Disetorkan' ? 'fa-check-circle' :
                               item.status === 'Dibagikan' ? 'fa-share-alt' : 'fa-clock';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Jenis">
                        <div style="font-weight: 600; color: var(--primary-dark);">${item.jenis}</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">${item.deskripsi}</div>
                    </td>
                    <td data-label="Persentase">
                        <div style="font-weight: 700; color: var(--primary);">${item.persentase}%</div>
                    </td>
                    <td data-label="Jumlah">
                        <div style="font-weight: 700; color: var(--dark);">${formatCurrency(item.jumlah)}</div>
                    </td>
                    <td data-label="Status">
                        <span class="badge ${badgeClass}">
                            <i class="fas ${badgeIcon}"></i> ${item.status}
                        </span>
                    </td>
                    <td data-label="Aksi">
                        <button class="action-btn btn-sm" onclick="showDetail('${item.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
                
                const card = document.createElement('div');
                card.className = 'shu-card';
                card.style.borderLeftColor = item.color;
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <h3>${item.jenis}</h3>
                            <span class="card-badge">${item.persentase}%</span>
                        </div>
                        <span class="badge ${badgeClass}">${item.status}</span>
                    </div>
                    <div class="card-content">
                        <div class="card-item">
                            <div class="card-label">Jumlah</div>
                            <div class="card-value">${formatCurrency(item.jumlah)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Tanggal</div>
                            <div class="card-value">${item.tanggal}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn" onclick="showDetail('${item.id}')">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </div>
                `;
                cardView.appendChild(card);
            });
        }

        function displayPenerimaData() {
            const cardView = document.getElementById('penerimaCardView');
            cardView.innerHTML = '';
            
            if (!penerimaData || penerimaData.length === 0) {
                cardView.innerHTML = '<div class="shu-card">Belum ada data penerima</div>';
                return;
            }
            
            penerimaData.slice(0, 10).forEach((anggota) => {
                const card = document.createElement('div');
                card.className = 'shu-card';
                card.style.borderLeftColor = anggota.shuDiterima > 1000000 ? '#2e7d32' : '#2196f3';
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <h3>${anggota.nama}</h3>
                            <span class="card-badge">${anggota.noAnggota}</span>
                        </div>
                        <span class="badge badge-success">Diterima</span>
                    </div>
                    <div class="card-content">
                        <div class="card-item">
                            <div class="card-label">Total Simpanan</div>
                            <div class="card-value">${formatCurrency(anggota.totalSimpanan)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">SHU Diterima</div>
                            <div class="card-value text-success fw-bold">${formatCurrency(anggota.shuDiterima)}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn" onclick="printKwitansi('${anggota.id}')">
                            <i class="fas fa-receipt"></i> Kwitansi
                        </button>
                    </div>
                `;
                cardView.appendChild(card);
            });
        }

        function updateDisplay() {
            applyFilter();
        }

        // ===== SHOW DETAIL =====
        window.showDetail = function(itemId) {
            const item = shuData.find(d => d.id === itemId);
            if (!item) return;
            
            alert(`ðŸ“Š DETAIL ${item.jenis}\n\n` +
                  `Jumlah: ${formatCurrency(item.jumlah)}\n` +
                  `Persentase: ${item.persentase}%\n` +
                  `Status: ${item.status}\n` +
                  `Tanggal: ${item.tanggal}\n` +
                  `Deskripsi: ${item.deskripsi}`);
        };

        // ===== PRINT FUNCTIONS =====
        window.printKwitansi = function(id) {
            const anggota = penerimaData.find(a => a.id === id);
            if (!anggota) return;
            
            const printContent = `
                <html>
                <head><title>Kwitansi SHU - ${anggota.nama}</title></head>
                <body style="font-family: Arial; padding: 30px;">
                    <h2 style="color: #2e7d32;">KOPERASI ASMARA TANI</h2>
                    <h3>BUKTI PENERIMAAN SHU</h3>
                    <p>Nama: ${anggota.nama}</p>
                    <p>No. Anggota: ${anggota.noAnggota}</p>
                    <p>Jumlah: ${formatCurrency(anggota.shuDiterima)}</p>
                    <p>Tanggal: ${anggota.tanggalTerima}</p>
                    <hr>
                    <p>Terbilang: ${terbilang(anggota.shuDiterima)} rupiah</p>
                </body>
                </html>
            `;
            
            const w = window.open('', '_blank');
            w.document.write(printContent);
            w.document.close();
            w.print();
        };

        function terbilang(angka) {
            if (angka < 1000000) return 'beberapa';
            return 'dihitung';
        }

        // ===== EXPORT FUNCTIONS =====
        function exportToExcel() {
            try {
                const ws = XLSX.utils.json_to_sheet(shuData.map(item => ({
                    'Jenis Alokasi': item.jenis,
                    'Persentase (%)': item.persentase,
                    'Jumlah (Rp)': item.jumlah,
                    'Status': item.status
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Distribusi SHU');
                XLSX.writeFile(wb, `Distribusi_SHU_${currentFilter.tahun}.xlsx`);
                showMessage('Data berhasil diexport', 'success');
            } catch (error) {
                showMessage('Gagal export', 'error');
            }
        }

        function exportPenerimaToExcel() {
            try {
                const ws = XLSX.utils.json_to_sheet(penerimaData.map(a => ({
                    'No. Anggota': a.noAnggota,
                    'Nama': a.nama,
                    'Total Simpanan': a.totalSimpanan,
                    'SHU Diterima': a.shuDiterima,
                    'Persentase': a.persentase + '%'
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Penerima SHU');
                XLSX.writeFile(wb, `Penerima_SHU_${currentFilter.tahun}.xlsx`);
                showMessage('Data penerima diexport', 'success');
            } catch (error) {
                showMessage('Gagal export', 'error');
            }
        }

        // ===== CHART FUNCTIONS =====
        window.showChartModal = function() {
            const chartHTML = `
                <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:2000;">
                    <div style="background:white; padding:20px; border-radius:16px; width:90%; max-width:400px;">
                        <h3 style="margin-bottom:20px;">Distribusi SHU ${currentFilter.tahun}</h3>
                        <canvas id="chartCanvas" style="height:300px;"></canvas>
                        <button onclick="closeChart()" class="btn btn-primary" style="margin-top:20px; width:100%;">Tutup</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', chartHTML);
            
            setTimeout(() => {
                const ctx = document.getElementById('chartCanvas').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: shuData.map(i => i.jenis),
                        datasets: [{
                            data: shuData.map(i => i.jumlah),
                            backgroundColor: shuData.map(i => i.color)
                        }]
                    },
                    options: {
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.raw;
                                        const percentage = shuData[context.dataIndex].persentase;
                                        return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }, 100);
        };

        window.closeChart = function() {
            const overlay = document.querySelector('div[style*="position:fixed"]');
            if (overlay) overlay.remove();
        };

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return 'Rp ' + Math.round(amount || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function showMessage(message, type = 'info') {
            const msg = document.createElement('div');
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 3000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            msg.textContent = message;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        function updateLastSyncTime() {
            const now = new Date();
            document.getElementById('lastSyncTime').textContent = 
                now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        }

        function checkSyncWithDashboard() {
            const currentDashboard = localStorage.getItem('dashboardData');
            
            if (currentDashboard) {
                const newData = JSON.parse(currentDashboard);
                
                if (dashboardData && JSON.stringify(dashboardData.shu) === JSON.stringify(newData.shu)) {
                    showMessage('âœ“ Data sinkron dengan Dashboard', 'success');
                } else {
                    showMessage('âš ï¸ Data berbeda dengan Dashboard. Klik Sinkron untuk update', 'warning');
                    document.getElementById('syncStatus').innerHTML = 'âš ï¸ Perlu Update';
                    document.getElementById('syncStatus').className = 'badge badge-warning';
                }
            } else {
                showMessage('âŒ Dashboard tidak ditemukan', 'error');
            }
        }

        window.refreshData = function() {
            loadDataFromDashboard();
            updateDisplay();
            showMessage('Data disinkronkan dengan Dashboard', 'success');
            updateLastSyncTime();
        };

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
            document.getElementById('resetFilterBtn').addEventListener('click', () => {
                document.getElementById('tahunSHU').value = '2026';
                document.getElementById('periodeSHU').value = 'tahunan';
                applyFilter();
            });
            
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportPenerimaBtn').addEventListener('click', exportPenerimaToExcel);
            document.getElementById('refreshDataBtn').addEventListener('click', refreshData);
            document.getElementById('viewChartBtn').addEventListener('click', showChartModal);
            document.getElementById('checkSyncBtn').addEventListener('click', checkSyncWithDashboard);
            
            ['tahunSHU', 'periodeSHU'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilter);
            });
        }
    </script>
</body>
</html>
