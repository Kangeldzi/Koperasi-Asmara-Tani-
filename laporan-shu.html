<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laporan SHU - Koperasi Asmara Tani</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* ===== VARIABEL DESAIN MOBILE FIRST ===== */
        :root {
            /* Warna utama */
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --accent: #00bcd4;
            --info: #2196f3;
            --success: #4caf50;
            --warning: #ffc107;
            --danger: #f44336;
            
            /* Neutral colors */
            --dark: #121212;
            --light: #ffffff;
            --gray: #757575;
            --gray-light: #e0e0e0;
            --gray-lighter: #f5f5f5;
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            
            /* Spacing */
            --space-xs: 8px;
            --space-sm: 12px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 14px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== CONTAINER MOBILE OPTIMIZED ===== */
        .mobile-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* ===== HEADER SECTION ===== */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: var(--space-lg) var(--space-md);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-md);
        }
        
        .header-title {
            flex: 1;
        }
        
        .header-title h1 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .header-title p {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .back-button {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }
        
        /* ===== FILTER SECTION - MOBILE FRIENDLY ===== */
        .filter-section {
            background: white;
            margin: var(--space-md);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
        }
        
        .filter-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        
        .filter-title i {
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .filter-title h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .filter-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin-bottom: var(--space-sm);
        }
        
        .filter-group {
            flex: 1;
            min-width: calc(50% - 8px);
        }
        
        .filter-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 6px;
        }
        
        .filter-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            background: white;
            color: var(--dark);
            transition: all 0.2s ease;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        /* ===== STATS SECTION - MOBILE OPTIMIZED ===== */
        .stats-section {
            padding: 0 var(--space-md) var(--space-md);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--primary-light));
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }
        
        .stat-title {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: 500;
            line-height: 1.4;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .stat-detail {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
        }
        
        /* ===== TABLE SECTION - MOBILE OPTIMIZED ===== */
        .table-section {
            padding: 0 var(--space-md) var(--space-md);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding: 0 var(--space-sm);
        }
        
        .table-header h2 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .table-actions {
            display: flex;
            gap: var(--space-sm);
        }
        
        /* ===== TABEL UTAMA - DESAIN MOBILE FIRST ===== */
        .responsive-table {
            width: 100%;
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0;
        }
        
        .mobile-table {
            width: 100%;
            min-width: 320px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .mobile-table thead {
            display: none; /* Sembunyikan header di mobile */
        }
        
        .mobile-table tbody tr {
            display: block;
            border-bottom: 1px solid var(--gray-lighter);
            padding: var(--space-md);
            transition: background-color 0.2s ease;
        }
        
        .mobile-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .mobile-table tbody tr:hover {
            background-color: rgba(46, 125, 50, 0.02);
        }
        
        .mobile-table td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border: none;
            position: relative;
        }
        
        .mobile-table td::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--gray);
            font-size: 0.85rem;
            min-width: 100px;
            padding-right: var(--space-sm);
        }
        
        .mobile-table td .cell-content {
            flex: 1;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ===== CARD VIEW UNTUK TABEL - ALTERNATIF MOBILE ===== */
        .card-view {
            display: none; /* Akan diaktifkan di media query mobile */
        }
        
        .shu-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }
        
        .card-title {
            flex: 1;
        }
        
        .card-title h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }
        
        .card-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: var(--space-sm);
        }
        
        .card-content {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .card-item {
            display: flex;
            flex-direction: column;
        }
        
        .card-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 4px;
        }
        
        .card-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
            padding-top: var(--space-md);
            border-top: 1px solid var(--gray-lighter);
        }
        
        /* ===== BUTTONS - MOBILE FRIENDLY ===== */
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            min-height: 44px; /* Touch-friendly */
            min-width: 44px; /* Touch-friendly */
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            box-shadow: 0 6px 16px rgba(46, 125, 50, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), #ffb74d);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
            min-height: 36px;
            min-width: 36px;
        }
        
        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            line-height: 1;
        }
        
        .badge-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .badge-warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: #e6a700;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .badge-info {
            background-color: rgba(33, 150, 243, 0.1);
            color: var(--info);
            border: 1px solid rgba(33, 150, 243, 0.2);
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--gray);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: var(--gray-lighter);
            color: var(--primary);
            border-color: var(--primary-light);
        }
        
        /* ===== FOOTER ===== */
        .footer {
            background: white;
            padding: var(--space-lg) var(--space-md);
            text-align: center;
            color: var(--gray);
            font-size: 0.85rem;
            border-top: 1px solid var(--gray-lighter);
            margin-top: var(--space-xl);
        }
        
        /* ===== UTILITY CLASSES ===== */
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-primary {
            color: var(--primary);
        }
        
        .text-success {
            color: var(--success);
        }
        
        .fw-bold {
            font-weight: 700;
        }
        
        .d-flex {
            display: flex;
        }
        
        .align-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .mb-1 { margin-bottom: var(--space-xs); }
        .mb-2 { margin-bottom: var(--space-sm); }
        .mb-3 { margin-bottom: var(--space-md); }
        .mb-4 { margin-bottom: var(--space-lg); }
        .mb-5 { margin-bottom: var(--space-xl); }
        
        .mt-1 { margin-top: var(--space-xs); }
        .mt-2 { margin-top: var(--space-sm); }
        .mt-3 { margin-top: var(--space-md); }
        .mt-4 { margin-top: var(--space-lg); }
        .mt-5 { margin-top: var(--space-xl); }
        
        /* ===== MEDIA QUERIES ===== */
        
        /* Tablet (768px ke atas) */
        @media screen and (min-width: 768px) {
            html {
                font-size: 15px;
            }
            
            .mobile-container {
                max-width: 720px;
                padding: 0 var(--space-md);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .filter-row {
                flex-wrap: nowrap;
            }
            
            .filter-group {
                min-width: auto;
            }
            
            /* Tampilkan tabel biasa di tablet */
            .mobile-table thead {
                display: table-header-group;
            }
            
            .mobile-table thead th {
                background: rgba(46, 125, 50, 0.05);
                color: var(--primary-dark);
                font-weight: 600;
                padding: 14px 16px;
                text-align: left;
                font-size: 0.9rem;
                border-bottom: 2px solid var(--primary-light);
            }
            
            .mobile-table tbody tr {
                display: table-row;
                padding: 0;
            }
            
            .mobile-table td {
                display: table-cell;
                padding: 14px 16px;
                border-bottom: 1px solid var(--gray-lighter);
                text-align: left;
            }
            
            .mobile-table td::before {
                display: none;
            }
            
            .mobile-table td .cell-content {
                text-align: left;
            }
            
            /* Sembunyikan card view di tablet */
            .card-view {
                display: none;
            }
        }
        
        /* Desktop (992px ke atas) */
        @media screen and (min-width: 992px) {
            .mobile-container {
                max-width: 960px;
            }
            
            .header {
                padding: var(--space-xl) var(--space-lg);
            }
            
            .header-title h1 {
                font-size: 1.5rem;
            }
            
            .stats-section,
            .table-section {
                padding: 0 var(--space-lg) var(--space-lg);
            }
            
            .filter-section {
                margin: var(--space-lg);
                padding: var(--space-xl);
            }
        }
        
        /* Mobile Landscape */
        @media screen and (max-width: 767px) and (orientation: landscape) {
            .mobile-table tbody tr {
                padding: var(--space-sm);
            }
            
            .stat-card {
                padding: var(--space-md);
            }
            
            .filter-section {
                margin: var(--space-sm);
                padding: var(--space-md);
            }
        }
        
        /* Small Mobile (360px ke bawah) */
        @media screen and (max-width: 360px) {
            html {
                font-size: 13px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            
            .stat-card {
                padding: var(--space-md);
            }
            
            .mobile-table td {
                flex-direction: column;
                align-items: flex-start;
                padding: 8px 0;
            }
            
            .mobile-table td::before {
                margin-bottom: 4px;
                min-width: auto;
            }
            
            .mobile-table td .cell-content {
                text-align: left;
                width: 100%;
            }
            
            /* Aktifkan card view di mobile kecil */
            .table-container {
                display: none;
            }
            
            .card-view {
                display: block;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        
        /* Loading state */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--gray-lighter);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <!-- MOBILE CONTAINER -->
    <div class="mobile-container">
        
        <!-- HEADER -->
        <header class="header">
            <div class="header-content">
                <button class="back-button" onclick="window.history.back()" aria-label="Kembali">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="header-title">
                    <h1>Laporan SHU</h1>
                    <p>Sisa Hasil Usaha - Koperasi Asmara Tani</p>
                </div>
            </div>
        </header>
        
        <!-- FILTER SECTION -->
        <section class="filter-section">
            <div class="filter-title">
                <i class="fas fa-filter"></i>
                <h2>Filter Laporan</h2>
            </div>
            
            <div class="filter-grid">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Tahun</label>
                        <select class="filter-select" id="tahunSHU">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Periode</label>
                        <select class="filter-select" id="periodeSHU">
                            <option value="tahunan">Tahunan</option>
                            <option value="semester1">Semester 1</option>
                            <option value="semester2">Semester 2</option>
                            <option value="triwulan1">Triwulan 1</option>
                            <option value="triwulan2">Triwulan 2</option>
                            <option value="triwulan3">Triwulan 3</option>
                            <option value="triwulan4">Triwulan 4</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="statusSHU">
                            <option value="all">Semua Status</option>
                            <option value="dibagikan">Sudah Dibagikan</option>
                            <option value="dialokasikan">Dialokasikan</option>
                            <option value="disetorkan">Disetorkan</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" id="applyFilterBtn" style="flex: 1;">
                        <i class="fas fa-sync-alt"></i>
                        <span>Terapkan Filter</span>
                    </button>
                    <button class="btn btn-outline btn-icon" id="resetFilterBtn" title="Reset Filter">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- STATS SECTION -->
        <section class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total SHU Tahun Ini</div>
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalSHUDisplay">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-arrow-up text-success"></i>
                        <span id="growthPercent">0%</span> pertumbuhan
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">SHU Dibagikan</div>
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="shuAnggotaDisplay">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-users"></i>
                        <span id="jumlahAnggotaSHU">0</span> anggota
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Dana Cadangan</div>
                        <div class="stat-icon">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="danaCadanganDisplay">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-percentage"></i>
                        20% dari total SHU
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Rata-rata/Anggota</div>
                        <div class="stat-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="rataRataSHU">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-chart-line"></i>
                        Berdasarkan simpanan
                    </div>
                </div>
            </div>
        </section>
        
        <!-- TABLE SECTION -->
        <section class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-chart-pie"></i>
                    Distribusi SHU
                </h2>
                <div class="table-actions">
                    <button class="btn btn-outline btn-sm" id="exportBtn" title="Export">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline btn-sm" id="printBtn" title="Print">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>
            
            <!-- TABLE CONTAINER (untuk tablet/desktop) -->
            <div class="table-container">
                <table class="mobile-table">
                    <thead>
                        <tr>
                            <th>Jenis Alokasi</th>
                            <th>Persentase</th>
                            <th>Jumlah</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="shuTableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- CARD VIEW (untuk mobile kecil) -->
            <div class="card-view" id="shuCardView">
                <!-- Data akan diisi oleh JavaScript -->
            </div>
        </section>
        
        <!-- ================ DAFTAR PENERIMA SHU SECTION ================ -->
        <section class="table-section">
            <div class="table-header">
                <h2>
                    <i class="fas fa-users"></i>
                    Daftar Penerima SHU per Anggota
                </h2>
                <div class="table-actions">
                    <button class="btn btn-outline btn-sm" id="exportPenerimaBtn" title="Export Data Penerima">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            
            <!-- STATS PENERIMA -->
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: var(--space-lg);">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Anggota</div>
                        <div class="stat-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="totalAnggotaPenerima">0</div>
                    <div class="stat-detail">
                        <i class="fas fa-check-circle text-success"></i>
                        Aktif menerima SHU
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Rata-rata/Anggota</div>
                        <div class="stat-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>
                    <div class="stat-value" id="avgPerAnggota">Rp 0</div>
                    <div class="stat-detail">
                        <i class="fas fa-coins"></i>
                        Berdasarkan simpanan
                    </div>
                </div>
            </div>
            
            <!-- CARD VIEW UNTUK PENERIMA -->
            <div class="card-view" id="penerimaCardView">
                <!-- Data akan diisi oleh JavaScript -->
            </div>
        </section>
        
        <!-- ACTION BUTTONS -->
        <section class="table-section">
            <div class="action-buttons">
                <button class="action-btn" id="refreshDataBtn">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh Data</span>
                </button>
                <button class="action-btn" id="exportExcelBtn">
                    <i class="fas fa-file-excel"></i>
                    <span>Export Excel</span>
                </button>
                <button class="action-btn" id="exportPdfBtn">
                    <i class="fas fa-file-pdf"></i>
                    <span>Export PDF</span>
                </button>
                <button class="action-btn" id="viewChartBtn">
                    <i class="fas fa-chart-bar"></i>
                    <span>Lihat Chart</span>
                </button>
                <button class="action-btn" id="syncDataBtn">
                    <i class="fas fa-cloud-download-alt"></i>
                    <span>Sinkron Data</span>
                </button>
            </div>
        </section>
        
        <!-- FOOTER -->
        <footer class="footer">
            <p>Â© 2026 Koperasi Asmara Tani</p>
            <p>Laporan SHU - Terintegrasi dengan Google Apps Script</p>
            <p id="lastSyncInfo" style="font-size: 0.75rem; color: var(--gray-light); margin-top: 5px;">Terakhir sinkron: -</p>
        </footer>
    </div>
    
    <script>
        // ===== KONFIGURASI APPS SCRIPT =====
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2Lspxf4UB7x0KZ2GUCVQc-eEFmCCNsUXco5XcOlh2E2x0NDFqIOfx6Vji4oLu4ZuO/exec';
        
        // ===== DATA UTAMA =====
        let shuData = [];
        let penerimaData = [];
        let anggotaData = [];
        let pinjamanData = [];
        let transaksiData = [];
        
        let currentFilter = {
            tahun: '2026',
            periode: 'tahunan',
            status: 'all'
        };
        
        let chartInstance = null;
        let chartType = 'pie';

        // ===== INITIALIZE APP =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸ“± Mobile SHU Report Initializing with Apps Script...');
            
            // Update tombol back ke dashboard
            document.querySelector('.back-button').onclick = function() {
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    window.location.href = 'dashboard-admin.html';
                }
            };
            
            // Load data dari Apps Script
            await loadDataFromAppsScript();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize dengan filter saat ini
            applyFilter();
            
            console.log('âœ… Mobile SHU Report Ready');
        });

        // ===== LOAD DATA FROM APPS SCRIPT =====
        async function loadDataFromAppsScript() {
            showLoading(true);
            
            try {
                console.log('ðŸ“Š Fetching data from Apps Script...');
                
                // Ambil data dari localStorage sebagai cache
                const cachedData = localStorage.getItem('shu_apps_script_data');
                const cacheTime = localStorage.getItem('shu_apps_script_time');
                
                // Gunakan cache jika ada dan kurang dari 5 menit
                if (cachedData && cacheTime && (Date.now() - parseInt(cacheTime) < 300000)) {
                    const data = JSON.parse(cachedData);
                    processDataFromAppsScript(data);
                    console.log('âœ… Using cached data from Apps Script');
                    showMessage('Data dimuat dari cache', 'info');
                } else {
                    // Fetch fresh data dari Apps Script
                    const response = await fetch(APPS_SCRIPT_URL + '?action=getAllData&t=' + Date.now(), {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Cache data
                        localStorage.setItem('shu_apps_script_data', JSON.stringify(data));
                        localStorage.setItem('shu_apps_script_time', Date.now().toString());
                        
                        processDataFromAppsScript(data);
                        console.log('âœ… Fresh data loaded from Apps Script');
                        showMessage('Data berhasil dimuat dari server', 'success');
                    } else {
                        throw new Error('Failed to fetch data');
                    }
                }
                
                // Juga ambil data dari localStorage dashboard untuk update real-time
                loadDataFromDashboard();
                
            } catch (error) {
                console.error('âŒ Error loading from Apps Script:', error);
                showMessage('Gagal memuat data dari server, menggunakan data lokal', 'error');
                
                // Fallback ke localStorage
                loadDataFromDashboard();
            }
            
            showLoading(false);
            updateLastSyncTime();
        }

        function processDataFromAppsScript(data) {
            // Proses data SHU
            if (data.shu && data.shu.distribusi) {
                shuData = data.shu.distribusi;
            } else {
                generateDefaultSHUData();
            }
            
            // Proses data anggota
            if (data.anggota) {
                anggotaData = data.anggota;
                penerimaData = anggotaData.map((anggota, index) => ({
                    id: `P${String(index + 1).padStart(3, '0')}`,
                    nama: anggota.nama || `Anggota ${index + 1}`,
                    noAnggota: anggota.nia || anggota.id || `AGT-${String(index + 1).padStart(3, '0')}`,
                    simpananPokok: anggota.simpananPokok || 200000,
                    simpananWajib: anggota.simpananWajib || (index + 1) * 20000,
                    simpananSukarela: anggota.simpananSukarela || (index + 1) * 100000,
                    totalSimpanan: (anggota.simpananPokok || 200000) + 
                                  (anggota.simpananWajib || (index + 1) * 20000) + 
                                  (anggota.simpananSukarela || (index + 1) * 100000),
                    shuDiterima: 0, // akan dihitung nanti
                    persentase: 0,
                    tanggalTerima: new Date().toISOString().split('T')[0],
                    status: 'Diterima',
                    bukti: `SHU-${anggota.nia || anggota.id || index + 1}-${currentFilter.tahun}`
                }));
                
                // Hitung SHU berdasarkan total SHU dan proporsi simpanan
                const totalSHU = data.shu?.total || 50000000;
                const totalSimpananSemua = penerimaData.reduce((sum, a) => sum + a.totalSimpanan, 0);
                
                penerimaData = penerimaData.map(a => {
                    const persentase = (a.totalSimpanan / totalSimpananSemua) * 100;
                    const shuDiterima = Math.round((a.totalSimpanan / totalSimpananSemua) * totalSHU * 0.6); // 60% untuk anggota
                    
                    return {
                        ...a,
                        persentase: parseFloat(persentase.toFixed(2)),
                        shuDiterima: shuDiterima
                    };
                });
            }
            
            // Update stats
            updateStats();
        }

        function generateDefaultSHUData() {
            shuData = [
                {
                    id: 'SHU-001',
                    jenis: 'Dana Cadangan',
                    persentase: 20,
                    jumlah: 10000000,
                    deskripsi: 'Dana cadangan untuk pengembangan koperasi',
                    status: 'Disetorkan',
                    sumber: 'SHU Tahun Berjalan',
                    tanggal: `${currentFilter.tahun}-12-31`,
                    bukti: `SHU-CAD-${currentFilter.tahun}-001`,
                    color: '#2e7d32'
                },
                {
                    id: 'SHU-002',
                    jenis: 'Dana Anggota',
                    persentase: 60,
                    jumlah: 30000000,
                    deskripsi: 'Dibagikan kepada anggota sesuai simpanan',
                    status: 'Dibagikan',
                    sumber: 'SHU Tahun Berjalan',
                    tanggal: `${currentFilter.tahun}-12-31`,
                    bukti: `SHU-ANG-${currentFilter.tahun}-001`,
                    color: '#2196f3'
                },
                {
                    id: 'SHU-003',
                    jenis: 'Dana Pengurus',
                    persentase: 10,
                    jumlah: 5000000,
                    deskripsi: 'Honorarium pengurus koperasi',
                    status: 'Dibayarkan',
                    sumber: 'SHU Tahun Berjalan',
                    tanggal: `${currentFilter.tahun}-12-31`,
                    bukti: `SHU-PEN-${currentFilter.tahun}-001`,
                    color: '#ff9800'
                },
                {
                    id: 'SHU-004',
                    jenis: 'Dana Pendidikan',
                    persentase: 5,
                    jumlah: 2500000,
                    deskripsi: 'Program pendidikan anggota',
                    status: 'Dialokasikan',
                    sumber: 'SHU Tahun Berjalan',
                    tanggal: `${currentFilter.tahun}-12-31`,
                    bukti: `SHU-PDK-${currentFilter.tahun}-001`,
                    color: '#00bcd4'
                },
                {
                    id: 'SHU-005',
                    jenis: 'Dana Sosial',
                    persentase: 5,
                    jumlah: 2500000,
                    deskripsi: 'Kegiatan sosial kemasyarakatan',
                    status: 'Dialokasikan',
                    sumber: 'SHU Tahun Berjalan',
                    tanggal: `${currentFilter.tahun}-12-31`,
                    bukti: `SHU-SOS-${currentFilter.tahun}-001`,
                    color: '#ff5722'
                }
            ];
        }

        function loadDataFromDashboard() {
            try {
                // Ambil data dari localStorage dashboard
                const dashboardData = localStorage.getItem('dashboardData');
                if (dashboardData) {
                    const data = JSON.parse(dashboardData);
                    
                    // Update anggota data
                    if (data.anggota) {
                        anggotaData = data.anggota;
                    }
                    
                    // Update SHU data
                    if (data.shu) {
                        if (data.shu.distribusi) {
                            shuData = data.shu.distribusi;
                        }
                        
                        // Update stats dari dashboard
                        document.getElementById('totalSHUDisplay').textContent = formatCurrency(data.shu.total || 0);
                        document.getElementById('shuAnggotaDisplay').textContent = formatCurrency(data.shu.dibagikan || 0);
                        document.getElementById('danaCadanganDisplay').textContent = formatCurrency(data.shu.cadangan || 0);
                        document.getElementById('jumlahAnggotaSHU').textContent = data.shu.anggota || 0;
                        
                        if (data.shu.pertumbuhan) {
                            document.getElementById('growthPercent').textContent = `${data.shu.pertumbuhan}%`;
                        }
                        
                        // Update penerima data
                        if (data.anggota) {
                            const totalSHU = data.shu.total || 50000000;
                            const totalSimpananSemua = data.anggota.reduce((sum, a) => 
                                sum + (a.simpananPokok || 200000) + (a.simpananWajib || 0) + (a.simpananSukarela || 0), 0);
                            
                            penerimaData = data.anggota.map((a, index) => ({
                                id: a.nia || a.id || `P${String(index + 1).padStart(3, '0')}`,
                                nama: a.nama || `Anggota ${index + 1}`,
                                noAnggota: a.nia || a.id || `AGT-${String(index + 1).padStart(3, '0')}`,
                                simpananPokok: a.simpananPokok || 200000,
                                simpananWajib: a.simpananWajib || 0,
                                simpananSukarela: a.simpananSukarela || 0,
                                totalSimpanan: (a.simpananPokok || 200000) + (a.simpananWajib || 0) + (a.simpananSukarela || 0),
                                shuDiterima: Math.round(((a.simpananPokok || 200000) + (a.simpananWajib || 0) + (a.simpananSukarela || 0)) / 
                                                        totalSimpananSemua * totalSHU * 0.6),
                                persentase: parseFloat((((a.simpananPokok || 200000) + (a.simpananWajib || 0) + (a.simpananSukarela || 0)) / 
                                                       totalSimpananSemua * 100).toFixed(2)),
                                tanggalTerima: new Date().toISOString().split('T')[0],
                                status: 'Diterima',
                                bukti: `SHU-${a.nia || a.id || index + 1}-${currentFilter.tahun}`
                            }));
                        }
                    }
                }
                
                // Update stats jika belum ada
                updateStats();
                
            } catch (error) {
                console.error('Error loading from dashboard:', error);
            }
        }

        // ===== UPDATE STATISTICS =====
        function updateStats() {
            const totalSHU = shuData.reduce((sum, item) => sum + (item.jumlah || 0), 0);
            const shuAnggota = shuData.find(item => item.jenis === 'Dana Anggota')?.jumlah || Math.round(totalSHU * 0.6);
            const danaCadangan = shuData.find(item => item.jenis === 'Dana Cadangan')?.jumlah || Math.round(totalSHU * 0.2);
            const jumlahAnggota = penerimaData.length || anggotaData.length || 48;
            const rataRata = jumlahAnggota > 0 ? Math.round(shuAnggota / jumlahAnggota) : 0;
            
            // Hitung pertumbuhan (simulasi berdasarkan tahun)
            const tahun = parseInt(currentFilter.tahun);
            let growth = 0;
            if (tahun === 2026) growth = 12.5;
            else if (tahun === 2027) growth = 8.3;
            else if (tahun === 2028) growth = 15.2;
            else growth = 5.0;
            
            document.getElementById('totalSHUDisplay').textContent = formatCurrency(totalSHU);
            document.getElementById('shuAnggotaDisplay').textContent = formatCurrency(shuAnggota);
            document.getElementById('danaCadanganDisplay').textContent = formatCurrency(danaCadangan);
            document.getElementById('rataRataSHU').textContent = formatCurrency(rataRata);
            document.getElementById('jumlahAnggotaSHU').textContent = jumlahAnggota;
            document.getElementById('totalAnggotaPenerima').textContent = jumlahAnggota;
            document.getElementById('avgPerAnggota').textContent = formatCurrency(rataRata);
            document.getElementById('growthPercent').textContent = `${growth}%`;
        }

        // ===== APPLY FILTER =====
        function applyFilter() {
            const tahun = document.getElementById('tahunSHU').value;
            const periode = document.getElementById('periodeSHU').value;
            const status = document.getElementById('statusSHU').value;
            
            currentFilter = { tahun, periode, status };
            
            // Filter data SHU berdasarkan status
            let filteredData = [...shuData];
            
            if (status !== 'all') {
                filteredData = filteredData.filter(item => 
                    item.status.toLowerCase().includes(status.toLowerCase())
                );
            }
            
            // Apply multiplier based on year
            const yearMultiplier = {
                '2025': 0.85,
                '2026': 1.0,
                '2027': 1.15,
                '2028': 1.3
            };
            
            const multiplier = yearMultiplier[tahun] || 1;
            
            // Update display dengan data terfilter
            displayData(filteredData, multiplier);
            
            // Filter penerima berdasarkan tahun (simulasi)
            displayPenerimaData(multiplier);
            
            // Update stats dengan multiplier
            updateStatsWithMultiplier(multiplier);
            
            showMessage(`Filter diterapkan: Tahun ${tahun}, ${periode}`, 'info');
        }

        function updateStatsWithMultiplier(multiplier) {
            const totalSHU = shuData.reduce((sum, item) => sum + (item.jumlah || 0), 0) * multiplier;
            const shuAnggota = (shuData.find(item => item.jenis === 'Dana Anggota')?.jumlah || Math.round(totalSHU * 0.6)) * multiplier;
            const danaCadangan = (shuData.find(item => item.jenis === 'Dana Cadangan')?.jumlah || Math.round(totalSHU * 0.2)) * multiplier;
            const jumlahAnggota = penerimaData.length || anggotaData.length || 48;
            const rataRata = jumlahAnggota > 0 ? Math.round(shuAnggota / jumlahAnggota) : 0;
            
            document.getElementById('totalSHUDisplay').textContent = formatCurrency(totalSHU);
            document.getElementById('shuAnggotaDisplay').textContent = formatCurrency(shuAnggota);
            document.getElementById('danaCadanganDisplay').textContent = formatCurrency(danaCadangan);
            document.getElementById('rataRataSHU').textContent = formatCurrency(rataRata);
        }

        // ===== DISPLAY DATA =====
        function displayData(data, multiplier = 1) {
            const tableBody = document.getElementById('shuTableBody');
            const cardView = document.getElementById('shuCardView');
            
            // Clear existing content
            tableBody.innerHTML = '';
            cardView.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 16px;"></i>
                            <p style="color: var(--gray);">Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
                
                cardView.innerHTML = `
                    <div class="shu-card" style="text-align: center;">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 16px;"></i>
                        <p style="color: var(--gray);">Tidak ada data yang sesuai dengan filter</p>
                    </div>
                `;
                return;
            }
            
            // Build table rows
            data.forEach((item) => {
                const adjustedAmount = Math.round(item.jumlah * multiplier);
                
                // Get status badge
                let badgeClass = 'badge-info';
                let badgeIcon = 'fa-info-circle';
                
                if (item.status === 'Disetorkan' || item.status.toLowerCase().includes('setor')) {
                    badgeClass = 'badge-success';
                    badgeIcon = 'fa-check-circle';
                } else if (item.status === 'Dibagikan' || item.status.toLowerCase().includes('bagi')) {
                    badgeClass = 'badge-warning';
                    badgeIcon = 'fa-share-alt';
                } else if (item.status === 'Dibayarkan' || item.status.toLowerCase().includes('bayar')) {
                    badgeClass = 'badge-info';
                    badgeIcon = 'fa-money-bill-wave';
                } else if (item.status === 'Dialokasikan' || item.status.toLowerCase().includes('alokasi')) {
                    badgeClass = 'badge-info';
                    badgeIcon = 'fa-clock';
                }
                
                // Create table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td data-label="Jenis">
                        <div style="font-weight: 600; color: var(--primary-dark);">${item.jenis}</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">${item.deskripsi || '-'}</div>
                    </td>
                    <td data-label="Persentase">
                        <div style="font-weight: 700; color: var(--primary);">${item.persentase}%</div>
                        <div style="width: 60px; height: 4px; background: var(--gray-light); border-radius: 2px; margin-top: 4px;">
                            <div style="width: ${item.persentase}%; height: 100%; background: var(--primary); border-radius: 2px;"></div>
                        </div>
                    </td>
                    <td data-label="Jumlah">
                        <div style="font-weight: 700; color: var(--dark);">${formatCurrency(adjustedAmount)}</div>
                    </td>
                    <td data-label="Status">
                        <span class="badge ${badgeClass}">
                            <i class="fas ${badgeIcon}"></i>
                            ${item.status}
                        </span>
                    </td>
                    <td data-label="Aksi">
                        <button class="action-btn btn-sm" onclick="showDetail('${item.id}')" title="Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
                
                // Create card view (for mobile)
                const card = document.createElement('div');
                card.className = 'shu-card';
                card.style.borderLeftColor = item.color || '#2e7d32';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <h3>${item.jenis}</h3>
                            <span class="card-badge">${item.persentase}%</span>
                        </div>
                        <span class="badge ${badgeClass}">
                            ${item.status}
                        </span>
                    </div>
                    
                    <div class="card-content">
                        <div class="card-item">
                            <div class="card-label">Jumlah</div>
                            <div class="card-value">${formatCurrency(adjustedAmount)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Sumber</div>
                            <div class="card-value">${item.sumber || 'SHU Tahun Berjalan'}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Tanggal</div>
                            <div class="card-value">${item.tanggal || `${currentFilter.tahun}-12-31`}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">No. Bukti</div>
                            <div class="card-value">${item.bukti || 'SHU-' + currentFilter.tahun}</div>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="action-btn" onclick="showDetail('${item.id}')">
                            <i class="fas fa-eye"></i>
                            <span>Detail</span>
                        </button>
                        <button class="action-btn" onclick="printItem('${item.id}')">
                            <i class="fas fa-print"></i>
                            <span>Cetak</span>
                        </button>
                    </div>
                `;
                cardView.appendChild(card);
            });
        }

        // ===== DISPLAY PENERIMA DATA =====
        function displayPenerimaData(multiplier = 1) {
            const cardView = document.getElementById('penerimaCardView');
            cardView.innerHTML = '';
            
            if (!penerimaData || penerimaData.length === 0) {
                cardView.innerHTML = `
                    <div class="shu-card" style="text-align: center;">
                        <i class="fas fa-users" style="font-size: 3rem; color: var(--gray-light); margin-bottom: 16px;"></i>
                        <p style="color: var(--gray);">Belum ada data penerima SHU</p>
                    </div>
                `;
                return;
            }
            
            // Urutkan berdasarkan SHU diterima (terbesar ke terkecil)
            const sortedData = [...penerimaData].sort((a, b) => b.shuDiterima - a.shuDiterima);
            
            sortedData.forEach((anggota) => {
                const adjustedSHU = Math.round(anggota.shuDiterima * multiplier);
                
                const card = document.createElement('div');
                card.className = 'shu-card';
                card.style.borderLeftColor = anggota.shuDiterima > 1000000 ? '#2e7d32' : '#2196f3';
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <h3>${anggota.nama}</h3>
                            <span class="card-badge">No: ${anggota.noAnggota}</span>
                        </div>
                        <span class="badge badge-success">
                            <i class="fas fa-check-circle"></i>
                            ${anggota.status || 'Diterima'}
                        </span>
                    </div>
                    
                    <div class="card-content">
                        <div class="card-item">
                            <div class="card-label">Total Simpanan</div>
                            <div class="card-value">${formatCurrency(anggota.totalSimpanan)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">SHU Diterima</div>
                            <div class="card-value text-success fw-bold">${formatCurrency(adjustedSHU)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Persentase</div>
                            <div class="card-value">${anggota.persentase}%</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">Tanggal</div>
                            <div class="card-value">${anggota.tanggalTerima}</div>
                        </div>
                    </div>
                    
                    <div style="background: var(--gray-lighter); border-radius: var(--radius-sm); padding: var(--space-sm); margin-bottom: var(--space-md);">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                            <span>Pokok: ${formatCurrency(anggota.simpananPokok)}</span>
                            <span>Wajib: ${formatCurrency(anggota.simpananWajib)}</span>
                            <span>Sukarela: ${formatCurrency(anggota.simpananSukarela)}</span>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <button class="action-btn" onclick="showDetailPenerima('${anggota.id}')">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Detail Pembagian</span>
                        </button>
                        <button class="action-btn" onclick="printKwitansi('${anggota.id}')">
                            <i class="fas fa-receipt"></i>
                            <span>Kwitansi</span>
                        </button>
                    </div>
                `;
                
                cardView.appendChild(card);
            });
        }

        // ===== SHOW DETAIL =====
        function showDetail(itemId) {
            const item = shuData.find(d => d.id === itemId);
            if (!item) return;
            
            const adjustedAmount = Math.round(item.jumlah * (currentFilter.tahun === '2026' ? 1 : 
                                    currentFilter.tahun === '2025' ? 0.85 : 
                                    currentFilter.tahun === '2027' ? 1.15 : 1.3));
            
            const detailHTML = `
                <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); max-width: 500px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--primary-dark); font-size: 1.2rem;">Detail Distribusi SHU</h3>
                        <button class="back-button" onclick="closeDetail()" style="background: var(--gray-lighter); color: var(--gray);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-lg);">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 4px;">${item.jenis}</div>
                        <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 8px;">${formatCurrency(adjustedAmount)}</div>
                        <div style="display: flex; gap: var(--space-md);">
                            <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem;">
                                <i class="fas fa-percentage"></i> ${item.persentase}%
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem;">
                                <i class="fas fa-calendar"></i> ${item.tanggal || currentFilter.tahun}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">Status</div>
                            <div style="font-weight: 600; color: var(--primary);">${item.status}</div>
                        </div>
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">Sumber Dana</div>
                            <div style="font-weight: 600; color: var(--dark);">${item.sumber || 'SHU Tahun Berjalan'}</div>
                        </div>
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">No. Bukti</div>
                            <div style="font-weight: 600; color: var(--dark);">${item.bukti || 'SHU-' + currentFilter.tahun}</div>
                        </div>
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">Periode</div>
                            <div style="font-weight: 600; color: var(--dark);">Tahun ${currentFilter.tahun}</div>
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-lg);">
                        <div style="font-size: 0.9rem; font-weight: 600; color: var(--primary-dark); margin-bottom: 8px;">Deskripsi</div>
                        <div style="color: var(--dark); line-height: 1.6;">${item.deskripsi || 'Tidak ada deskripsi'}</div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-sm);">
                        <button class="btn btn-primary" style="flex: 1;" onclick="printItem('${item.id}')">
                            <i class="fas fa-print"></i>
                            Cetak Detail
                        </button>
                        <button class="btn btn-outline" onclick="closeDetail()">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            showModal(detailHTML);
        }

        function showDetailPenerima(id) {
            const anggota = penerimaData.find(a => a.id === id);
            if (!anggota) return;
            
            const adjustedSHU = Math.round(anggota.shuDiterima * (currentFilter.tahun === '2026' ? 1 : 
                                    currentFilter.tahun === '2025' ? 0.85 : 
                                    currentFilter.tahun === '2027' ? 1.15 : 1.3));
            
            const detailHTML = `
                <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); max-width: 500px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--primary-dark); font-size: 1.2rem;">Detail Penerima SHU</h3>
                        <button class="back-button" onclick="closeDetail()" style="background: var(--gray-lighter); color: var(--gray);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: var(--radius-md); padding: var(--space-lg); margin-bottom: var(--space-lg);">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 4px;">${anggota.nama}</div>
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 4px;">${formatCurrency(adjustedSHU)}</div>
                        <div style="display: flex; gap: var(--space-md);">
                            <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem;">
                                <i class="fas fa-id-card"></i> ${anggota.noAnggota}
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem;">
                                <i class="fas fa-percentage"></i> ${anggota.persentase}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">Total Simpanan</div>
                            <div style="font-weight: 700; color: var(--primary-dark);">${formatCurrency(anggota.totalSimpanan)}</div>
                        </div>
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">SHU Diterima</div>
                            <div style="font-weight: 700; color: var(--success);">${formatCurrency(adjustedSHU)}</div>
                        </div>
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">Tanggal Terima</div>
                            <div style="font-weight: 600; color: var(--dark);">${anggota.tanggalTerima}</div>
                        </div>
                        <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md);">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-bottom: 4px;">Status</div>
                            <span class="badge badge-success">${anggota.status}</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <h4 style="color: var(--primary-dark); margin-bottom: var(--space-sm);">Rincian Simpanan</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-sm);">
                            <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-sm); text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--gray);">Pokok</div>
                                <div style="font-weight: 600; color: var(--primary-dark);">${formatCurrency(anggota.simpananPokok)}</div>
                            </div>
                            <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-sm); text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--gray);">Wajib</div>
                                <div style="font-weight: 600; color: var(--primary-dark);">${formatCurrency(anggota.simpananWajib)}</div>
                            </div>
                            <div style="background: white; border: 1px solid var(--gray-light); border-radius: var(--radius-md); padding: var(--space-sm); text-align: center;">
                                <div style="font-size: 0.8rem; color: var(--gray);">Sukarela</div>
                                <div style="font-weight: 600; color: var(--primary-dark);">${formatCurrency(anggota.simpananSukarela)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--gray-lighter); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-lg);">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>No. Bukti:</span>
                            <span style="font-weight: 600; color: var(--primary-dark);">${anggota.bukti}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-top: 8px;">
                            <span>Periode SHU:</span>
                            <span style="font-weight: 600; color: var(--primary-dark);">Tahun ${currentFilter.tahun}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-sm);">
                        <button class="btn btn-primary" style="flex: 1;" onclick="printKwitansi('${anggota.id}')">
                            <i class="fas fa-receipt"></i>
                            Cetak Kwitansi
                        </button>
                        <button class="btn btn-outline" onclick="closeDetail()">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            showModal(detailHTML);
        }

        function showModal(content) {
            const overlay = document.createElement('div');
            overlay.id = 'detailOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: var(--space-md);
                animation: fadeIn 0.3s ease;
            `;
            
            overlay.innerHTML = content;
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
        }

        function closeDetail() {
            const overlay = document.getElementById('detailOverlay');
            if (overlay) {
                overlay.remove();
            }
            document.body.style.overflow = '';
        }

        // ===== PRINT FUNCTIONS =====
        function printItem(itemId) {
            const item = shuData.find(d => d.id === itemId);
            if (!item) return;
            
            const adjustedAmount = Math.round(item.jumlah * (currentFilter.tahun === '2026' ? 1 : 
                                    currentFilter.tahun === '2025' ? 0.85 : 
                                    currentFilter.tahun === '2027' ? 1.15 : 1.3));
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Detail SHU - ${item.jenis}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 30px; max-width: 800px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2e7d32; padding-bottom: 20px; }
                        h1 { color: #2e7d32; font-size: 24px; margin-bottom: 5px; }
                        h2 { color: #333; font-size: 20px; margin-top: 0; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
                        .info-item { background: #f5f5f5; padding: 15px; border-radius: 8px; }
                        .amount-box { background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        td { padding: 8px; border-bottom: 1px solid #ddd; }
                        .label { font-weight: bold; color: #666; width: 200px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>KOPERASI ASMARA TANI</h1>
                        <h2>Detail Distribusi SHU</h2>
                        <p>Tahun ${currentFilter.tahun}</p>
                    </div>
                    
                    <div class="amount-box">
                        <div style="font-size: 16px; margin-bottom: 10px;">${item.jenis}</div>
                        <div style="font-size: 32px; font-weight: bold;">${formatCurrency(adjustedAmount)}</div>
                        <div style="margin-top: 10px;">${item.persentase}% dari Total SHU</div>
                    </div>
                    
                    <table>
                        <tr>
                            <td class="label">Status</td>
                            <td>${item.status}</td>
                        </tr>
                        <tr>
                            <td class="label">Sumber Dana</td>
                            <td>${item.sumber || 'SHU Tahun Berjalan'}</td>
                        </tr>
                        <tr>
                            <td class="label">No. Bukti</td>
                            <td>${item.bukti || 'SHU-' + currentFilter.tahun}</td>
                        </tr>
                        <tr>
                            <td class="label">Tanggal</td>
                            <td>${item.tanggal || `${currentFilter.tahun}-12-31`}</td>
                        </tr>
                        <tr>
                            <td class="label">Periode</td>
                            <td>Tahun ${currentFilter.tahun}</td>
                        </tr>
                    </table>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="color: #2e7d32;">Deskripsi</h3>
                        <p style="line-height: 1.6;">${item.deskripsi || 'Tidak ada deskripsi'}</p>
                    </div>
                    
                    <div class="footer">
                        <p>Dicetak dari Sistem Laporan SHU - Koperasi Asmara Tani</p>
                        <p>Tanggal cetak: ${new Date().toLocaleDateString('id-ID')} | ${new Date().toLocaleTimeString('id-ID')}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function printKwitansi(id) {
            const anggota = penerimaData.find(a => a.id === id);
            if (!anggota) return;
            
            const adjustedSHU = Math.round(anggota.shuDiterima * (currentFilter.tahun === '2026' ? 1 : 
                                    currentFilter.tahun === '2025' ? 0.85 : 
                                    currentFilter.tahun === '2027' ? 1.15 : 1.3));
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Kwitansi SHU - ${anggota.nama}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; background: #f9f9f9; }
                        .kwitansi { background: white; border: 2px solid #2e7d32; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px dashed #2e7d32; padding-bottom: 20px; }
                        .header h1 { color: #2e7d32; font-size: 28px; margin: 0; }
                        .header h2 { color: #333; font-size: 22px; margin: 5px 0 0; font-weight: normal; }
                        .no-kwitansi { text-align: right; color: #666; margin-bottom: 20px; font-size: 14px; }
                        .content { margin: 30px 0; }
                        .info-row { display: flex; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
                        .info-label { width: 200px; font-weight: bold; color: #555; }
                        .info-value { flex: 1; color: #333; }
                        .amount-box { background: linear-gradient(135deg, #2e7d32, #4caf50); color: white; padding: 25px; border-radius: 10px; text-align: center; margin: 30px 0; }
                        .amount-box .label { font-size: 16px; opacity: 0.9; margin-bottom: 10px; }
                        .amount-box .value { font-size: 36px; font-weight: bold; }
                        .terbilang { text-align: center; font-style: italic; color: #666; margin: 20px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
                        .signature { margin-top: 50px; display: flex; justify-content: space-between; }
                        .signature-box { width: 250px; text-align: center; }
                        .signature-line { border-top: 1px solid #000; width: 200px; margin: 10px auto; padding-top: 10px; }
                        .footer { margin-top: 40px; text-align: center; color: #999; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="kwitansi">
                        <div class="no-kwitansi">No. ${anggota.bukti}</div>
                        
                        <div class="header">
                            <h1>KOPERASI ASMARA TANI</h1>
                            <h2>BUKTI PENERIMAAN SHU</h2>
                            <p>Tahun Anggaran ${currentFilter.tahun}</p>
                        </div>
                        
                        <div class="content">
                            <div class="info-row">
                                <div class="info-label">Nama Anggota</div>
                                <div class="info-value">: ${anggota.nama}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">No. Anggota</div>
                                <div class="info-value">: ${anggota.noAnggota}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Tanggal</div>
                                <div class="info-value">: ${anggota.tanggalTerima}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Total Simpanan</div>
                                <div class="info-value">: ${formatCurrency(anggota.totalSimpanan)}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Persentase SHU</div>
                                <div class="info-value">: ${anggota.persentase}%</div>
                            </div>
                        </div>
                        
                        <div class="amount-box">
                            <div class="label">Jumlah SHU yang Diterima</div>
                            <div class="value">${formatCurrency(adjustedSHU)}</div>
                        </div>
                        
                        <div class="terbilang">
                            <strong>Terbilang:</strong> ${terbilang(adjustedSHU)} rupiah
                        </div>
                        
                        <div style="margin: 30px 0; padding: 15px; background: #f0f7f0; border-radius: 8px;">
                            <h4 style="color: #2e7d32; margin: 0 0 10px;">Rincian Simpanan</h4>
                            <div style="display: flex; justify-content: space-around; text-align: center;">
                                <div>
                                    <div style="color: #666; font-size: 12px;">Simpanan Pokok</div>
                                    <div style="font-weight: bold;">${formatCurrency(anggota.simpananPokok)}</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 12px;">Simpanan Wajib</div>
                                    <div style="font-weight: bold;">${formatCurrency(anggota.simpananWajib)}</div>
                                </div>
                                <div>
                                    <div style="color: #666; font-size: 12px;">Simpanan Sukarela</div>
                                    <div style="font-weight: bold;">${formatCurrency(anggota.simpananSukarela)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="signature">
                            <div class="signature-box">
                                <p>Penerima,</p>
                                <div class="signature-line"></div>
                                <p><strong>${anggota.nama}</strong></p>
                            </div>
                            <div class="signature-box">
                                <p>Bendahara Koperasi,</p>
                                <div class="signature-line"></div>
                                <p><strong>Koperasi Asmara Tani</strong></p>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>Kwitansi ini sebagai bukti sah penerimaan Sisa Hasil Usaha (SHU)</p>
                            <p>Dicetak dari Sistem Laporan SHU - ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function printReport() {
            const tahun = document.getElementById('tahunSHU').value;
            const totalSHU = shuData.reduce((sum, item) => sum + (item.jumlah || 0), 0) * 
                           (tahun === '2026' ? 1 : tahun === '2025' ? 0.85 : tahun === '2027' ? 1.15 : 1.3);
            
            let tableRows = '';
            shuData.forEach((item, index) => {
                const adjustedAmount = Math.round(item.jumlah * (tahun === '2026' ? 1 : 
                                    tahun === '2025' ? 0.85 : tahun === '2027' ? 1.15 : 1.3));
                tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.jenis}</td>
                        <td>${item.persentase}%</td>
                        <td>${formatCurrency(adjustedAmount)}</td>
                        <td>${item.status}</td>
                    </tr>
                `;
            });
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Laporan SHU ${tahun}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 30px; max-width: 1200px; margin: 0 auto; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2e7d32; padding-bottom: 20px; }
                        h1 { color: #2e7d32; font-size: 28px; margin: 0; }
                        h2 { color: #333; font-size: 20px; margin: 5px 0 0; font-weight: normal; }
                        .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 30px 0; }
                        .summary-item { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
                        .summary-item .label { color: #666; font-size: 12px; margin-bottom: 5px; }
                        .summary-item .value { font-size: 18px; font-weight: bold; color: #2e7d32; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th { background: #2e7d32; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border-bottom: 1px solid #ddd; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>KOPERASI ASMARA TANI</h1>
                        <h2>LAPORAN SISA HASIL USAHA (SHU)</h2>
                        <p>Tahun ${tahun}</p>
                    </div>
                    
                    <div class="summary">
                        <div class="summary-item">
                            <div class="label">Total SHU</div>
                            <div class="value">${formatCurrency(totalSHU)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">SHU Anggota</div>
                            <div class="value">${formatCurrency(shuData.find(i => i.jenis === 'Dana Anggota')?.jumlah * (tahun === '2026' ? 1 : tahun === '2025' ? 0.85 : tahun === '2027' ? 1.15 : 1.3) || 0)}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Jumlah Anggota</div>
                            <div class="value">${penerimaData.length || 48}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Rata-rata SHU</div>
                            <div class="value">${formatCurrency(totalSHU * 0.6 / (penerimaData.length || 48))}</div>
                        </div>
                    </div>
                    
                    <h3 style="color: #2e7d32;">Distribusi SHU</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Jenis Alokasi</th>
                                <th>Persentase</th>
                                <th>Jumlah</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>Dicetak dari Sistem Laporan SHU - Koperasi Asmara Tani</p>
                        <p>Tanggal cetak: ${new Date().toLocaleDateString('id-ID')} | ${new Date().toLocaleTimeString('id-ID')}</p>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // ===== CHART FUNCTIONS =====
        function showChartModal() {
            const tahun = currentFilter.tahun;
            const multiplier = tahun === '2026' ? 1 : tahun === '2025' ? 0.85 : tahun === '2027' ? 1.15 : 1.3;
            const totalSHU = shuData.reduce((sum, item) => sum + (item.jumlah || 0), 0) * multiplier;
            
            const chartHTML = `
                <div style="background: white; border-radius: var(--radius-lg); padding: var(--space-lg); width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                        <h3 style="color: var(--primary-dark); font-size: 1.2rem;">
                            <i class="fas fa-chart-pie"></i> Visualisasi Distribusi SHU ${tahun}
                        </h3>
                        <button class="back-button" onclick="closeChartModal()" style="background: var(--gray-lighter); color: var(--gray);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: var(--space-lg);">
                        <div style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); flex-wrap: wrap;">
                            <button class="btn btn-sm ${chartType === 'pie' ? 'btn-primary' : 'btn-outline'}" 
                                    onclick="changeChartType('pie')">
                                <i class="fas fa-chart-pie"></i> Pie
                            </button>
                            <button class="btn btn-sm ${chartType === 'bar' ? 'btn-primary' : 'btn-outline'}" 
                                    onclick="changeChartType('bar')">
                                <i class="fas fa-chart-bar"></i> Bar
                            </button>
                            <button class="btn btn-sm ${chartType === 'doughnut' ? 'btn-primary' : 'btn-outline'}" 
                                    onclick="changeChartType('doughnut')">
                                <i class="fas fa-chart-pie"></i> Donat
                            </button>
                        </div>
                        
                        <div style="position: relative; height: 300px;">
                            <canvas id="shuChartCanvas"></canvas>
                        </div>
                        
                        <div style="text-align: center; margin-top: var(--space-md); color: var(--gray); font-size: 0.9rem;">
                            Total SHU: <strong>${formatCurrency(totalSHU)}</strong> (Tahun ${tahun})
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm); max-height: 200px; overflow-y: auto;">
                        ${shuData.map(item => `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--gray-lighter); border-radius: var(--radius-sm);">
                                <div style="width: 12px; height: 12px; border-radius: 2px; background: ${item.color || '#2e7d32'}"></div>
                                <div style="font-size: 0.85rem; flex: 1;">${item.jenis}</div>
                                <div style="font-weight: 600; font-size: 0.85rem;">${item.persentase}%</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: var(--space-lg); text-align: center;">
                        <button class="btn btn-outline btn-sm" onclick="exportChart()">
                            <i class="fas fa-download"></i> Export Chart
                        </button>
                    </div>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.id = 'chartOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: var(--space-md);
                animation: fadeIn 0.3s ease;
            `;
            
            overlay.innerHTML = chartHTML;
            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            
            // Initialize chart
            setTimeout(() => {
                renderChart(chartType);
            }, 100);
        }

        function renderChart(type) {
            chartType = type;
            
            const ctx = document.getElementById('shuChartCanvas')?.getContext('2d');
            if (!ctx) return;
            
            // Destroy existing chart
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const tahun = currentFilter.tahun;
            const multiplier = tahun === '2026' ? 1 : tahun === '2025' ? 0.85 : tahun === '2027' ? 1.15 : 1.3;
            
            const labels = shuData.map(item => item.jenis);
            const data = shuData.map(item => item.jumlah * multiplier);
            const colors = shuData.map(item => item.color || '#2e7d32');
            const percentages = shuData.map(item => item.persentase);
            
            chartInstance = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'white',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = percentages[context.dataIndex] || 0;
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function changeChartType(type) {
            renderChart(type);
            
            // Update button states
            document.querySelectorAll('#chartOverlay .btn-sm').forEach(btn => {
                btn.className = btn.className.replace('btn-primary', 'btn-outline');
            });
            
            const activeBtn = document.querySelector(`#chartOverlay button[onclick="changeChartType('${type}')"]`);
            if (activeBtn) {
                activeBtn.className = activeBtn.className.replace('btn-outline', 'btn-primary');
            }
        }

        function closeChartModal() {
            const overlay = document.getElementById('chartOverlay');
            if (overlay) {
                overlay.remove();
            }
            document.body.style.overflow = '';
            
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        function exportChart() {
            const canvas = document.getElementById('shuChartCanvas');
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `SHU_Chart_${currentFilter.tahun}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            showMessage('Chart berhasil diexport', 'success');
        }

        // ===== EXPORT FUNCTIONS =====
        function exportToExcel() {
            try {
                const tahun = currentFilter.tahun;
                const multiplier = tahun === '2026' ? 1 : tahun === '2025' ? 0.85 : tahun === '2027' ? 1.15 : 1.3;
                
                const exportData = shuData.map(item => ({
                    'Jenis Alokasi': item.jenis,
                    'Persentase (%)': item.persentase,
                    'Jumlah (Rp)': item.jumlah * multiplier,
                    'Deskripsi': item.deskripsi || '-',
                    'Status': item.status,
                    'Sumber Dana': item.sumber || 'SHU Tahun Berjalan',
                    'Tanggal': item.tanggal || `${tahun}-12-31`,
                    'No. Bukti': item.bukti || `SHU-${tahun}`
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Distribusi SHU');
                
                // Tambah sheet penerima
                const penerimaSheet = penerimaData.map(a => ({
                    'No. Anggota': a.noAnggota,
                    'Nama Anggota': a.nama,
                    'Simpanan Pokok': a.simpananPokok,
                    'Simpanan Wajib': a.simpananWajib,
                    'Simpanan Sukarela': a.simpananSukarela,
                    'Total Simpanan': a.totalSimpanan,
                    'SHU Diterima': a.shuDiterima * multiplier,
                    'Persentase (%)': a.persentase,
                    'Tanggal Terima': a.tanggalTerima,
                    'Status': a.status,
                    'No. Bukti': a.bukti
                }));
                
                const ws2 = XLSX.utils.json_to_sheet(penerimaSheet);
                XLSX.utils.book_append_sheet(wb, ws2, 'Penerima SHU');
                
                XLSX.writeFile(wb, `Laporan_SHU_${tahun}.xlsx`);
                
                showMessage('Laporan berhasil diexport ke Excel!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Gagal mengekspor data!', 'error');
            }
        }

        function exportPenerimaToExcel() {
            try {
                const tahun = currentFilter.tahun;
                const multiplier = tahun === '2026' ? 1 : tahun === '2025' ? 0.85 : tahun === '2027' ? 1.15 : 1.3;
                
                const exportData = penerimaData.map(anggota => ({
                    'No. Anggota': anggota.noAnggota,
                    'Nama Anggota': anggota.nama,
                    'Simpanan Pokok': anggota.simpananPokok,
                    'Simpanan Wajib': anggota.simpananWajib,
                    'Simpanan Sukarela': anggota.simpananSukarela,
                    'Total Simpanan': anggota.totalSimpanan,
                    'SHU Diterima': anggota.shuDiterima * multiplier,
                    'Persentase (%)': anggota.persentase,
                    'Tanggal Terima': anggota.tanggalTerima,
                    'Status': anggota.status,
                    'No. Bukti': anggota.bukti
                }));
                
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Penerima SHU');
                
                XLSX.writeFile(wb, `Penerima_SHU_${tahun}.xlsx`);
                
                showMessage('Data penerima berhasil diexport ke Excel!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Gagal mengekspor data penerima!', 'error');
            }
        }

        function exportToPDF() {
            showMessage('Fitur export PDF akan segera tersedia', 'info');
        }

        // ===== SYNC FUNCTIONS =====
        async function syncData() {
            showLoading(true);
            
            try {
                console.log('ðŸ”„ Syncing data with Apps Script...');
                
                // Hapus cache
                localStorage.removeItem('shu_apps_script_data');
                localStorage.removeItem('shu_apps_script_time');
                
                // Fetch fresh data
                const response = await fetch(APPS_SCRIPT_URL + '?action=getAllData&t=' + Date.now(), {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update cache
                    localStorage.setItem('shu_apps_script_data', JSON.stringify(data));
                    localStorage.setItem('shu_apps_script_time', Date.now().toString());
                    
                    processDataFromAppsScript(data);
                    
                    // Update display
                    applyFilter();
                    
                    updateLastSyncTime();
                    showMessage('âœ… Data berhasil disinkronkan dengan server', 'success');
                } else {
                    throw new Error('Failed to sync');
                }
                
            } catch (error) {
                console.error('âŒ Sync error:', error);
                showMessage('Gagal sinkron dengan server, menggunakan data lokal', 'error');
            }
            
            showLoading(false);
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleDateString('id-ID', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('lastSyncInfo').textContent = `Terakhir sinkron: ${timeStr}`;
        }

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            if (!amount) return 'Rp 0';
            return 'Rp ' + Math.round(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function terbilang(angka) {
            const bilangan = ['', 'satu', 'dua', 'tiga', 'empat', 'lima', 'enam', 'tujuh', 'delapan', 'sembilan', 'sepuluh', 'sebelas'];
            
            if (angka < 12) {
                return bilangan[angka];
            } else if (angka < 20) {
                return terbilang(angka - 10) + ' belas';
            } else if (angka < 100) {
                return terbilang(Math.floor(angka / 10)) + ' puluh ' + terbilang(angka % 10);
            } else if (angka < 200) {
                return 'seratus ' + terbilang(angka - 100);
            } else if (angka < 1000) {
                return terbilang(Math.floor(angka / 100)) + ' ratus ' + terbilang(angka % 100);
            } else if (angka < 2000) {
                return 'seribu ' + terbilang(angka - 1000);
            } else if (angka < 1000000) {
                return terbilang(Math.floor(angka / 1000)) + ' ribu ' + terbilang(angka % 1000);
            } else if (angka < 1000000000) {
                return terbilang(Math.floor(angka / 1000000)) + ' juta ' + terbilang(angka % 1000000);
            }
            
            return 'jumlah besar';
        }

        function showLoading(show) {
            let loader = document.getElementById('globalLoader');
            
            if (show) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'globalLoader';
                    loader.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(255, 255, 255, 0.9);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 2000;
                        flex-direction: column;
                        gap: 16px;
                    `;
                    loader.innerHTML = `
                        <div class="loading" style="width: 40px; height: 40px;"></div>
                        <p style="color: var(--primary); font-weight: 600;">Memuat data...</p>
                    `;
                    document.body.appendChild(loader);
                }
            } else {
                if (loader) {
                    loader.remove();
                }
            }
        }

        function showMessage(message, type = 'info') {
            // Remove existing message
            const existingMsg = document.getElementById('flashMessage');
            if (existingMsg) existingMsg.remove();
            
            // Create message element
            const msg = document.createElement('div');
            msg.id = 'flashMessage';
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 3000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 300px;
            `;
            
            msg.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(msg);
            
            // Remove after 3 seconds
            setTimeout(() => {
                msg.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (msg.parentNode) msg.parentNode.removeChild(msg);
                }, 300);
            }, 3000);
            
            // Add animations if not exists
            if (!document.querySelector('#messageAnimations')) {
                const style = document.createElement('style');
                style.id = 'messageAnimations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Filter button
            document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
            
            // Reset filter button
            document.getElementById('resetFilterBtn').addEventListener('click', function() {
                document.getElementById('tahunSHU').value = '2026';
                document.getElementById('periodeSHU').value = 'tahunan';
                document.getElementById('statusSHU').value = 'all';
                applyFilter();
                showMessage('Filter direset ke default', 'info');
            });
            
            // Export buttons
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('printBtn').addEventListener('click', printReport);
            
            // Export penerima
            document.getElementById('exportPenerimaBtn').addEventListener('click', function() {
                exportPenerimaToExcel();
            });
            
            // Refresh data
            document.getElementById('refreshDataBtn').addEventListener('click', function() {
                loadDataFromDashboard();
                applyFilter();
                showMessage('Data diperbarui dari dashboard', 'success');
            });
            
            // Sync data button
            document.getElementById('syncDataBtn').addEventListener('click', syncData);
            
            // View chart
            document.getElementById('viewChartBtn').addEventListener('click', showChartModal);
            
            // Auto-apply filter on select change
            document.getElementById('tahunSHU').addEventListener('change', applyFilter);
            document.getElementById('periodeSHU').addEventListener('change', applyFilter);
            document.getElementById('statusSHU').addEventListener('change', applyFilter);
            
            // Touch events for better mobile experience
            document.querySelectorAll('.action-btn, .btn').forEach(btn => {
                btn.addEventListener('touchstart', function() {
                    this.style.transform = 'translateY(1px)';
                });
                
                btn.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
            
            // Listen for storage events (data changes from other tabs)
            window.addEventListener('storage', function(e) {
                if (e.key === 'dashboardData' || e.key === 'shu_apps_script_data') {
                    console.log('ðŸ”„ Data changed in another tab, refreshing...');
                    loadDataFromDashboard();
                    applyFilter();
                }
            });
        }
    </script>
</body>
</html>
