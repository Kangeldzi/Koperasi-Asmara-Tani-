// shared-data.js
// Data Management System untuk Koperasi Asmara Tani
// File ini HARUS di-load di SEMUA HTML: dashboard, tabungan, qr-hybrid

(function() {
  'use strict';
  
  // =================== CONFIGURATION ===================
  const CONFIG = {
    STORAGE_KEY: 'koperasi_asmara_tani_data_v2',
    AUTO_SAVE: true,
    SYNC_INTERVAL: 5000 // 5 detik untuk sync check
  };
  
  // =================== DEFAULT DATA ===================
  const DEFAULT_DATA = {
    system: {
      version: '2.0',
      created: new Date().toISOString(),
      last_updated: new Date().toISOString(),
      total_anggota: 2
    },
    settings: {
      nama_koperasi: 'KOPERASI ASMARA TANI',
      logo_url: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhADAiDm28b0fescUKnqADc9uk3Q2oIptWD-hyzBQXb2AMtoPrxb7Q9Ecr9SDV_RhqA9uWO6qTcepfbfuR7KFWuKUmYYPB-6JfiExBCzT-MljhNh1P1TPsabKvh2rAQzEtZUA0lpiIkIuBxHvHVuXl0GdUWEyaABcfpsHnX_kyDLN_pS2gVNzp_kIP6Vss/s1280/1000007204.jpg',
      base_url: 'https://qr-code-hybrid.vercel.app/'
    },
    anggota: {
      "KOP-00123": {
        // Identitas
        nama: "Ahmad Sudrajat",
        nia: "KOP-00123",
        status: "AKTIF",
        alamat: "Pamijahan, Bogor",
        jk: "Laki-laki",
        agama: "Islam",
        nik: "3201234567890123",
        email: "ahmad@email.com",
        telepon: "081234567890",
        tgl_daftar: "12-01-2025",
        
        // Simpanan
        simpanan_pokok: 50000,
        simpanan_wajib: 100000,
        simpanan_sukarela: 250000,
        total_simpanan: 400000,
        
        // Pinjaman
        total_pinjaman: 1500000,
        angsuran_per_bulan: 150000,
        tenor_pinjaman: 10,
        
        // SHU & Dividen
        shu: 125000,
        dividen: 75000,
        
        // Metadata
        created_at: "2024-01-15T08:00:00Z",
        updated_at: new Date().toISOString(),
        last_update: new Date().toLocaleString('id-ID'),
        qr_url: "https://qr-code-hybrid.vercel.app/qr-code-hybrid.html?id=KOP-00123"
      },
      "KOP-00124": {
        nama: "Budi Santoso",
        nia: "KOP-00124",
        status: "AKTIF",
        simpanan_pokok: 50000,
        simpanan_wajib: 100000,
        simpanan_sukarela: 200000,
        total_simpanan: 350000,
        total_pinjaman: 1200000,
        shu: 98000,
        last_update: new Date().toLocaleString('id-ID'),
        qr_url: "https://qr-code-hybrid.vercel.app/qr-code-hybrid.html?id=KOP-00124"
      }
    },
    transaksi: {},
    laporan: {}
  };
  
  // =================== SHARED DATA CLASS ===================
  class SharedData {
    constructor() {
      this.initializeStorage();
      this.setupEventSystem();
      this.startSyncMonitor();
    }
    
    // =================== INITIALIZATION ===================
    initializeStorage() {
      if (!localStorage.getItem(CONFIG.STORAGE_KEY)) {
        console.log('üì¶ Initializing data storage...');
        this.saveData(DEFAULT_DATA);
      }
    }
    
    setupEventSystem() {
      // Create global event bus
      if (!window.koperasiEvents) {
        window.koperasiEvents = {
          listeners: {},
          on: function(event, callback) {
            if (!this.listeners[event]) this.listeners[event] = [];
            this.listeners[event].push(callback);
          },
          emit: function(event, data) {
            if (this.listeners[event]) {
              this.listeners[event].forEach(callback => callback(data));
            }
          }
        };
      }
    }
    
    startSyncMonitor() {
      // Monitor storage changes (multi-tab sync)
      window.addEventListener('storage', (event) => {
        if (event.key === CONFIG.STORAGE_KEY && event.newValue) {
          console.log('üîÑ Data updated from another tab');
          window.koperasiEvents.emit('storageUpdated', {
            timestamp: new Date().toISOString(),
            key: event.key
          });
        }
      });
      
      // Periodic sync check
      setInterval(() => {
        window.koperasiEvents.emit('syncCheck', {
          timestamp: new Date().toISOString()
        });
      }, CONFIG.SYNC_INTERVAL);
    }
    
    // =================== CORE DATA METHODS ===================
    getAllData() {
      try {
        const data = localStorage.getItem(CONFIG.STORAGE_KEY);
        return data ? JSON.parse(data) : DEFAULT_DATA;
      } catch (error) {
        console.error('‚ùå Error reading data:', error);
        return DEFAULT_DATA;
      }
    }
    
    saveData(data) {
      try {
        data.system.last_updated = new Date().toISOString();
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
        
        // Trigger update event
        window.koperasiEvents.emit('dataSaved', {
          timestamp: new Date().toISOString(),
          action: 'save'
        });
        
        return true;
      } catch (error) {
        console.error('‚ùå Error saving data:', error);
        return false;
      }
    }
    
    // =================== ANGGOTA MANAGEMENT ===================
    getAnggota(nia) {
      const data = this.getAllData();
      return data.anggota[nia] || null;
    }
    
    getAllAnggota() {
      const data = this.getAllData();
      return data.anggota;
    }
    
    getAnggotaList() {
      const anggota = this.getAllAnggota();
      return Object.keys(anggota).map(nia => ({
        nia: nia,
        nama: anggota[nia].nama || 'Tidak ada nama',
        status: anggota[nia].status || 'UNKNOWN'
      }));
    }
    
    updateAnggota(nia, newData) {
      const data = this.getAllData();
      
      if (!data.anggota[nia]) {
        // Anggota baru
        data.anggota[nia] = {
          created_at: new Date().toISOString(),
          qr_url: `${CONFIG.settings.base_url}qr-code-hybrid.html?id=${nia}`
        };
        data.system.total_anggota = Object.keys(data.anggota).length;
      }
      
      // Update data
      data.anggota[nia] = {
        ...data.anggota[nia],
        ...newData,
        nia: nia, // Ensure NIA is correct
        updated_at: new Date().toISOString(),
        last_update: new Date().toLocaleString('id-ID')
      };
      
      // Save changes
      const success = this.saveData(data);
      
      if (success) {
        // Trigger specific update event
        window.koperasiEvents.emit('anggotaUpdated', {
          nia: nia,
          data: data.anggota[nia],
          timestamp: new Date().toISOString(),
          action: newData.nia ? 'create' : 'update'
        });
        
        console.log(`‚úÖ Anggota ${nia} ${newData.nia ? 'created' : 'updated'}`);
      }
      
      return success;
    }
    
    deleteAnggota(nia) {
      const data = this.getAllData();
      
      if (data.anggota[nia]) {
        delete data.anggota[nia];
        data.system.total_anggota = Object.keys(data.anggota).length;
        
        const success = this.saveData(data);
        
        if (success) {
          window.koperasiEvents.emit('anggotaDeleted', {
            nia: nia,
            timestamp: new Date().toISOString()
          });
        }
        
        return success;
      }
      
      return false;
    }
    
    // =================== UTILITY METHODS ===================
    searchAnggota(query) {
      const allAnggota = this.getAllAnggota();
      const results = [];
      
      for (const nia in allAnggota) {
        const anggota = allAnggota[nia];
        const searchStr = `${nia} ${anggota.nama} ${anggota.alamat}`.toLowerCase();
        
        if (searchStr.includes(query.toLowerCase())) {
          results.push({ nia: nia, ...anggota });
        }
      }
      
      return results;
    }
    
    getSystemInfo() {
      const data = this.getAllData();
      return {
        ...data.system,
        total_anggota: Object.keys(data.anggota).length,
        storage_size: JSON.stringify(data).length
      };
    }
    
    getKoperasiSettings() {
      const data = this.getAllData();
      return data.settings;
    }
    
    updateSettings(newSettings) {
      const data = this.getAllData();
      data.settings = { ...data.settings, ...newSettings };
      return this.saveData(data);
    }
    
    // =================== STATISTICS ===================
    getStatistics() {
      const anggota = this.getAllAnggota();
      let totalSimpanan = 0;
      let totalPinjaman = 0;
      let totalSHU = 0;
      let aktifCount = 0;
      
      for (const nia in anggota) {
        const a = anggota[nia];
        totalSimpanan += a.total_simpanan || 0;
        totalPinjaman += a.total_pinjaman || 0;
        totalSHU += a.shu || 0;
        if (a.status === 'AKTIF') aktifCount++;
      }
      
      return {
        total_anggota: Object.keys(anggota).length,
        aktif_anggota: aktifCount,
        total_simpanan: totalSimpanan,
        total_pinjaman: totalPinjaman,
        total_shu: totalSHU,
        rata_simpanan: Object.keys(anggota).length > 0 ? 
          Math.round(totalSimpanan / Object.keys(anggota).length) : 0
      };
    }
    
    // =================== EXPORT/IMPORT ===================
    exportData() {
      return this.getAllData();
    }
    
    importData(newData) {
      try {
        // Validate data structure
        if (!newData.anggota || !newData.system) {
          throw new Error('Invalid data format');
        }
        
        this.saveData(newData);
        window.koperasiEvents.emit('dataImported', {
          timestamp: new Date().toISOString(),
          anggota_count: Object.keys(newData.anggota).length
        });
        
        return true;
      } catch (error) {
        console.error('‚ùå Import failed:', error);
        return false;
      }
    }
    
    // =================== EVENT LISTENERS ===================
    on(event, callback) {
      if (window.koperasiEvents) {
        window.koperasiEvents.on(event, callback);
      }
    }
    
    // =================== BACKUP SYSTEM ===================
    createBackup() {
      const data = this.getAllData();
      const backup = {
        ...data,
        backup_created: new Date().toISOString()
      };
      
      localStorage.setItem(`${CONFIG.STORAGE_KEY}_backup`, JSON.stringify(backup));
      return backup;
    }
    
    restoreBackup() {
      const backup = localStorage.getItem(`${CONFIG.STORAGE_KEY}_backup`);
      if (backup) {
        return this.importData(JSON.parse(backup));
      }
      return false;
    }
    
    // =================== DEBUG & DEVELOPMENT ===================
    resetToDefault() {
      if (confirm('‚ö†Ô∏è Reset semua data ke default? Tindakan ini tidak dapat dibatalkan!')) {
        localStorage.removeItem(CONFIG.STORAGE_KEY);
        this.initializeStorage();
        window.location.reload();
      }
    }
    
    debugInfo() {
      const data = this.getAllData();
      return {
        storage_key: CONFIG.STORAGE_KEY,
        data_size: JSON.stringify(data).length,
        anggota_count: Object.keys(data.anggota).length,
        last_updated: data.system.last_updated,
        storage_available: true
      };
    }
  }
  
  // =================== GLOBAL INSTANCE ===================
  // Create and export global instance
  window.KoperasiData = new SharedData();
  
  // Auto-initialize
  console.log('üöÄ Koperasi Data System initialized');
  
})();
