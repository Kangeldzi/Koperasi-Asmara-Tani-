<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Koperasi Asmara Tani</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* CSS dari file asli tetap sama */
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --accent: #ff5722;
            --light: #f5f5f5;
            --dark: #333;
            --gray: #757575;
            --gray-light: #e0e0e0;
            --danger: #f44336;
            --warning: #ffc107;
            --success: #4caf50;
            --info: #2196f3;
        }
        
        /* Semua style CSS dari file asli tetap dipertahankan */
        
        .real-time-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            z-index: 100;
        }
        
        .sync-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- ===== KOPERASI DASHBOARD REAL-TIME SYSTEM ===== -->
    <script>
    // ===== KOPERASI DASHBOARD REAL-TIME SYSTEM =====
    const DashboardRealtime = {
        // Initialize
        init() {
            console.log('ðŸ”„ Initializing Dashboard Real-time System...');
            
            // Check admin login - DIPERBAIKI: untuk Ketua dan Sekretaris
            this.checkAdminLogin();
            
            // Load all data
            this.loadAllData();
            
            // Setup real-time sync
            this.setupRealtimeSync();
            
            // Setup event listeners
            this.setupEventListeners();
            
            // Initial UI update
            this.updateDashboard();
            
            console.log('âœ… Dashboard Real-time System Ready');
            return this;
        },
        
        // Check admin login - DIPERBAIKI: untuk Ketua dan Sekretaris
        checkAdminLogin() {
            const currentUser = JSON.parse(localStorage.getItem('koperasi_current_user') || 'null');
            
            // DIPERBAIKI: menerima Ketua dan Sekretaris
            if (!currentUser || !['Ketua', 'Sekretaris'].includes(currentUser.role)) {
                window.location.href = 'login.html';
                return;
            }
            
            this.currentUser = currentUser;
            
            // Update role display
            this.updateRoleDisplay();
        },
        
        // Update role display berdasarkan user yang login
        updateRoleDisplay() {
            const adminName = document.getElementById('adminName');
            const adminRole = document.getElementById('adminRole');
            
            if (adminName && this.currentUser) {
                adminName.textContent = this.currentUser.name || this.currentUser.email;
            }
            
            if (adminRole && this.currentUser) {
                adminRole.textContent = this.currentUser.role === 'Ketua' ? 'Ketua Koperasi' : 
                                        this.currentUser.role === 'Sekretaris' ? 'Sekretaris Koperasi' : 
                                        this.currentUser.role;
            }
        },
        
        loadAllData() {
            // Load semua data dari localStorage
            this.anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota_data') || '[]');
            this.adminUpdates = JSON.parse(localStorage.getItem('koperasi_admin_updates') || '{}');
            this.userUpdates = JSON.parse(localStorage.getItem('koperasi_user_updates') || '{}');
            
            console.log(`ðŸ“Š Loaded: ${this.anggotaData.length} anggota, ${Object.keys(this.userUpdates).length} user updates`);
        },
        
        setupRealtimeSync() {
            // Setup storage listener untuk real-time updates dari user
            window.addEventListener('storage', (event) => {
                if (event.key === 'koperasi_user_updates') {
                    this.onUserUpdatesChanged();
                }
                
                if (event.key === 'koperasi_anggota_data') {
                    this.onAnggotaDataChanged();
                }
            });
            
            // Setup interval untuk sync dengan tabungan-digital
            setInterval(() => {
                this.syncWithTabunganDigital();
            }, 3000);
        },
        
        onUserUpdatesChanged() {
            // Reload user updates
            this.userUpdates = JSON.parse(localStorage.getItem('koperasi_user_updates') || '{}');
            
            // Jika ada updates dari user, process dan update data
            const userEmails = Object.keys(this.userUpdates);
            if (userEmails.length > 0) {
                console.log(`ðŸ”„ ${userEmails.length} user updates pending`);
                
                userEmails.forEach(email => {
                    this.processUserUpdate(email);
                });
            }
        },
        
        onAnggotaDataChanged() {
            // Reload anggota data
            this.anggotaData = JSON.parse(localStorage.getItem('koperasi_anggota_data') || '[]');
            
            // Update dashboard stats
            this.updateDashboardStats();
            
            // Update tables
            this.updateAnggotaTable();
            this.updateSimpananTable();
            this.updatePinjamanTable();
            
            console.log('ðŸ“Š Anggota data updated');
        },
        
        processUserUpdate(userEmail) {
            const update = this.userUpdates[userEmail];
            if (!update) return;
            
            console.log(`ðŸ”„ Processing update from: ${userEmail}`);
            
            // Cari data anggota
            const anggotaIndex = this.anggotaData.findIndex(a => a.email === userEmail);
            
            if (anggotaIndex !== -1) {
                // Apply user updates to anggota data
                if (update.personal) {
                    this.anggotaData[anggotaIndex] = {
                        ...this.anggotaData[anggotaIndex],
                        ...update.personal,
                        lastUpdated: new Date().toISOString(),
                        updatedBy: 'user'
                    };
                    
                    // Save updated data
                    localStorage.setItem('koperasi_anggota_data', JSON.stringify(this.anggotaData));
                    
                    console.log(`âœ… Updated data for: ${userEmail}`);
                    
                    // Create admin update confirmation untuk user
                    this.createAdminUpdate(userEmail, 'update_confirmed', {
                        message: 'Perubahan profil Anda telah disetujui oleh admin',
                        timestamp: new Date().toISOString()
                    });
                }
            }
            
            // Remove processed update
            delete this.userUpdates[userEmail];
            localStorage.setItem('koperasi_user_updates', JSON.stringify(this.userUpdates));
        },
        
        syncWithTabunganDigital() {
            // Update last sync timestamp
            localStorage.setItem('koperasi_last_sync', new Date().toISOString());
            
            // Update sync indicator
            this.updateSyncIndicator();
            
            // Check for any pending updates to send to users
            this.sendPendingUpdates();
        },
        
        sendPendingUpdates() {
            // Implement jika ada updates yang perlu dikirim ke user
            // Contoh: jika admin mengubah data simpanan user
        },
        
        createAdminUpdate(userEmail, updateType, updateData) {
            const adminUpdates = JSON.parse(localStorage.getItem('koperasi_admin_updates') || '{}');
            
            if (!adminUpdates[userEmail]) {
                adminUpdates[userEmail] = {};
            }
            
            adminUpdates[userEmail][updateType] = {
                ...updateData,
                timestamp: new Date().toISOString(),
                processed: false
            };
            
            localStorage.setItem('koperasi_admin_updates', JSON.stringify(adminUpdates));
            
            console.log(`ðŸ“¤ Admin update created for ${userEmail}`);
            return true;
        },
        
        setupEventListeners() {
            // Setup semua event listeners untuk dashboard
            this.setupTabNavigation();
            this.setupModalButtons();
            this.setupActionButtons();
        },
        
        setupTabNavigation() {
            // Setup tab navigation
            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = item.getAttribute('data-tab');
                    this.switchTab(tabId);
                });
            });
        },
        
        switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Update active menu
            document.querySelectorAll('.sidebar-menu a').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeMenu = document.querySelector(`.sidebar-menu a[data-tab="${tabId}"]`);
            if (activeMenu) {
                activeMenu.classList.add('active');
            }
        },
        
        updateDashboard() {
            // Update dashboard stats
            this.updateDashboardStats();
            
            // Update tables
            this.updateAnggotaTable();
            this.updateSimpananTable();
            this.updatePinjamanTable();
            
            // Update recent activity
            this.updateRecentActivity();
            
            // Update charts
            this.updateCharts();
        },
        
        updateDashboardStats() {
            const totalAnggota = this.anggotaData.length;
            const totalSimpanan = this.anggotaData.reduce((sum, anggota) => {
                return sum + (anggota.simpanan?.total || 0);
            }, 0);
            
            const totalPinjaman = this.anggotaData.reduce((sum, anggota) => {
                return sum + (anggota.pinjaman?.total || 0);
            }, 0);
            
            const totalSHU = totalSimpanan * 0.1;
            const totalKas = totalSimpanan - totalPinjaman;
            
            // Update UI elements
            const updateElement = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            updateElement('totalAnggota', totalAnggota);
            updateElement('totalSimpanan', this.formatRupiah(totalSimpanan));
            updateElement('totalPinjaman', this.formatRupiah(totalPinjaman));
            updateElement('totalSHU', this.formatRupiah(totalSHU));
            updateElement('totalKas', this.formatRupiah(totalKas));
        },
        
        updateAnggotaTable() {
            const tableBody = document.querySelector('#anggotaFullTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            this.anggotaData.forEach(anggota => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${anggota.id || 'N/A'}</td>
                    <td>${anggota.nama || 'N/A'}</td>
                    <td>${anggota.nik || 'N/A'}</td>
                    <td>${anggota.jenis_kelamin || 'N/A'}</td>
                    <td>${anggota.alamat || 'N/A'}</td>
                    <td>${anggota.whatsapp || 'N/A'}</td>
                    <td>${anggota.tanggal_daftar || 'N/A'}</td>
                    <td>
                        <span class="badge ${anggota.statusAktif === 'Aktif' ? 'badge-success' : 'badge-warning'}">
                            ${anggota.statusAktif || 'N/A'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-outline btn-sm edit-anggota" data-email="${anggota.email}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline btn-sm update-simpanan" data-email="${anggota.email}">
                            <i class="fas fa-hand-holding-usd"></i>
                        </button>
                        <button class="btn btn-outline btn-sm send-notification" data-email="${anggota.email}">
                            <i class="fas fa-bell"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            this.setupAnggotaTableButtons();
        },
        
        setupAnggotaTableButtons() {
            // Edit anggota button
            document.querySelectorAll('.edit-anggota').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const email = e.currentTarget.getAttribute('data-email');
                    this.editAnggota(email);
                });
            });
            
            // Update simpanan button
            document.querySelectorAll('.update-simpanan').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const email = e.currentTarget.getAttribute('data-email');
                    this.updateSimpananAnggota(email);
                });
            });
        },
        
        editAnggota(email) {
            const anggota = this.anggotaData.find(a => a.email === email);
            if (!anggota) return;
            
            // Show edit modal
            this.showEditAnggotaModal(anggota);
        },
        
        showEditAnggotaModal(anggota) {
            const modalContent = `
                <div style="padding: 20px;">
                    <h3>Edit Data Anggota: ${anggota.nama}</h3>
                    
                    <form id="editAnggotaForm">
                        <input type="hidden" id="editEmail" value="${anggota.email}">
                        
                        <div class="form-group">
                            <label>Nama Lengkap</label>
                            <input type="text" class="form-control" id="editNama" value="${anggota.nama}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Posisi</label>
                            <select class="form-control" id="editPosisi" required>
                                <option value="Anggota" ${anggota.posisi === 'Anggota' ? 'selected' : ''}>Anggota</option>
                                <option value="Ketua" ${anggota.posisi === 'Ketua' ? 'selected' : ''}>Ketua</option>
                                <option value="Sekretaris" ${anggota.posisi === 'Sekretaris' ? 'selected' : ''}>Sekretaris</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>No WhatsApp</label>
                            <input type="tel" class="form-control" id="editWhatsapp" value="${anggota.whatsapp}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Alamat</label>
                            <textarea class="form-control" id="editAlamat" rows="3">${anggota.alamat || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="editStatus" required>
                                <option value="Aktif" ${anggota.statusAktif === 'Aktif' ? 'selected' : ''}>Aktif</option>
                                <option value="Non-Aktif" ${anggota.statusAktif === 'Non-Aktif' ? 'selected' : ''}>Non-Aktif</option>
                                <option value="Ditangguhkan" ${anggota.statusAktif === 'Ditangguhkan' ? 'selected' : ''}>Ditangguhkan</option>
                            </select>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-outline" onclick="Dashboard.closeModal()">Batal</button>
                            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                        </div>
                    </form>
                </div>
            `;
            
            this.showModal('Edit Anggota', modalContent);
            
            // Handle form submission
            document.getElementById('editAnggotaForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveAnggotaChanges();
            });
        },
        
        saveAnggotaChanges() {
            const email = document.getElementById('editEmail').value;
            const nama = document.getElementById('editNama').value;
            const posisi = document.getElementById('editPosisi').value;
            const whatsapp = document.getElementById('editWhatsapp').value;
            const alamat = document.getElementById('editAlamat').value;
            const status = document.getElementById('editStatus').value;
            
            // Find anggota
            const anggotaIndex = this.anggotaData.findIndex(a => a.email === email);
            if (anggotaIndex === -1) return;
            
            // Update data
            this.anggotaData[anggotaIndex] = {
                ...this.anggotaData[anggotaIndex],
                nama: nama,
                posisi: posisi,
                whatsapp: whatsapp,
                alamat: alamat,
                statusAktif: status,
                lastUpdated: new Date().toISOString()
            };
            
            // Save to storage
            localStorage.setItem('koperasi_anggota_data', JSON.stringify(this.anggotaData));
            
            // Create admin update untuk dikirim ke tabungan-digital
            this.createAdminUpdate(email, 'personal_update', {
                personal: {
                    nama: nama,
                    telepon: whatsapp,
                    alamat: alamat,
                    posisi: posisi,
                    status: status,
                    updatedAt: new Date().toISOString()
                }
            });
            
            // Update UI
            this.updateAnggotaTable();
            this.updateDashboardStats();
            
            // Close modal
            this.closeModal();
            
            // Show success message
            this.showNotification('Data anggota berhasil diperbarui', 'success');
        },
        
        updateSimpananAnggota(email) {
            const anggota = this.anggotaData.find(a => a.email === email);
            if (!anggota) return;
            
            const modalContent = `
                <div style="padding: 20px;">
                    <h3>Update Simpanan: ${anggota.nama}</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <p>Simpanan saat ini: <strong>Rp ${this.formatNumber(anggota.simpanan?.total || 0)}</strong></p>
                    </div>
                    
                    <form id="updateSimpananForm">
                        <input type="hidden" id="simpananEmail" value="${email}">
                        
                        <div class="form-group">
                            <label>Jenis Simpanan</label>
                            <select class="form-control" id="jenisSimpanan" required>
                                <option value="pokok">Simpanan Pokok</option>
                                <option value="wajib">Simpanan Wajib</option>
                                <option value="sukarela">Simpanan Sukarela</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Jumlah (Rp)</label>
                            <input type="number" class="form-control" id="jumlahSimpanan" min="0" step="1000" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="statusSimpanan" required>
                                <option value="lunas">Lunas</option>
                                <option value="belum lunas">Belum Lunas</option>
                                <option value="tertunggak">Tertunggak</option>
                            </select>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-outline" onclick="Dashboard.closeModal()">Batal</button>
                            <button type="submit" class="btn btn-primary">Update Simpanan</button>
                        </div>
                    </form>
                </div>
            `;
            
            this.showModal('Update Simpanan', modalContent);
            
            // Handle form submission
            document.getElementById('updateSimpananForm').addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveSimpananUpdate();
            });
        },
        
        saveSimpananUpdate() {
            const email = document.getElementById('simpananEmail').value;
            const jenis = document.getElementById('jenisSimpanan').value;
            const jumlah = parseInt(document.getElementById('jumlahSimpanan').value);
            const status = document.getElementById('statusSimpanan').value;
            
            // Find anggota
            const anggotaIndex = this.anggotaData.findIndex(a => a.email === email);
            if (anggotaIndex === -1) return;
            
            // Initialize simpanan if not exists
            if (!this.anggotaData[anggotaIndex].simpanan) {
                this.anggotaData[anggotaIndex].simpanan = {
                    pokok: { nominal: 0, status: 'belum lunas' },
                    wajib: { nominal: 0, status: 'belum aktif' },
                    sukarela: { nominal: 0, status: 'tersedia' },
                    total: 0
                };
            }
            
            // Update simpanan data
            this.anggotaData[anggotaIndex].simpanan[jenis] = {
                nominal: jumlah,
                status: status
            };
            
            // Recalculate total
            const simpanan = this.anggotaData[anggotaIndex].simpanan;
            simpanan.total = (simpanan.pokok.nominal || 0) + 
                            (simpanan.wajib.nominal || 0) + 
                            (simpanan.sukarela.nominal || 0);
            
            // Update last updated
            this.anggotaData[anggotaIndex].lastUpdated = new Date().toISOString();
            
            // Save to storage
            localStorage.setItem('koperasi_anggota_data', JSON.stringify(this.anggotaData));
            
            // Create admin update untuk dikirim ke tabungan-digital
            this.createAdminUpdate(email, 'simpanan_update', {
                simpanan: {
                    [jenis]: {
                        nominal: jumlah,
                        status: status
                    }
                }
            });
            
            // Update UI
            this.updateDashboardStats();
            
            // Close modal
            this.closeModal();
            
            // Show success message
            this.showNotification('Simpanan berhasil diperbarui', 'success');
        },
        
        updateSimpananTable() {
            const tableBody = document.querySelector('#simpananTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            this.anggotaData.forEach(anggota => {
                const simpanan = anggota.simpanan || {};
                const total = simpanan.total || 0;
                
                if (total > 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${anggota.id}</td>
                        <td>${anggota.nama}</td>
                        <td>Total</td>
                        <td>${anggota.lastUpdated ? new Date(anggota.lastUpdated).toLocaleDateString('id-ID') : '-'}</td>
                        <td>Rp ${this.formatNumber(total)}</td>
                        <td>Rp ${this.formatNumber(total)}</td>
                        <td>
                            <button class="btn btn-outline btn-sm view-simpanan" data-email="${anggota.email}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        },
        
        updatePinjamanTable() {
            const tableBody = document.querySelector('#pinjamanFullTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            this.anggotaData.forEach(anggota => {
                const pinjaman = anggota.pinjaman || {};
                const total = pinjaman.total || 0;
                
                if (total > 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${anggota.id}-PINJAM</td>
                        <td>${anggota.nama}</td>
                        <td>Rp ${this.formatNumber(total)}</td>
                        <td>${anggota.lastUpdated ? new Date(anggota.lastUpdated).toLocaleDateString('id-ID') : '-'}</td>
                        <td>12 Bulan</td>
                        <td>1.5%</td>
                        <td>Rp ${this.formatNumber(total)}</td>
                        <td>
                            <span class="badge badge-warning">Belum Lunas</span>
                        </td>
                        <td>
                            <button class="btn btn-outline btn-sm view-pinjaman" data-email="${anggota.email}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            });
        },
        
        updateRecentActivity() {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;
            
            activityList.innerHTML = '';
            
            // Sort anggota by last updated
            const recentActivities = [...this.anggotaData]
                .sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated))
                .slice(0, 5);
            
            recentActivities.forEach(anggota => {
                const activityItem = document.createElement('li');
                activityItem.className = 'activity-item';
                
                const timeDiff = this.getTimeDiff(anggota.lastUpdated);
                
                activityItem.innerHTML = `
                    <div class="activity-icon bg-primary">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="activity-content">
                        <h4>${anggota.nama}</h4>
                        <p>${anggota.posisi} â€¢ Terakhir update</p>
                    </div>
                    <div class="activity-time">${timeDiff}</div>
                `;
                
                activityList.appendChild(activityItem);
            });
        },
        
        updateCharts() {
            // Implement chart updates jika diperlukan
        },
        
        updateSyncIndicator() {
            const indicator = document.querySelector('.real-time-badge');
            if (indicator) {
                indicator.innerHTML = `<i class="fas fa-sync-alt"></i> Real-time â€¢ ${new Date().getHours()}:${new Date().getMinutes()}`;
                indicator.classList.add('sync-pulse');
                
                setTimeout(() => {
                    indicator.classList.remove('sync-pulse');
                }, 1500);
            }
        },
        
        showModal(title, content) {
            // Create modal container if not exists
            let modalContainer = document.getElementById('dashboardModal');
            if (!modalContainer) {
                modalContainer = document.createElement('div');
                modalContainer.id = 'dashboardModal';
                modalContainer.className = 'modal';
                modalContainer.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="modalTitle">${title}</h3>
                            <button class="modal-close" id="modalClose">&times;</button>
                        </div>
                        <div class="modal-body" id="modalBody">
                            ${content}
                        </div>
                    </div>
                `;
                document.body.appendChild(modalContainer);
                
                // Add close event
                document.getElementById('modalClose').addEventListener('click', () => {
                    this.closeModal();
                });
                
                // Close on overlay click
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) {
                        this.closeModal();
                    }
                });
            } else {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = content;
            }
            
            // Show modal
            modalContainer.style.display = 'flex';
        },
        
        closeModal() {
            const modal = document.getElementById('dashboardModal');
            if (modal) {
                modal.style.display = 'none';
            }
        },
        
        showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'}; 
                     color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span style="margin-left: 10px;">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        },
        
        getTimeDiff(timestamp) {
            if (!timestamp) return 'Baru saja';
            
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000); // difference in seconds
            
            if (diff < 60) return 'Baru saja';
            if (diff < 3600) return `${Math.floor(diff / 60)} menit lalu`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} jam lalu`;
            if (diff < 604800) return `${Math.floor(diff / 86400)} hari lalu`;
            
            return time.toLocaleDateString('id-ID');
        },
        
        formatNumber(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        },
        
        formatRupiah(amount) {
            if (amount >= 1000000000) {
                return 'Rp ' + (amount / 1000000000).toFixed(1) + ' M';
            } else if (amount >= 1000000) {
                return 'Rp ' + (amount / 1000000).toFixed(1) + ' Jt';
            } else {
                return 'Rp ' + this.formatNumber(amount);
            }
        }
    };

    // Initialize dashboard
    window.Dashboard = DashboardRealtime.init();
    </script>

    <!-- ===== DASHBOARD STRUCTURE ===== -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhADAiDm28b0fescUKnqADc9uk3Q2oIptWD-hyzBQXb2AMtoPrxb7Q9Ecr9SDV_RhqA9uWO6qTcepfbfuR7KFWuKUmYYPB-6JfiExBCzT-MljhNh1P1TPsabKvh2rAQzEtZUA0lpiIkIuBxHvHVuXl0GdUWEyaABcfpsHnX_kyDLN_pS2gVNzp_kIP6Vss/s1280/1000007204.jpg" alt="Logo Koperasi Asmara Tani">
                <h1>Koperasi Asmara Tani</h1>
                <div class="tagline">#koperasijenius</div>
                <div class="real-time-badge">
                    <i class="fas fa-sync-alt"></i> Real-time
                </div>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-home"></i> <span>Dashboard Utama</span></a></li>
                    <li><a href="#" data-tab="anggota"><i class="fas fa-users"></i> <span>Data Anggota</span></a></li>
                    <li><a href="tabungan-digital.html"><i class="fas fa-book"></i> <span>Tabungan Digital</span></a></li>
                    <li><a href="#" data-tab="simpanan"><i class="fas fa-hand-holding-usd"></i> <span>Simpanan</span></a></li>
                    <li><a href="#" data-tab="pinjaman"><i class="fas fa-file-invoice-dollar"></i> <span>Pinjaman</span></a></li>
                    <li><a href="#" data-tab="laporan"><i class="fas fa-chart-line"></i> <span>Laporan</span></a></li>
                    <li><a href="#" data-tab="pengaturan"><i class="fas fa-cog"></i> <span>Pengaturan</span></a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Keluar</span></a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <div class="top-nav">
                <div class="nav-left">
                    <div class="nav-buttons">
                        <button class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <button class="home-btn" onclick="window.location.href='index.html'">
                            <i class="fas fa-home"></i>
                            <span>Beranda</span>
                        </button>
                    </div>
                    <div class="current-time" id="currentTime">
                        <i class="fas fa-clock"></i>
                        <span id="timeDisplay"></span>
                    </div>
                </div>
                <div class="nav-right">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Cari anggota..." id="searchInput">
                    </div>
                    <div class="user-info">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg" alt="Admin">
                        <div class="user-details">
                            <h4 id="adminName">Administrator</h4>
                            <p id="adminRole">Super Admin</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- Dashboard Tab -->
                <div class="tab-content active" id="dashboard">
                    <div class="page-title">
                        <h1>Dashboard Utama</h1>
                        <div>
                            <button class="btn btn-primary" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-outline" onclick="window.location.href='tabungan-digital.html'">
                                <i class="fas fa-eye"></i> Lihat Buku Tabungan Saya
                            </button>
                        </div>
                    </div>

                    <!-- Admin Profile -->
                    <div class="admin-profile">
                        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg" alt="Admin">
                        <div class="admin-details">
                            <h4 id="dashboardUserName">Admin Koperasi</h4>
                            <p id="dashboardUserEmail">admin@koperasiasmaratani.id</p>
                            <p id="dashboardUserRole">Super Administrator</p>
                            <p class="admin-role">
                                <i class="fas fa-university"></i> 4098-01-019526-53-3 (BRI)
                            </p>
                            <p id="dataStatus" style="font-size: 11px; color: #666;">
                                Data real-time aktif â€¢ <span id="anggotaCount">0</span> anggota
                            </p>
                        </div>
                        <div>
                            <button class="btn btn-primary" id="addAnggotaBtn">
                                <i class="fas fa-user-plus"></i> Tambah Anggota
                            </button>
                        </div>
                    </div>

                    <!-- Stat Cards -->
                    <div class="stats-cards">
                        <div class="card stat-card">
                            <div class="stat-info">
                                <h3>Total Anggota</h3>
                                <p id="statAnggota">0</p>
                            </div>
                            <div class="stat-icon bg-primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-info">
                                <h3>Total Simpanan</h3>
                                <p id="statSimpanan">Rp 0</p>
                            </div>
                            <div class="stat-icon bg-success">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-info">
                                <h3>Total Pinjaman</h3>
                                <p id="statPinjaman">Rp 0</p>
                            </div>
                            <div class="stat-icon bg-warning">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                        </div>
                        
                        <div class="card stat-card">
                            <div class="stat-info">
                                <h3>Update Terakhir</h3>
                                <p id="statLastUpdate">-</p>
                            </div>
                            <div class="stat-icon bg-info">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity & Tables -->
                    <div class="dashboard-row">
                        <!-- Recent Activity -->
                        <div class="table-container">
                            <div class="section-header">
                                <h2>Aktivitas Terkini</h2>
                                <button class="btn btn-outline btn-sm" id="refreshActivity">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <ul class="activity-list" id="activityList">
                                <!-- Diisi oleh JavaScript -->
                            </ul>
                        </div>

                        <!-- Quick Actions -->
                        <div class="table-container">
                            <div class="section-header">
                                <h2>Aksi Cepat</h2>
                            </div>
                            <div style="padding: 10px 0;">
                                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" id="quickUpdateBtn">
                                    <i class="fas fa-sync-alt"></i> Sync Semua Data
                                </button>
                                <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px;" id="exportDataBtn">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                                <button class="btn btn-outline" style="width: 100%;" id="sendBroadcastBtn">
                                    <i class="fas fa-bullhorn"></i> Broadcast Pesan
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Anggota -->
                    <div class="table-container" style="margin-top: 25px;">
                        <div class="section-header">
                            <h2>Anggota Terbaru</h2>
                            <button class="btn btn-outline btn-sm" onclick="Dashboard.switchTab('anggota')">
                                Lihat Semua
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>Tanggal Daftar</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentAnggotaTable">
                                <!-- Diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Data Anggota Tab -->
                <div class="tab-content" id="anggota">
                    <div class="page-title">
                        <h1>Data Anggota</h1>
                        <div>
                            <button class="btn btn-primary" id="addNewAnggotaBtn">
                                <i class="fas fa-user-plus"></i> Tambah Anggota Baru
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            <h2>Daftar Semua Anggota</h2>
                            <div class="search-bar">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Cari anggota..." id="searchAnggota">
                            </div>
                        </div>
                        <table id="anggotaFullTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nama</th>
                                    <th>NIK</th>
                                    <th>Jenis Kelamin</th>
                                    <th>Alamat</th>
                                    <th>No. HP</th>
                                    <th>Tanggal Bergabung</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Simpanan Tab -->
                <div class="tab-content" id="simpanan">
                    <div class="page-title">
                        <h1>Data Simpanan</h1>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            <h2>Rekapitulasi Simpanan</h2>
                        </div>
                        <table id="simpananTable">
                            <thead>
                                <tr>
                                    <th>ID Anggota</th>
                                    <th>Nama</th>
                                    <th>Jenis Simpanan</th>
                                    <th>Terakhir Update</th>
                                    <th>Nominal</th>
                                    <th>Total</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pinjaman Tab -->
                <div class="tab-content" id="pinjaman">
                    <div class="page-title">
                        <h1>Data Pinjaman</h1>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            <h2>Daftar Pinjaman</h2>
                        </div>
                        <table id="pinjamanFullTable">
                            <thead>
                                <tr>
                                    <th>ID Pinjaman</th>
                                    <th>Nama Anggota</th>
                                    <th>Jumlah Pinjaman</th>
                                    <th>Tanggal Pinjam</th>
                                    <th>Jangka Waktu</th>
                                    <th>Bunga</th>
                                    <th>Sisa Hutang</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Diisi oleh JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Laporan Tab -->
                <div class="tab-content" id="laporan">
                    <div class="page-title">
                        <h1>Laporan</h1>
                        <button class="btn btn-primary" id="generateReportBtn">
                            <i class="fas fa-file-pdf"></i> Generate Laporan
                        </button>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            <h2>Laporan Keuangan</h2>
                        </div>
                        <div style="padding: 20px;">
                            <p>Laporan real-time akan ditampilkan di sini.</p>
                        </div>
                    </div>
                </div>

                <!-- Pengaturan Tab -->
                <div class="tab-content" id="pengaturan">
                    <div class="page-title">
                        <h1>Pengaturan Sistem</h1>
                    </div>

                    <div class="card">
                        <div class="section-header">
                            <h2>Konfigurasi Real-time Sync</h2>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label>Sync Interval (detik)</label>
                                <input type="number" class="form-control" id="syncInterval" value="3" min="1" max="60">
                            </div>
                            <div class="form-group">
                                <label>Auto-sync</label>
                                <select class="form-control" id="autoSync">
                                    <option value="true">Aktif</option>
                                    <option value="false">Non-aktif</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="saveSettingsBtn">
                                <i class="fas fa-save"></i> Simpan Pengaturan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>&copy; 2024 Koperasi Asmara Tani â€“ Dashboard Admin Real-time</p>
            </div>
        </div>
    </div>

    <!-- Additional JavaScript untuk UI -->
    <script>
    // Update time display
    function updateTimeDisplay() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        };
        const timeString = now.toLocaleDateString('id-ID', options);
        document.getElementById('timeDisplay').textContent = timeString;
    }
    
    // Update setiap detik
    setInterval(updateTimeDisplay, 1000);
    updateTimeDisplay();
    
    // Sidebar toggle
    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.add('active');
    });
    
    document.getElementById('sidebarClose').addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('active');
    });
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('koperasi_current_user');
        window.location.href = 'login.html';
    });
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', () => {
        Dashboard.loadAllData();
        Dashboard.updateDashboard();
        Dashboard.showNotification('Data diperbarui', 'success');
    });
    
    // Add anggota button
    document.getElementById('addAnggotaBtn').addEventListener('click', () => {
        Dashboard.showAddAnggotaModal();
    });
    
    // Quick update button
    document.getElementById('quickUpdateBtn').addEventListener('click', () => {
        Dashboard.syncWithTabunganDigital();
        Dashboard.showNotification('Sync berhasil', 'success');
    });
    
    // Update dashboard user info
    function updateDashboardUserInfo() {
        const currentUser = JSON.parse(localStorage.getItem('koperasi_current_user') || 'null');
        
        if (currentUser) {
            const userName = document.getElementById('dashboardUserName');
            const userEmail = document.getElementById('dashboardUserEmail');
            const userRole = document.getElementById('dashboardUserRole');
            
            if (userName) userName.textContent = currentUser.name || currentUser.email;
            if (userEmail) userEmail.textContent = currentUser.email || 'Tidak tersedia';
            if (userRole) {
                userRole.textContent = currentUser.role === 'Ketua' ? 'Ketua Koperasi' : 
                                     currentUser.role === 'Sekretaris' ? 'Sekretaris Koperasi' : 
                                     currentUser.role || 'Pengguna';
            }
        }
    }
    
    // Update dashboard user info on load
    updateDashboardUserInfo();
    
    // Inisialisasi user default untuk testing jika belum ada
    function initializeDefaultUsers() {
        const existingUsers = JSON.parse(localStorage.getItem('koperasi_users') || '{}');
        
        // Tambah user Ketua jika belum ada
        if (!existingUsers['ketua@koperasi.com']) {
            existingUsers['ketua@koperasi.com'] = {
                password: 'ketua014212',
                name: 'Ketua Koperasi',
                role: 'Ketua',
                email: 'ketua@koperasi.com',
                foto: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjh1oM43gxD4iCHpHRBrrbkCHRU5MigalAWf4G5x-cTLfRRxWeeTwGqwNz8FtSdSgcexhRAIWMX7eZoOxo0b-i8kB2EUr44TCkMCZ8VVfQTJpL0AgptbY8hjsTZtqg6jbS2MMOuIVf9FvNOR-JsZr4dvrpqTQT0I5qY5OB063z38W0mTIVhQrBPTASmQp0/s1280/1000175639.jpg',
                norek: '4098-01-019526-53-3 (BRI)',
                access: 'dashboard',
                isSuperAdmin: true,
                createdAt: new Date().toISOString()
            };
        }
        
        // Tambah user Sekretaris jika belum ada
        if (!existingUsers['sekretaris@koperasi.com']) {
            existingUsers['sekretaris@koperasi.com'] = {
                password: 'sekretaris4212',
                name: 'Sekretaris Koperasi',
                role: 'Sekretaris',
                email: 'sekretaris@koperasi.com',
                foto: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhADAiDm28b0fescUKnqADc9uk3Q2oIptWD-hyzBQXb2AMtoPrxb7Q9Ecr9SDV_RhqA9uWO6qTcepfbfuR7KFWuKUmYYPB-6JfiExBCzT-MljhNh1P1TPsabKvh2rAQzEtZUA0lpiIkIuBxHvHVuXl0GdUWEyaABcfpsHnX_kyDLN_pS2gVNzp_kIP6Vss/s1280/1000007204.jpg',
                norek: '1234-5678-9012-3456 (BCA)',
                access: 'dashboard',
                isSuperAdmin: false,
                createdAt: new Date().toISOString()
            };
        }
        
        localStorage.setItem('koperasi_users', JSON.stringify(existingUsers));
        console.log('âœ… Default users initialized for testing');
    }
    
    // Initialize default users
    initializeDefaultUsers();
    </script>
</body>
    </html>
