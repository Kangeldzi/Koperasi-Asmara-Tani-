<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>E-KTP Digital Anggota</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{
  margin:0;
  background:linear-gradient(180deg,#061b12,#020b07);
  font-family:'Poppins',sans-serif;
  display:flex;
  justify-content:center;
  padding:16px;
  color:#fff;
}

/* KARTU */
.card{
  width:100%;
  max-width:390px;
  background:linear-gradient(160deg,#0f3d28,#062015);
  border-radius:22px;
  padding:18px;
  box-shadow:0 0 35px rgba(0,255,160,.35);
  border:1px solid rgba(0,255,160,.35);
}

/* HEADER */
.header{
  text-align:center;
  border-bottom:1px dashed rgba(255,255,255,.25);
  padding-bottom:14px;
}

/* LOGO GLASS */
.logo-wrap{
  width:86px;
  height:86px;
  margin:0 auto 10px;
  border-radius:50%;
  background:rgba(255,255,255,.12);
  backdrop-filter:blur(12px);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:
    0 0 18px rgba(0,255,160,.6),
    inset 0 0 12px rgba(255,255,255,.25);
  transition:.4s ease;
  animation:float 4s ease-in-out infinite;
}
.logo-wrap:hover{
  transform:scale(1.08);
  box-shadow:0 0 28px rgba(0,255,160,.9);
}
.logo-wrap img{
  width:58px;
  height:58px;
  border-radius:50%;
}

@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

.header h1{
  font-size:16px;
  margin:0;
  font-weight:700;
  color:#7dffb2;
}
.header small{
  font-size:11px;
  opacity:.85;
}

/* STATUS */
.status{
  margin:12px auto;
  text-align:center;
}
.status span{
  padding:6px 18px;
  border-radius:20px;
  background:#00ff9d33;
  color:#00ff9d;
  font-size:12px;
  font-weight:600;
}
.status-inactive{
  background:#ff3d0033 !important;
  color:#ffa000 !important;
}

/* IDENTITAS */
.identity{
  text-align:center;
  margin:14px 0;
}
.identity h2{
  margin:4px 0;
  font-size:17px;
}
.identity p{
  margin:0;
  font-size:12px;
  color:#a9ffd1;
}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin:16px 0;
}
.stat{
  background:rgba(0,255,160,.15);
  border-radius:14px;
  padding:10px;
  text-align:center;
}
.stat small{
  font-size:10px;
  opacity:.9;
}
.stat b{
  display:block;
  margin-top:6px;
  font-size:13px;
}

/* DATA */
.data{
  font-size:12px;
}
.data div{
  display:flex;
  justify-content:space-between;
  padding:7px 0;
  border-bottom:1px dashed rgba(255,255,255,.25);
}
.data span{
  color:#b6ffd9;
}

/* ACTION BUTTON */
.actions{
  display:flex;
  gap:12px;
  margin:18px 0 6px;
}
.actions button{
  flex:1;
  border:none;
  padding:10px;
  border-radius:14px;
  background:rgba(0,255,160,.2);
  color:#00ff9d;
  font-weight:600;
  backdrop-filter:blur(10px);
  box-shadow:0 0 14px rgba(0,255,160,.5);
  transition:.3s;
  cursor:pointer;
}
.actions button:hover{
  background:#00ff9d;
  color:#003a24;
  transform:translateY(-2px);
}

/* FOOTER */
.footer{
  margin-top:10px;
  text-align:center;
  font-size:10px;
  opacity:.75;
}

/* LOADING */
.loading{
  text-align:center;
  padding:30px;
}
.spinner{
  width:40px;
  height:40px;
  border:3px solid rgba(0,255,160,.3);
  border-top:3px solid #00ff9d;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 15px;
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

/* LAST UPDATE */
.last-update{
  font-size:9px;
  text-align:center;
  margin-top:5px;
  opacity:.6;
}

/* AUTO-REFRESH INDICATOR */
.refresh-indicator{
  position:fixed;
  bottom:10px;
  right:10px;
  background:rgba(0,255,160,.2);
  color:#00ff9d;
  padding:5px 10px;
  border-radius:15px;
  font-size:10px;
  opacity:.7;
  z-index:100;
  display:none;
}

/* UPDATE NOTIFICATION */
.update-notification{
  position:fixed;
  top:20px;
  right:20px;
  background:#00ff9d;
  color:#003a24;
  padding:12px 20px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.2);
  z-index:1000;
  animation:slideIn 0.3s ease;
  display:none;
}
@keyframes slideIn{
  from{transform:translateX(100%);opacity:0}
  to{transform:translateX(0);opacity:1}
}

/* ERROR STATE */
.error-state{
  text-align:center;
  padding:40px 20px;
  display:none;
}
.error-icon{
  font-size:48px;
  color:#ff3d00;
  margin-bottom:20px;
}
.retry-btn{
  background:rgba(0,255,160,.2);
  color:#00ff9d;
  border:none;
  padding:10px 20px;
  border-radius:10px;
  margin-top:15px;
  cursor:pointer;
  font-family:'Poppins',sans-serif;
}
.retry-btn:hover{
  background:#00ff9d;
  color:#003a24;
}
</style>
</head>

<body>

<!-- AUTO REFRESH INDICATOR -->
<div class="refresh-indicator" id="refreshIndicator">
  <i class="fas fa-sync-alt"></i> <span id="refreshTimer">30</span>s
</div>

<!-- UPDATE NOTIFICATION -->
<div class="update-notification" id="updateNotification">
  <div style="display:flex;align-items:center;gap:10px;">
    <i class="fas fa-check-circle"></i>
    <span id="notificationMessage">Data diperbarui!</span>
  </div>
</div>

<div class="card" id="cardContent">
  <!-- LOADING STATE -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Memuat data anggota...</p>
  </div>
  
  <!-- ERROR STATE -->
  <div class="error-state" id="errorState">
    <div class="error-icon">⚠️</div>
    <h3>Data Tidak Ditemukan</h3>
    <p id="errorMessage">Anggota dengan ID tersebut tidak ditemukan</p>
    <button class="retry-btn" onclick="loadMemberData()">Coba Lagi</button>
  </div>
  
  <!-- CONTENT -->
  <div id="content" style="display:none;">
    <div class="header">
      <div class="logo-wrap">
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhADAiDm28b0fescUKnqADc9uk3Q2oIptWD-hyzBQXb2AMtoPrxb7Q9Ecr9SDV_RhqA9uWO6qTcepfbfuR7KFWuKUmYYPB-6JfiExBCzT-MljhNh1P1TPsabKvh2rAQzEtZUA0lpiIkIuBxHvHVuXl0GdUWEyaABcfpsHnX_kyDLN_pS2gVNzp_kIP6Vss/s1280/1000007204.jpg">
      </div>
      <h1>KOPERASI ASMARA TANI</h1>
      <small>Kartu Anggota Digital (Mobile-Only)</small>
    </div>

    <div class="status">
      <span id="statusText">AKTIF</span>
    </div>

    <div class="identity">
      <h2 id="nama">Kang L</h2>
      <p id="nia">NIA : KOP-001</p>
    </div>

    <div class="stats">
      <div class="stat"><small>Simpanan Pokok</small><b id="pokok">Rp 0</b></div>
      <div class="stat"><small>Simpanan Wajib</small><b id="wajib">Rp 0</b></div>
      <div class="stat"><small>Simpanan Sukarela</small><b id="sukarela">Rp 0</b></div>
    </div>

    <div class="data">
      <div><span>Alamat</span><b id="alamat">-</b></div>
      <div><span>Jenis Kelamin</span><b id="jk">-</b></div>
      <div><span>Agama</span><b id="agama">-</b></div>
      <div><span>NIK</span><b id="nik">-</b></div>
      <div><span>Email</span><b id="email">-</b></div>
      <div><span>Telepon</span><b id="telepon">-</b></div>
      <div><span>Tanggal Daftar</span><b id="tglDaftar">-</b></div>
      <div><span>Total Simpanan</span><b id="totalSimpanan">Rp 0</b></div>
      <div><span>Total Pinjaman</span><b id="totalPinjaman">Rp 0</b></div>
      <div><span>Estimasi SHU</span><b id="shu">Rp 0</b></div>
    </div>

    <div class="actions">
      <button onclick="window.print()"><i class="fas fa-print"></i> Cetak</button>
      <button onclick="refreshData()"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    <div class="footer">
      Data tersinkronisasi dari Dashboard Admin<br>
      © Koperasi Asmara Tani <span id="currentYear">2024</span>
      <div class="last-update" id="lastUpdate">Terakhir update: -</div>
    </div>
  </div>
</div>

<script>
// =================== SHARED DATA SYSTEM ===================
// Storage Key untuk data koperasi
const STORAGE_KEY = 'koperasi_asmara_tani_data_v1';
let currentMemberId = null;
let refreshInterval = null;
let refreshTimer = 30;

// =================== DEFAULT DATA STRUCTURE ===================
const DEFAULT_DATA = {
  "last_updated": new Date().toISOString(),
  "version": "1.0",
  "anggota": {
    "KOP-00123": {
      "nama": "Kang L",
      "nia": "KOP-001",
      "status": "AKTIF",
      "alamat": "Pancasan-Ciasmara, Pamijahan",
      "jk": "Laki-laki",
      "agama": "Islam",
      "nik": "3201171212810011",
      "email": "siliwangi@gmail.com",
      "telepon": "085218483129",
      "tgl_daftar": "18-09-2020",
      "simpanan_pokok": 200000,
      "simpanan_wajib": 20000,
      "simpanan_sukarela": 0,
      "total_simpanan": 0,
      "total_pinjaman": 0,
      "shu": 20.000,
      "last_update": new Date().toLocaleString('id-ID'),
      "qr_url": "https://qr-code-hybrid.vercel.app/qr-code-hybrid.html?id=KOP-001"
    },
    "KOP-00124": {
      "nama": "",
      "nia": "",
      "status": "AKTIF",
      "simpanan_pokok": 0,
      "simpanan_wajib": 0,
      "simpanan_sukarela": 0,
      "total_simpanan": 0,
      "total_pinjaman": 0,
      "shu": 0,
      "last_update": new Date().toLocaleString('id-ID'),
      "qr_url": "https://qr-code-hybrid.vercel.app/qr-code-hybrid.html?id=KOP-002"
    }
  }
};

// =================== HELPER FUNCTIONS ===================
function formatRupiah(angka) {
  if (!angka && angka !== 0) return 'Rp 0';
  return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

function formatDate(dateString) {
  if (!dateString) return '-';
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return dateString; // Return as-is jika bukan date valid
    }
    return date.toLocaleDateString('id-ID', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  } catch {
    return dateString;
  }
}

function getParameterByName(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function showNotification(message, duration = 3000) {
  const notification = document.getElementById('updateNotification');
  const messageEl = document.getElementById('notificationMessage');
  
  messageEl.textContent = message;
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, duration);
}

function showError(message) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('errorMessage').textContent = message;
}

function showContent() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('errorState').style.display = 'none';
  document.getElementById('content').style.display = 'block';
  document.getElementById('refreshIndicator').style.display = 'flex';
}

// =================== DATA MANAGEMENT ===================
function initDataStorage() {
  if (!localStorage.getItem(STORAGE_KEY)) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_DATA));
    console.log('Data storage initialized');
  }
}

function getAllData() {
  const data = localStorage.getItem(STORAGE_KEY);
  return data ? JSON.parse(data) : DEFAULT_DATA;
}

function getAnggotaData(nia) {
  const allData = getAllData();
  return allData.anggota[nia] || null;
}

function updateAnggotaData(nia, newData) {
  const allData = getAllData();
  
  if (!allData.anggota[nia]) {
    // Jika anggota baru, buat entry baru
    allData.anggota[nia] = {};
  }
  
  // Update data
  allData.anggota[nia] = {
    ...allData.anggota[nia],
    ...newData,
    last_update: new Date().toLocaleString('id-ID')
  };
  
  allData.last_updated = new Date().toISOString();
  
  // Simpan ke localStorage
  localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
  
  // Trigger custom event untuk real-time update
  const event = new CustomEvent('anggotaDataUpdated', {
    detail: { nia: nia, timestamp: new Date().toISOString() }
  });
  window.dispatchEvent(event);
  
  return true;
}

// =================== UI UPDATE FUNCTIONS ===================
function updateDisplay(data) {
  if (!data) return;
  
  // Update basic info
  document.getElementById('nama').textContent = data.nama || '-';
  document.getElementById('nia').textContent = `NIA : ${data.nia || '-'}`;
  
  // Update status
  const statusElement = document.getElementById('statusText');
  statusElement.textContent = data.status || 'AKTIF';
  if (data.status && data.status.toUpperCase().includes('TIDAK')) {
    statusElement.className = 'status-inactive';
  } else {
    statusElement.className = '';
  }
  
  // Update simpanan
  document.getElementById('pokok').textContent = formatRupiah(data.simpanan_pokok || 0);
  document.getElementById('wajib').textContent = formatRupiah(data.simpanan_wajib || 0);
  document.getElementById('sukarela').textContent = formatRupiah(data.simpanan_sukarela || 0);
  
  // Update data pribadi
  document.getElementById('alamat').textContent = data.alamat || '-';
  document.getElementById('jk').textContent = data.jk || '-';
  document.getElementById('agama').textContent = data.agama || '-';
  document.getElementById('nik').textContent = data.nik || '-';
  document.getElementById('email').textContent = data.email || '-';
  document.getElementById('telepon').textContent = data.telepon || '-';
  document.getElementById('tglDaftar').textContent = formatDate(data.tgl_daftar);
  
  // Update keuangan
  document.getElementById('totalSimpanan').textContent = formatRupiah(data.total_simpanan || 0);
  document.getElementById('totalPinjaman').textContent = formatRupiah(data.total_pinjaman || 0);
  document.getElementById('shu').textContent = formatRupiah(data.shu || 0);
  
  // Update timestamp
  document.getElementById('lastUpdate').textContent = 
    `Terakhir update: ${data.last_update || new Date().toLocaleString('id-ID')}`;
}

// =================== MAIN DATA LOADING ===================
function loadMemberData() {
  try {
    // 1. Ambil ID dari URL parameter
    currentMemberId = getParameterByName('id');
    
    // Jika tidak ada parameter, tampilkan error
    if (!currentMemberId) {
      showError('ID Anggota tidak ditemukan di URL.<br>Format URL harus: qr-code-hybrid.html?id=KOP-00123');
      return;
    }
    
    // 2. Inisialisasi data storage jika belum ada
    initDataStorage();
    
    // 3. Ambil data anggota TERBARU dari storage
    const anggotaData = getAnggotaData(currentMemberId);
    
    if (!anggotaData) {
      showError(`Anggota dengan NIA <strong>${currentMemberId}</strong> tidak ditemukan dalam database.`);
      return;
    }
    
    // 4. Update tampilan dengan data terbaru
    updateDisplay(anggotaData);
    
    // 5. Tampilkan konten
    showContent();
    
    // 6. Tampilkan notifikasi pertama kali
    showNotification(`Data ${anggotaData.nama} dimuat`, 2000);
    
  } catch (error) {
    console.error('Error loading data:', error);
    showError('Terjadi kesalahan saat memuat data. Silakan coba lagi.');
  }
}

// =================== AUTO REFRESH SYSTEM ===================
function startAutoRefresh() {
  // Update timer setiap detik
  const timerElement = document.getElementById('refreshTimer');
  
  refreshInterval = setInterval(() => {
    refreshTimer--;
    timerElement.textContent = refreshTimer;
    
    if (refreshTimer <= 0) {
      refreshTimer = 30; // Reset ke 30 detik
      
      // Load data terbaru
      loadMemberData();
      showNotification('Data diperbarui otomatis', 1500);
    }
  }, 1000);
}

function stopAutoRefresh() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
    refreshInterval = null;
  }
}

// =================== REAL-TIME UPDATE LISTENER ===================
function setupRealtimeListener() {
  // Listen for data updates dari dashboard admin
  window.addEventListener('anggotaDataUpdated', (event) => {
    const updatedNia = event.detail.nia;
    
    // Jika data yang diupdate adalah anggota yang sedang dilihat
    if (updatedNia === currentMemberId) {
      console.log('Data diperbarui dari dashboard!');
      
      // Tampilkan notifikasi
      showNotification('Data diperbarui dari Dashboard Admin!', 3000);
      
      // Reset timer refresh
      refreshTimer = 30;
      
      // Load data terbaru setelah 1 detik
      setTimeout(() => {
        loadMemberData();
      }, 1000);
    }
  });
  
  // Listen for storage changes (untuk multi-tab)
  window.addEventListener('storage', (event) => {
    if (event.key === STORAGE_KEY) {
      console.log('Storage updated from another tab');
      
      // Reset timer
      refreshTimer = 30;
      
      // Load data terbaru
      loadMemberData();
      showNotification('Data diperbarui dari tab lain', 2000);
    }
  });
}

// =================== PUBLIC FUNCTIONS ===================
function refreshData() {
  refreshTimer = 30;
  document.getElementById('refreshTimer').textContent = '30';
  loadMemberData();
  showNotification('Mengambil data terbaru...', 1500);
}

// =================== INITIALIZATION ===================
document.addEventListener('DOMContentLoaded', function() {
  // Set current year in footer
  document.getElementById('currentYear').textContent = new Date().getFullYear();
  
  // Load data pertama kali
  loadMemberData();
  
  // Setup real-time listener
  setupRealtimeListener();
  
  // Start auto-refresh
  startAutoRefresh();
  
  // Cleanup saat halaman ditutup
  window.addEventListener('beforeunload', stopAutoRefresh);
});

// =================== GLOBAL FUNCTIONS UNTUK DASHBOARD ===================
// Fungsi ini akan dipanggil dari dashboard-admin.html
window.updateAnggotaFromDashboard = function(nia, newData) {
  const success = updateAnggotaData(nia, newData);
  
  if (success && nia === currentMemberId) {
    showNotification('Data diperbarui dari Dashboard!', 3000);
    setTimeout(() => {
      loadMemberData();
    }, 500);
  }
  
  return success;
};

// Fungsi untuk menambahkan anggota baru dari dashboard
window.tambahAnggotaBaru = function(nia, data) {
  // Generate QR URL otomatis
  const qrUrl = `https://qr-code-hybrid.vercel.app/qr-code-hybrid.html?id=${nia}`;
  
  const success = updateAnggotaData(nia, {
    ...data,
    nia: nia,
    qr_url: qrUrl,
    last_update: new Date().toLocaleString('id-ID')
  });
  
  return success;
};

// Debug function untuk testing
window.debugUpdateData = function() {
  const testData = {
    nama: "Ahmad Sudrajat (Updated)",
    simpanan_sukarela: 999999,
    total_simpanan: 1500000,
    shu: 300000,
    status: "AKTIF (PREMIUM)"
  };
  
  window.updateAnggotaFromDashboard("KOP-00123", testData);
};
</script>

</body>
</html>
